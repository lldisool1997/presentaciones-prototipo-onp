<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Instrucciones Pagos Diversos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./css/instrucciones.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/autonumeric@4.10.5"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="bg-slate-100 text-slate-800 font-inter">
  <div id="app" class="max-w-6xl mx-auto p-4 md:p-6 space-y-4">

    <div class="bg-sky-900 text-white rounded-xl px-5 py-3 text-center text-lg font-semibold">
      Instrucciones Pagos Diversos
    </div>

    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4 space-y-3">
      <div class="flex flex-col md:flex-row gap-3 md:items-end">
        <div class="w-full md:w-96">
          <label class="block text-xs text-slate-500 mb-1">Tipo de transacción</label>
          <select v-model="ui.selectedType" class="tw-input w-full">
            <option value="" disabled>— Selecciona —</option>
            <option v-for="t in master.types" :key="t" :value="t">{{ t }}</option>
          </select>
        </div>
        <button class="tw-btn" @click="addType">Agregar tipo de transacción +</button>
        <div class="md:ml-auto flex items-center gap-2">
          <span class="tw-pill">Instr. aprobadas: {{ approvedInstrCount }} / {{ totalInstrCount }}</span>
          <button class="tw-btn-primary" @click="guardarTodo">Guardar instrucciones</button>
        </div>
      </div>
      <div v-if="state.typesAdded?.length" class="flex flex-wrap gap-2 pt-2">
        <span v-for="(t, idx) in state.typesAdded" :key="t" class="tw-chip">
          {{ t }}
          <button class="tw-chip-x" @click="confirmDeleteType(idx, t)">×</button>
        </span>
      </div>
    </div>

    <!-- Tabs de Tipo de Transferencia -->
    <div class="bg-white rounded-xl shadow-sm border border-slate-200">
      <div class="px-4 py-2 border-b border-slate-200 font-semibold">
        Tipos de Transacción
      </div>
      <div class="flex flex-wrap gap-2 px-4 pt-3 border-b border-slate-200">
        <button v-for="(type, idx) in state.typesAdded" :key="idx" class="tw-tab" :class="idx === ui.activeTab ? 'tw-tab-active' : ''" @click="ui.activeTab = idx">
          {{ type }}
        </button>
      </div>

      <!-- Paneles de Instrucciones para cada Tipo de Transferencia -->
      <div v-for="(type, idx) in state.typesAdded" :key="idx" v-show="idx === ui.activeTab">
        <div class="mx-2 my-4">
            <div class="px-4 py-3  rounded-lg bg-[#f8f9fa] border-b border-slate-200 font-semibold border-l-2 border-l-blue-300">Instrucciones para {{ type }}</div>
        </div>

        <!-- Tabs de Instrucción dentro del tipo de transacción -->
        <div class="bg-white rounded-xl shadow-sm border border-slate-200">
          <div class="px-4 py-2 border-b border-slate-200 flex items-center gap-3">
            <span class="font-semibold">Instrucciones</span>
            <button class="tw-btn" @click="addInstruction(type)">Agregar Instrucción</button>
          </div>
          <div class="flex flex-wrap gap-2 px-4 pt-3 border-b border-slate-200">
            <button v-for="(ins, i) in state.instructionsByType[type]" :key="ins.id" 
            class="tw-tab" :class="i === ui.activeInstructionTab ? 'tw-tab-active' : ''" @click="ui.activeInstructionTab = i">
              Instrucción #{{ i + 1 }}
            </button>
          </div>
          <!-- Acciones de la instrucción -->

          <!-- Contenido de la Instrucción seleccionada -->
          <div v-if="curr" class="p-4 space-y-4">
                   <div class="flex items-center justify-end gap-4 text-sm text-slate-600 mt-2">
  <label class="inline-flex items-center gap-2 cursor-pointer">
    <input type="checkbox" v-model="curr.aprobado" class="accent-sky-600" />
    <span class="font-medium">Aprobar instrucción</span>
  </label>

  <button
    class="tw-btn-danger"
    @click="confirmDeleteInstruction(ui.activeInstructionTab)"
    title="Eliminar esta instrucción"
  >
    Eliminar instrucción
  </button>
</div>

            <!-- Descripción y Producto como Textareas -->
            <div class="grid md:grid-cols-2 gap-3">
              <div>
                <label class="tw-label">Descripción</label>
                <textarea class="tw-input w-full" v-model="curr.descripcion" placeholder="Descripción de la instrucción"></textarea>
              </div>
              <div>
                <label class="tw-label">Producto</label>
                <textarea class="tw-input w-full" v-model="curr.producto" placeholder="p.ej. Con el producto X"></textarea>
              </div>
            </div>

            <!-- Información adicional -->
            <div class="grid md:grid-cols-4 gap-3">
              <div>
    <label class="tw-label">Unidad de Negocio</label>
    <select class="tw-input w-full" v-model="curr.unidad" @change="onUnidadCabeceraChange">
      <option value="" disabled>— Selecciona —</option>
      <option v-for="u in master.unidades" :key="u" :value="u">{{ u }}</option>
    </select>
  </div>

  
             <div>
            <label class="tw-label">Moneda</label>
            <select class="tw-input w-full" v-model="curr.moneda" @change="onMonedaChange">
              <option v-for="m in master.monedas" :key="m">{{ m }}</option>
            </select>
          </div>

  <!-- Cuenta (dependiente de Unidad) -->
  <div>
    <label class="tw-label">Cuenta</label>
    <select class="tw-input w-full"
            v-model="curr.cuentaCabeceraId"
            :disabled="!curr.unidad">
      <option value="" disabled>— Selecciona —</option>
      <option v-for="c in cuentasCabecera" :key="c.id" :value="c.id">
        {{ c.alias }} — {{ c.numero }}
      </option>
    </select>
    <p v-if="!curr.unidad" class="text-xs text-slate-500 mt-1">Primero elige la unidad.</p>
  </div>
              <div>
                <label class="tw-label">Fecha de Operación</label>
                <input type="date" class="tw-input w-full" v-model="curr.fecha">
              </div>
              <div>
                <label class="tw-label">Importe</label>
                <input class="tw-input w-full" v-model="curr.importe" v-money placeholder="1,000.00">
              </div>
            </div>

<!-- Tabla de detalles -->
<div class="my-4">
  <div class="flex items-center gap-2">
    <button class="tw-btn"
        @click="agregarFila()"
        :disabled="isSingleRowType && curr?.detalle?.length >= 1"
        :title="isSingleRowType ? 'Este tipo solo permite una fila' : ''">
  + Agregar fila
</button>

    <span v-if="lockedLayout" class="tw-pill">
      Modo: {{ lockedLayout === 'persona' ? 'Persona' : 'Unidad de negocio' }}
    </span>
    <button v-if="lockedLayout" class="tw-btn-outline" @click="resetLayout()">
      Cambiar modo
    </button>
  </div>

  <div class="overflow-x-auto mt-2">
    <table class="w-full text-sm align-top">
      <thead class="text-xs text-slate-500">
        <tr>
          <th class="p-2 text-left">Persona</th>
          <th class="p-2 text-left">Unidad de negocio</th>
          <th class="p-2 text-left">Cuenta</th>
          <th class="p-2 text-right">Monto</th>
          <th class="p-2 text-center">Aprob.</th>
          <th class="p-2"></th>
        </tr>
      </thead>

      <tbody>
        <tr v-for="(r, ri) in curr.detalle" :key="r.uid" class="bg-slate-50 border-y">
          <!-- Persona -->
          <td class="p-2 min-w-[14rem]">
            <select class="tw-input w-full"
                    v-model="r.personaId"
                    :disabled="lockedLayout === 'unidad'"
                    @change="onChangePersona(r)">
              <option value="">— Selecciona persona —</option>
              <option v-for="p in personasFiltradas" :key="p.id" :value="p.id">
                {{ p.nombre }}
              </option>
            </select>
          </td>

          <!-- Unidad -->
          <td class="p-2 min-w-[14rem]">
            <select class="tw-input w-full"
                    v-model="r.unidadNegocio"
                    :disabled="lockedLayout === 'persona'"
                    @change="onChangeUnidad(r)">
              <option value="">— Selecciona unidad —</option>
              <option v-for="u in master.unidades" :key="u" :value="u">{{ u }}</option>
            </select>
          </td>

          <!-- Cuenta (dependiente de persona o unidad) -->
          <td class="p-2 min-w-[16rem]">
            <select class="tw-input w-full"
                    v-model="r.cuentaId"
                    :disabled="lockedLayout === 'persona'">
              <option value="">— Selecciona cuenta —</option>
              <option v-for="c in cuentasPara(r)" :key="c.id" :value="c.id">
                {{ c.alias }} — {{ c.numero }}
              </option>
            </select>
          </td>

          <!-- Monto -->
          <td class="p-2 min-w-[8rem]">
            <input class="tw-input w-full text-right"
                   v-model="r.monto" v-money
                   placeholder="0.00" />
          </td>

          <!-- Aprob -->
          <td class="p-2 text-center">
            <input type="checkbox" v-model="r.aprob" class="accent-sky-600">
          </td>

          <!-- Acciones -->
         <td class="p-2">
  <div class="flex gap-2 justify-end" v-if="!isSingleRowType">
    <button class="tw-btn" @click="duplicarFila(ri)">Duplicar</button>
    <button class="tw-btn-danger" @click="eliminarFila(ri)">Eliminar</button>
  </div>
  <!--<div class="text-xs text-slate-500 text-right" v-else>
    Fila obligatoria
  </div>-->
</td>
        </tr>
      </tbody>

      <tfoot class="text-sm font-semibold">
        <tr>
          <td class="p-2" colspan="3">
            Total filas: {{ totalFilas }}
          </td>
          <td class="p-2 text-right min-w-[8rem]">{{ totalMontoFormateado }}</td>
          <td></td>
          <td></td>
        </tr>
      </tfoot>
    </table>
  </div>
</div>



            
            <!-- Sustento Documentario -->
            <!-- 2. Sustento documentario -->
<section>
    <div class="mx-2 my-4">
      <div class="px-4 py-3  rounded-lg bg-[#f8f9fa] border-b border-slate-200 font-semibold border-l-2 border-l-blue-300">Sustento documentario</div>
  </div>

  <div class="docsec-body">
    <!-- Tarjetas iniciales (fijas) -->
    <div class="doc-grid">
      <div class="doc-card" v-for="d in initialDocs" :key="d.key">
        <div class="doc-card-title">{{ d.label }}</div>

        <label class="uploader-dropzone">
          <input type="file"
                 accept="application/pdf"
                 class="uploader-input"
                 @change="onFileInicial($event, d)" />
          <div class="uploader-inner">
            <div class="uploader-icon">📄</div>
            <div class="uploader-text">
              <div class="uploader-action">Seleccionar archivo</div>
              <div class="uploader-sub">PDF</div>
              <div class="uploader-file" v-if="d.fileName">{{ d.fileName }}</div>
            </div>
          </div>
        </label>
      </div>
    </div>

    <!-- Configuración avanzada -->
    <div class="adv card-soft">
      <div class="adv-head">
        <span class="adv-icon">🛠️</span>
        <span class="adv-title">Configuración avanzada</span>
      </div>

      <div class="adv-row">
        <div class="adv-help">
          Agregue documentos adicionales para el área seleccionada:
        </div>
        <div class="adv-form">
          <input class="tw-input w-1/3"
                 placeholder="Nombre del nuevo documento"
                 v-model="ui.newDocName" />
          <button class="tw-btn-success"
                  @click="addDynamicDoc">+ Agregar Documento</button>
        </div>
      </div>

      <!-- Dinámicos -->
      <div class="doc-grid mt-3" v-if="extraDocs.length">
        <div class="doc-card" v-for="(d, di) in extraDocs" :key="d.id">
          <div class="doc-card-title">
            {{ d.label }}
            <button class="doc-remove"
                    @click="confirmDeleteDynamicDoc(di)"
                    title="Quitar documento">×</button>
          </div>

          <label class="uploader-dropzone">
            <input type="file"
                   accept="application/pdf"
                   class="uploader-input"
                   @change="onFileExtra($event, d)" />
            <div class="uploader-inner">
              <div class="uploader-icon">📄</div>
              <div class="uploader-text">
                <div class="uploader-action">Seleccionar archivo</div>
                <div class="uploader-sub">PDF</div>
                <div class="uploader-file" v-if="d.fileName">{{ d.fileName }}</div>
              </div>
            </div>
          </label>
        </div>
      </div>
    </div>
  </div>
</section>

          </div>
        </div>
      </div>

    </div>
  </div>

  <script src="./js/instrucciones.js"></script>
</body>
</html>
