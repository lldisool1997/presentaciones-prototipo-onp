<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Lista de Inversiones ¬∑ Llamados (con colapsable)</title>

  <!-- jQuery + Toastr -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    *{box-sizing:border-box}
    body{font-family:Segoe UI,system-ui,-apple-system,sans-serif;background:#f5f5f5;color:#2c3e50;margin:0}
    .container{max-width:1600px;margin:0 auto;padding:20px}
    .main-container{background:#fff;border-radius:15px;box-shadow:0 8px 32px rgba(0,0,0,.1);overflow:hidden;margin-bottom:20px;position:relative}
    .profile-info{position:absolute;top:15px;right:25px;background:rgba(255,255,255,.15);color:white;padding:8px 15px;border-radius:20px;font-size:.85em;font-weight:500;z-index:10;border:1px solid rgba(255,255,255,.2)}
    .header{background:linear-gradient(135deg,#005C97 0%, #004a7c 100%);color:white;padding:30px;text-align:center}
    .header h1{font-size:2rem;font-weight:600;margin:0 0 .5rem}
    .content-wrapper{padding:30px}
    .section-header{color:#2c3e50;font-size:1.3em;font-weight:600;margin:20px 0;padding-left:15px;border-left:4px solid #1976d2;border-bottom:2px solid #3498db}

    .filters-section{background:#f8f9fa;padding:25px;border-radius:12px;margin-bottom:30px;box-shadow:0 2px 10px rgba(0,0,0,.05)}
    .filters-row{display:flex;align-items:center;gap:20px;flex-wrap:wrap}
    .form-group{display:flex;flex-direction:column;gap:8px}
    label{font-weight:600;color:#2c3e50;font-size:.9em}
    select,input{padding:12px 15px;border:2px solid #e0e0e0;border-radius:8px;font-size:1em;background:white;transition:border-color .3s}
    select:focus,input:focus{outline:none;border-color:#3498db}

    .btn{padding:12px 25px;border:none;border-radius:8px;font-size:1em;font-weight:600;cursor:pointer;transition:.2s;text-transform:uppercase;letter-spacing:.5px}
    .btn-primary{background:linear-gradient(135deg,#3498db 0%, #2980b9 100%);color:white}
    .btn-primary:hover{background:linear-gradient(135deg,#2980b9 0%, #1f5f8b 100%);transform:translateY(-2px);box-shadow:0 5px 15px rgba(52,152,219,.3)}
    .btn-action{padding:6px 12px;font-size:1em;border-radius:5px;text-transform:none;letter-spacing:normal}
    .btn-llamado-registro{background:#2766ae;color:#fff}
    .btn-aprobar{background:#37ae27;color:#fff}
    .btn-instruir{background:#0f766e;color:#fff}
    .btn-cancelar{background:#b91c1c;color:#fff}

    .table-container{background:white;border-radius:12px;overflow-x:auto;box-shadow:0 2px 10px rgba(0,0,0,.05);margin-bottom:20px;width:100%}
    table{width:100%;min-width:1500px;border-collapse:collapse}
    th{background:linear-gradient(135deg,#34495e 0%, #2c3e50 100%);color:white;padding:15px 8px;text-align:center;font-weight:600;font-size:.8em;white-space:nowrap}
    td{padding:12px 8px;text-align:center;border-bottom:1px solid #eee;font-size:.8em;white-space:nowrap}
    .text-left{text-align:left!important}
    .text-right{text-align:right!important}
    tr:nth-child(even){background:#f8f9fa}
    tr:hover{background:#eaf4ff}
    tr.selected{background:#cce5ff!important;border-left:4px solid #1976d2}
    tr.selected td{font-weight:600}

    .status-badge{padding:5px 12px;border-radius:20px;font-size:1.1em;font-weight:700;text-transform:uppercase}
    .status-cancelada{background:#f8d7da;color:#721c24}
    .status-aprobado{background:#d7ebf8;color:#1f1c72}
    .status-registrado{background:#d7ebf8;color:#30721c}

    /* Colapsable */
    .toggle{cursor:pointer;user-select:none;display:inline-flex;align-items:center;gap:6px;justify-content:center}
    .toggle .sign{display:inline-block;width:20px;height:20px;line-height:20px;border-radius:6px;background:#eef2f7;color:#334155;font-weight:900}
    .child-row td{background:#fbfdff}
    .child-wrap{overflow:hidden;display:none} /* jQuery slideToggle animar√° esta capa */

    /* Toastr limpio */
    #toast-container>.toast{border-radius:12px;padding:10px 14px;border:1px solid #e5e7eb;background:#fff;box-shadow:0 12px 28px rgba(0,0,0,.12);color:#0f172a}
    #toast-container>.toast-success{border-left:6px solid #16a34a;background-image:none}
    #toast-container>.toast-error{border-left:6px solid #dc2626;background-image:none}
    #toast-container>.toast-info{border-left:6px solid #2563eb;background-image:none}
    #toast-container>.toast-warning{border-left:6px solid #f59e0b;background-image:none}
    #toast-container.toast-top-right{top:18px;right:18px}

    @media (max-width: 1200px){
      .filters-row{flex-direction:column;align-items:stretch}
    }
    @media (max-width: 768px){
      table{font-size:.7em}
      .actions-cell{flex-direction:column;gap:5px}
      .profile-info{position:static;margin-bottom:10px;text-align:center}
    }

    /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            max-width: 1200px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-header {
            background: linear-gradient(135deg, #005C97 0%, #004a7c 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-close {
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            border-radius: 3px;
        }

        .modal-content {
            padding: 30px;
        }

        .modal-section {
            margin-bottom: 30px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .info-field {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .info-label {
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.9em;
        }

        .info-value {
            padding: 10px;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            color: #495057;
        }

        /* Tabs */
        .tabs-container {
            margin-top: 20px;
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid #e9ecef;
            margin-bottom: 20px;
        }

        .tab {
            padding: 12px 24px;
            border: none;
            background: none;
            cursor: pointer;
            font-weight: 600;
            color: #6c757d;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .tab.active {
            color: #005C97;
            border-bottom-color: #005C97;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        .document-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .modal-footer {
            padding: 20px 30px;
            border-top: 1px solid #e9ecef;
            text-align: center;
        }

        .btn-aprobar {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-aprobar:hover {
            background: linear-gradient(135deg, #218838 0%, #1e7e34 100%);
            transform: translateY(-2px);
        }

        .btn-cerrar {
            background: #6c757d;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-cerrar:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }


        .status-generado {
            background: #e1d5f7;
            color: #6f42c1;
        }
  </style>
</head>
<body>
  <!-- Badge √°rea en esquina -->
<div id="area-badge"
     style="position: absolute; top: 15px; right: 20px;
            background-color: #1e6ba8; color: #fff;
            font-weight: bold; font-size: 0.9rem;
            padding: 6px 14px; border-radius: 20px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);">
  √Årea: -
</div>
  <div class="container">
    <div class="main-container">
      <div class="header">
        <h1>Lista de Inversiones</h1>
        <div>Sin cuponera: llamados / distribuciones / rebates (estados: Registrado, Instruido, Cancelado)</div>
      </div>

      <div class="content-wrapper">
        <!-- === Filtros (NO tocados) === -->
        <div class="filters-section" style="background-color:#f8f9fa;">
          <div class="filters-row" style="margin-bottom:20px;">
            <div class="form-group">
              <label for="entidad">Entidad:</label>
              <select id="entidad">
                <option value="">Todas las entidades</option>
                <option value="fdo-consolidado" selected>Fondo Consolidado de Reservas Previsionales ‚Äì FCR</option>
                <option value="fcr-macrofondo">FCR-MACROFONDO</option>
              </select>
            </div>
            <div class="form-group">
              <label for="unidadNegocio">Unidad de Negocio:</label>
              <select id="unidadNegocio">
                <option value="">Todas las unidades</option>
                <option value="fcr-macrofondo" selected>FCR-MACROFONDO</option>
                <option value="bonos-corporativos">BONOS CORPORATIVOS</option>
              </select>
            </div>
            <div class="form-group">
              <label for="tipoInstrumento">Tipo Instrumento:</label>
              <select id="tipoInstrumento">
                <option value="">Todos los tipos</option>
                <option value="bonos-corporativos" selected>BONOS CORPORATIVOS</option>
                <option value="depositos-plazo">Dep√≥sitos a Plazo</option>
              </select>
            </div>
            <div class="form-group">
              <label for="inversionNum">Inversi√≥n #:</label>
              <input type="text" id="inversionNum" placeholder="N√∫mero de inversi√≥n">
            </div>
          </div>

          <div class="filters-row" style="margin-bottom:20px;">
            <div class="form-group">
              <label for="numeroDeposito"># Dep√≥sito:</label>
              <input type="text" id="numeroDeposito" placeholder="N√∫mero de dep√≥sito">
            </div>

            <div class="form-group">
              <label for="estadoFiltro">Estado del hijo:</label>
              <select id="estadoFiltro">
                <option value="">Todos</option>
                <option value="REGISTRADO">Registrado</option>
                <option value="NOTIFICADO A BACK OFFICE">Notificado a Back Office</option>
                <option value="CANCELADO">Cancelado</option>
              </select>
            </div>

            <div class="form-group">
              <label>Fechas:</label>
              <div style="display:flex;gap:10px;align-items:center;">
                <label style="display:flex;align-items:center;gap:5px;font-weight:normal;">
                  <input type="checkbox" id="checkFechaCompra"> F. Compra
                </label>
                <label style="display:flex;align-items:center;gap:5px;font-weight:normal;">
                  <input type="checkbox" id="checkFechaEmision"> F. Emisi√≥n
                </label>
                <label style="display:flex;align-items:center;gap:5px;font-weight:normal;">
                  <input type="checkbox" id="checkFechaVencim"> F. Vencim.
                </label>
              </div>
            </div>
          </div>

          <div class="filters-row">
            <!--<button class="btn btn-primary" id="btnBuscar">Buscar</button>-->
            <button class="btn" id="btnLimpiar" style="background:#eef5fb">Limpiar</button>
          </div>
        </div>

        <div class="section-header">Inversiones Registradas</div>

        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Ver</th>
                <th>Estado</th>
                <th>Inversi√≥n #</th>
                <th>Inv. Principal</th>
                <th class="text-left">Producto</th>
                <th class="text-left">N√∫mero Dep√≥sito</th>
                <th>Fecha Compra</th>
                <th>Fecha Emisi√≥n</th>
                <th>Fecha Vencim.</th>
                <th>Carta Apertura</th>
                <th>Carta Cancelaci√≥n</th>
                <th>Moneda</th>
                <th>Valor Nominal</th>
                <th>Compra Spot Cup√≥n</th>
                <th>P.Compra/Cup√≥n%</th>
                <th>Eco Instrumento</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="inversionesBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

      <!-- Modal de Aprobaci√≥n -->
    <div id="modalAprobacion" class="modal-overlay" style="display: none;">
        <div class="modal-container">
            <div class="modal-header">
                <h2>Aprobaci√≥n de Inversi√≥n</h2>
                <span class="modal-close" onclick="cerrarModal()">&times;</span>
            </div>
            <div class="modal-content">
                <div class="modal-section">
                    <div class="section-header">1. Informaci√≥n general de la inversi√≥n</div>
                    <div id="infoGeneral" class="info-grid">
                    </div>
                </div>

                <div class="modal-section">
                    <div class="section-header">2. Sustento documentario</div>
                    <div class="tabs-container">
                        <div class="tabs">
                            <button class="tab active" onclick="cambiarTab('general')">General</button>
                            <button class="tab" onclick="cambiarTab('tesoreria')">Tesorer√≠a</button>
                        </div>
                        <div class="tab-content">
                            <div id="tab-general" class="tab-pane active">
                            </div>
                            <div id="tab-tesoreria" class="tab-pane">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-section">
                    <div class="section-header">3. Justificaci√≥n de aprobaci√≥n</div>
                    <div id="seccionJustificacion">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-aprobar" onclick="aprobarInversion()">APROBAR</button>
                <button class="btn btn-cerrar" onclick="cerrarModal()"
                    style="background: #6c757d; color: white; margin-left: 10px;">CERRAR</button>
            </div>
        </div>
    </div>

<script>
  // =============== TOASTR CONFIG ===============
  toastr.options = {
    closeButton:true,newestOnTop:true,progressBar:true,
    positionClass:"toast-top-right",timeOut:2600,extendedTimeOut:1200,
    showDuration:160,hideDuration:160,showMethod:"fadeIn",hideMethod:"fadeOut"
  };

  // =============== DATA MOCK ===============
  // Hijos usan estados: REGISTRADO, NOTIFICADO A BACK OFFICE, CANCELADO
  const inversiones = [
        {
      entidad:"fdo-consolidado",
      unidad:"fcr-macrofondo",
      tipo:"bonos-corporativos",
      estado:"REGISTRADO",
      inversionNum:"6123",
      invPrincipal:"6123",
      producto:"Fondos Alternativos ‚Äì Secondaries",
      numeroDeposito:"ALPINV-SEC-22",
      fechaCompra:"24/01/2015",
      fechaEmision:"24/01/2015",
      fechaVencimiento:"24/07/2026",
      cataApertura:"24/07/2026",
      cataCancelacion:"Local",
      moneda:"USD",
      valorNominal:"24,500,000.00",
      compraSpotCupon:"",
      pCompraCupon:"100.00",
      ecoInstrument:"ALTERNATIVOS",
    },
    {
      entidad:"fdo-consolidado",
      unidad:"fcr-macrofondo",
      tipo:"bonos-corporativos",
      estado:"APROBADO",
      inversionNum:"6122",
      invPrincipal:"6122",
      producto:"Fondos Alternativos ‚Äì Secondaries",
      numeroDeposito:"ALPINV-SEC-22",
      fechaCompra:"24/01/2015",
      fechaEmision:"24/01/2015",
      fechaVencimiento:"24/07/2026",
      cataApertura:"24/07/2026",
      cataCancelacion:"Local",
      moneda:"USD",
      valorNominal:"24,500,000.00",
      compraSpotCupon:"",
      pCompraCupon:"100.00",
      ecoInstrument:"ALTERNATIVOS",
      hijos:[
        { id:"C-1001", tipo:"Llamado",        fecha:"2024-08-10", monto:"1,250,000.00", documento:"call_1001.pdf", estado:"REGISTRADO" },
        { id:"C-1001", tipo:"Llamado",        fecha:"2024-08-10", monto:"1,250,000.00", documento:"call_1001.pdf", estado:"NOTIFICADO A BACK OFFICE" },
        //{ id:"C-1002", tipo:"Distribuci√≥n",   fecha:"2024-12-05", monto:"-250,000.00",  documento:"dist_1002.pdf", estado:"INSTRUIDO" }
      ]
    },
    {
      entidad:"fdo-consolidado",
      unidad:"fcr-macrofondo",
      tipo:"bonos-corporativos",
      estado:"APROBADO",
      inversionNum:"6121",
      invPrincipal:"6121",
      producto:"Fondo Mutuo Renta Variable Global",
      numeroDeposito:"FM-RV-GLB-01",
      fechaCompra:"03/02/2016",
      fechaEmision:"03/02/2016",
      fechaVencimiento:"‚Äî",
      cataApertura:"‚Äî",
      cataCancelacion:"‚Äî",
      moneda:"USD",
      valorNominal:"10,000,000.00",
      compraSpotCupon:"",
      pCompraCupon:"‚Äî",
      ecoInstrument:"FONDOS MUTUOS",
      hijos:[
        //{ id:"C-2001", tipo:"Rebate",         fecha:"2025-01-31", monto:"-15,400.00",   documento:"reb_2001.pdf",  estado:"REGISTRADO" },
        //{ id:"C-2002", tipo:"Rescate",        fecha:"2025-06-12", monto:"-500,000.00",  documento:"res_2002.pdf",  estado:"CANCELADO" }
      ]
    },
    {
      entidad:"fcr-macrofondo",
      unidad:"bonos-corporativos",
      tipo:"depositos-plazo",
      estado:"APROBADO",
      inversionNum:"6120",
      invPrincipal:"6120",
      producto:"ETF S&P 500",
      numeroDeposito:"ETF-SPX-ACC",
      fechaCompra:"10/05/2017",
      fechaEmision:"‚Äî",
      fechaVencimiento:"‚Äî",
      cataApertura:"‚Äî",
      cataCancelacion:"‚Äî",
      moneda:"USD",
      valorNominal:"8,300,000.00",
      compraSpotCupon:"",
      pCompraCupon:"‚Äî",
      ecoInstrument:"ETF",
      hijos:[
        //{ id:"C-3001", tipo:"Rescate",        fecha:"2025-07-02", monto:"-300,000.00",  documento:"res_3001.pdf",  estado:"INSTRUIDO" }
      ]
    }
  ];

  // =============== RENDER ===============
  function estadoBadge(st){
    if(st==="APROBADO") return 'status-aprobado';
    if(st==="CANCELADA") return 'status-cancelada';
    if(st==="REGISTRADO") return 'status-registrado';
    return '';
  }
  function badgeHijo(st){
    if(st==="REGISTRADO") return '<span class="status-badge" style="background:#e0e7ff;color:#3730a3">REGISTRADO</span>';
    if(st==="NOTIFICADO A BACK OFFICE")  return '<span class="status-badge" style="background:#d1fae5;color:#065f46">NOTIFICADO A BACK OFFICE</span>';
    return '<span class="status-badge" style="background:#fee2e2;color:#991b1b">CANCELADO</span>';
  }

  function renderTabla(list){
    const $tb = $("#inversionesBody").empty();
    list.forEach((inv, idx)=>{
      const rowKey = `r${idx}`;

      // fila padre
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>
           ${
                                inv.estado !== "REGISTRADO"
                                ? ` <span class="toggle" data-target="${rowKey}">
            <span class="sign" id="sign-${rowKey}">+</span>
          </span>`
                                : ""
                            }
         
        </td>
        <td><span class="status-badge ${estadoBadge(inv.estado)}">${inv.estado}</span></td>
        <td>${inv.inversionNum}</td>
        <td>${inv.invPrincipal}</td>
        <td class="text-left">${inv.producto}</td>
        <td class="text-left">${inv.numeroDeposito}</td>
        <td>${inv.fechaCompra}</td>
        <td>${inv.fechaEmision}</td>
        <td>${inv.fechaVencimiento}</td>
        <td>${inv.cataApertura}</td>
        <td>${inv.cataCancelacion}</td>
        <td class="text-right">${inv.moneda}</td>
        <td class="text-left">${inv.valorNominal}</td>
        <td>${inv.compraSpotCupon}</td>
        <td>${inv.pCompraCupon}</td>
        <td>${inv.ecoInstrument}</td>
        <td>
          ${
                                inv.estado !== "REGISTRADO"
                                ? 
                                `  <div class="actions-cell" style="display:flex;gap:8px;justify-content:center;align-items:center">
            <button class="btn btn-action btn-llamado-registro" onclick="irARegistroLlamado('${inv.invPrincipal}')">
              REALIZAR LLAMADO
            </button>
          </div>`
                                :
                                
                                 `  <div class="actions-cell" style="display:flex;gap:8px;justify-content:center;align-items:center">
            <button class="btn btn-action btn-aprobar" onclick='abrirModalAprobacion(${JSON.stringify(inv)})'>
              APROBAR
            </button>
          </div>`
                            }
        </td>
      `;
      $tb.append(tr);

      // fila hijo (colspan con tabla interior) animada
      const trChild = document.createElement("tr");
      trChild.className = "child-row";
      trChild.innerHTML = `
        <td colspan="17" style="padding:0;border-bottom:none">
          <div class="child-wrap" id="wrap-${rowKey}">
            <div style="padding:12px 16px 16px">
              <table style="width:100%;min-width:1100px;border-collapse:collapse">
                <thead>
                  <tr>
                    <th style="background:#eef2f7;color:#334155;padding:8px;border-radius:6px 0 0 6px">ID</th>
                    <th style="background:#eef2f7;color:#334155;padding:8px">Tipo</th>
                    <th style="background:#eef2f7;color:#334155;padding:8px">Fecha</th>
                    <th style="background:#eef2f7;color:#334155;padding:8px">Monto</th>
                    <th style="background:#eef2f7;color:#334155;padding:8px">Documento</th>
                    <th style="background:#eef2f7;color:#334155;padding:8px">Estado</th>
                    <th style="background:#eef2f7;color:#334155;padding:8px;border-radius:0 6px 6px 0">Acciones</th>
                  </tr>
                </thead>
                <tbody id="child-body-${rowKey}">
                  ${(inv.hijos||[]).map((h,j)=>`
                    <tr style="border-bottom:1px dashed #e8eef5">
                      <td style="padding:8px"><b>${h.id}</b></td>
                      <td style="padding:8px">${h.tipo}</td>
                      <td style="padding:8px">${h.fecha}</td>
                      <td style="padding:8px" class="text-right">${h.monto}</td>
                      <td style="padding:8px" class="text-left">${h.documento}</td>
                      <td style="padding:8px">${badgeHijo(h.estado)}</td>
                      <td style="padding:8px">
                            ${
                                h.estado === "REGISTRADO"
                                ? `<button class="btn btn-action btn-instruir"
                                    onclick="instruirMovimiento(${idx},${j})">
                                    Notificar (Instruir)
                                    </button>`
                                : ""
                            }
                            ${
                                h.estado === "NOTIFICADO A BACK OFFICE"
                                ? `<button class="btn btn-action btn-cancelar"
                                    onclick="irABackOffice(${idx},${j})">
                                    Registrar en Back Office
                                    </button>`
                                : ""
                            }
                            ${
                                h.estado === "CANCELADO"
                                ? `<span style="color:#888;font-size:.8em;">Ya registrado en Back Office</span>`
                                : ""
                            }

                      </td>
                    </tr>
                  `).join("")}
                </tbody>
              </table>
            </div>
          </div>
        </td>
      `;
      $tb.append(trChild);
    });

    // toggles con animaci√≥n
    $(".toggle").off("click").on("click", function(e){
      e.stopPropagation();
      const key = $(this).data("target");
      const $wrap = $(`#wrap-${key}`);
      const $sign = $(`#sign-${key}`);
      const isHidden = $wrap.is(":hidden");
      $wrap.stop(true,true).slideToggle(160);
      $sign.text(isHidden ? "‚àí" : "+");
    });

    // seleccionar fila padre (solo highlight)
    $("#inversionesBody > tr").off("click").on("click", function(){
      $("#inversionesBody > tr").removeClass("selected");
      $(this).addClass("selected");
    });
  }

  // =============== ACCIONES HIJO ===============
  function instruirMovimiento(i,j){
    const h = inversiones[i].hijos[j];
    if(h.estado!=="REGISTRADO"){ toastr.error("Solo puedes instruir un movimiento en estado REGISTRADO."); return; }
    h.estado = "NOTIFICADO A BACK OFFICE";
    toastr.success(`Movimiento ${h.id} Notificado a Back Office.`);
    applyFilters();
  }
  function cancelarMovimiento(i,j){
    const h = inversiones[i].hijos[j];
    if(h.estado==="CANCELADO"){ toastr.info("El movimiento ya estaba cancelado."); return; }
    h.estado = "CANCELADO";
    toastr.warning(`Movimiento ${h.id} cancelado.`);
    applyFilters();
  }

  // Redirige a Back Office (cambia el archivo si usar√°s otro)
const BACKOFFICE_URL = "backoffice-instruccion.html";

async function instruirMovimiento(i, j){
  const h = inversiones[i].hijos[j];
  if(h.estado !== "REGISTRADO"){
    toastr.error("Solo puedes notificar un movimiento en estado REGISTRADO.");
    return;
  }

  // Primera confirmaci√≥n
  const step1 = await Swal.fire({
    title: `¬øNotificar a Back Office?`,
    text: `Movimiento ${h.id} (${h.tipo}) por ${h.monto}`,
    icon: "question",
    showCancelButton: true,
    confirmButtonText: "S√≠, notificar",
    cancelButtonText: "Cancelar",
    confirmButtonColor: "#2563eb"
  });

  if(!step1.isConfirmed){
    toastr.info("Notificaci√≥n cancelada.");
    return;
  }

  // Segunda confirmaci√≥n
  const step2 = await Swal.fire({
    title: "Confirmaci√≥n final",
    text: "¬øEst√°s completamente seguro de enviar la instrucci√≥n?. Esta acci√≥n no se puede deshacer.",
    icon: "warning",
    showCancelButton: true,
    confirmButtonText: "S√≠, enviar",
    cancelButtonText: "No",
    confirmButtonColor: "#dc2626"
  });

  if(!step2.isConfirmed){
    toastr.info("Notificaci√≥n cancelada.");
    return;
  }

  // Cambiar estado
  h.estado = "NOTIFICADO A BACK OFFICE";
  Swal.fire({
    icon: "success",
    title: "Notificado",
    text: `Movimiento ${h.id} fue notificado a Back Office.`,
    timer: 2000,
    showConfirmButton: false
  });
  applyFilters();
}

async function cancelarMovimiento(i, j){
  const inv = inversiones[i];
  const h = inv.hijos[j];

  if(h.estado !== "NOTIFICADO A BACK OFFICE"){
    toastr.error("Para continuar, el movimiento debe estar NOTIFICADO A BACK OFFICE (notificado).");
    return;
  }

  const go = await Swal.fire({
    title: "Registrar en Back Office",
    text: `¬øDeseas ir a la vista de Back Office para registrar el movimiento ${h.id}?`,
    icon: "info",
    showCancelButton: true,
    confirmButtonText: "S√≠, continuar",
    cancelButtonText: "Cancelar",
    confirmButtonColor: "#16a34a"
  });

  if(go.isConfirmed){
    const qs = new URLSearchParams({
      inv: inv.invPrincipal,
      mov: h.id,
      tipo: h.tipo,
      fecha: h.fecha,
      monto: h.monto,
      doc: h.documento
    }).toString();

    window.location.href = `${BACKOFFICE_URL}?${qs}`;
  }
}


  // =============== NAVEGACI√ìN ===============
  function irARegistroLlamado(inversionId){
    if(inversionId){
      window.location.href = `registro-llamado-capital.html?inv_id=${encodeURIComponent(inversionId)}`;
    }else{
      window.location.href = "registro-llamado-capital.html";
    }
  }

  function irAAprobacion(inversionId) {
  const claseActivo     = "Inversiones Alternativas";
  const mercado         = "Local";
  const subcategoria    = "Fondos de inversi√≥n";
  const tipoInstrumento = "Fondo privado";

  // Construir query params
  const params = new URLSearchParams({
    claseActivo,
    mercado,
    subcategoria,
    tipoInstrumento
  });

  // Si adem√°s hay inversionId, se agrega
  if (inversionId) {
    params.set("inv_id", inversionId);
  }

  // Redirecci√≥n con todos los par√°metros
  window.location.href = `aprobacion-instrumento.html?${params.toString()}`;
}


  window.irAAprobacion = irAAprobacion;

   function irABackOffice(i, j) {
  const inv = inversiones[i];
  const h   = inv.hijos[j];

  // Armar URL con todos los datos necesarios
  const url = new URL("backoffice-instruccion.html", window.location.href);
  url.searchParams.set("inv", inv.inversionNum);
  url.searchParams.set("mov", h.id);
  url.searchParams.set("tipo", h.tipo);
  url.searchParams.set("fecha", h.fecha);
  url.searchParams.set("monto", h.monto);
  url.searchParams.set("doc", h.documento);
  url.searchParams.set("bank", inv.banco || "Banco de Cr√©dito del Per√∫ (BCP)"); // si no lo tienes a√∫n, agrega en mock

  window.location.href = url.toString();
}
window.irABackOffice = irABackOffice;
  window.irARegistroLlamado = irARegistroLlamado;

  // =============== FILTROS (manteniendo los tuyos) ===============
  function filtrar(base){
    const fEntidad = $("#entidad").val() || "";
    const fUnidad  = $("#unidadNegocio").val() || "";
    const fTipo    = $("#tipoInstrumento").val() || "";
    const fInvNum  = ($("#inversionNum").val()||"").trim().toLowerCase();
    const fDep     = ($("#numeroDeposito").val()||"").trim().toLowerCase();
    const fEstadoH = $("#estadoFiltro").val() || "";

    return base.filter(r=>{
      if(fEntidad && r.entidad!==fEntidad) return false;
      if(fUnidad  && r.unidad !==fUnidad ) return false;
      if(fTipo    && r.tipo   !==fTipo   ) return false;
      if(fInvNum  && !(`${r.inversionNum}`.toLowerCase().includes(fInvNum))) return false;
      if(fDep     && !(`${r.numeroDeposito}`.toLowerCase().includes(fDep))) return false;
      if(fEstadoH){
        if(!(r.hijos||[]).some(h=>h.estado===fEstadoH)) return false;
      }
      return true;
    });
  }

  function applyFilters(){
    renderTabla(filtrar(inversiones));
  }

  // =============== INIT ===============
  $(function(){
    // Inputs de texto -> al escribir
    $("#inversionNum, #numeroDeposito").on("input", applyFilters);

    // Selects y checkboxes -> al cambiar
    $("#entidad, #unidadNegocio, #tipoInstrumento, #estadoFiltro, #checkFechaCompra, #checkFechaEmision, #checkFechaVencim")
    .on("change", applyFilters);


    $("#btnBuscar").on("click", applyFilters);
    $("#btnLimpiar").on("click", function(){
      $("#entidad").val(""); $("#unidadNegocio").val("");
      $("#tipoInstrumento").val(""); $("#inversionNum").val("");
      $("#numeroDeposito").val(""); $("#estadoFiltro").val("");
      $("#checkFechaCompra").prop("checked", false);
      $("#checkFechaEmision").prop("checked", false);
      $("#checkFechaVencim").prop("checked", false);
      applyFilters();
    });

    applyFilters();


  });

      async function aprobarInversion() {
            if (!inversionActual) return;

              // Segunda confirmaci√≥n
        const step2 = await Swal.fire({
          title: "Confirmaci√≥n",
          text: "¬øEst√°s completamente seguro de aprobar el instrumento?. Esta acci√≥n no se puede deshacer.",
          icon: "warning",
          showCancelButton: true,
          confirmButtonText: "S√≠, aprobar",
          cancelButtonText: "No",
          confirmButtonColor: "#dc2626"
        });

        if(!step2.isConfirmed){
          toastr.info("Notificaci√≥n cancelada.");
          return;
        }

            const confirmacion = document.getElementById('confirmacion-compra').files.length > 0;
            const constancia = document.getElementById('constancia-venta').files.length > 0;
            const justificacion = document.getElementById('justificacion').value.trim();

            if (!confirmacion || !constancia || !justificacion) {
                toastr.error('Debe cargar todos los documentos b√°sicos y completar la justificaci√≥n');
                return;
            }

            for (let doc of documentosAdicionales) {
                if (!doc.archivo) {
                    toastr.error(`Debe cargar el documento: ${doc.etiqueta}`);
                    return;
                }
            }

            const index = inversiones.findIndex(inv => inv.inversionNum === inversionActual.inversionNum);
            if (index !== -1) {
                inversiones[index].estado = 'APROBADO';
            }

            renderTabla(filtrar(inversiones));

            toastr.success(`Inversi√≥n ${inversionActual.inversionNum} ha sido APROBADA exitosamente`);

            setTimeout(() => {
                cerrarModal();
            }, 1500);

            
        }

  let inversionActual = null;

        function abrirModalAprobacion(inversion) {
          console.log(inversion)
            inversionActual = inversion;
            documentosAdicionales = [];
            llenarInformacionGeneral(inversion);
            llenarDocumentosGeneral();
            configurarDocumentosTesoreria();
            configurarSeccionJustificacion();

            document.getElementById('modalAprobacion').style.display = 'flex';
            toastr.info('Modal de aprobaci√≥n abierto');
        }

        function cerrarModal() {
            document.getElementById('modalAprobacion').style.display = 'none';
            inversionActual = null;
        }

        function cambiarTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById('tab-' + tabName).classList.add('active');
        }


        function llenarInformacionGeneral(inversion) {
            const container = document.getElementById('infoGeneral');

            const campos = [
                { label: 'C√≥digo del instrumento', value: 'INV-40459532' },
                { label: 'Unidad de negocio', value: 'FCR-LEY N¬∞ 28046' },
                { label: 'Plazo de vencimiento', value: 'Se calcular√° autom√°ticamente' },
                { label: 'Emisor', value: 'REPUBLICA DEL PERU' },
                { label: 'Clasificaci√≥n de riesgos', value: 'BBB+' },
                { label: 'Grupo econ√≥mico', value: 'Grupo Romero' },
                { label: 'ISIN', value: inversion.producto || 'PE0324005A57' },
                { label: 'Nem√≥nico', value: 'SBPER' },
                { label: 'Moneda', value: 'PEN' },
                { label: 'Cantidad', value: '1,000.00' },
                { label: 'Valor unitario', value: '1,000.00' },
                { label: 'Valor nominal adquirido', value: inversion.valorNominal || '1,000,000.00' },
                { label: 'Periodicidad del cup√≥n', value: 'Semestral' },
                { label: 'Cup√≥n (%)', value: '6.5000' },
                { label: 'Tipo de amortizaci√≥n', value: 'Amortizable' },
                { label: 'Fecha de emisi√≥n', value: inversion.fechaEmision || '20/09/2025' },
                { label: 'Fecha Liquidaci√≥n', value: '21/09/2025' },
                { label: 'Fecha de vencimiento', value: inversion.fechaVencimiento || '20/09/2029' },
                { label: 'Plazo en a√±os', value: '4' },
                { label: 'Banco cuenta de cargo', value: 'BANCO DE CR√âDITO' },
                { label: 'N¬∞ de Cuenta Bancaria', value: 'N¬∞ 193-13814691-0-31' },
                { label: 'Tipo de custodia', value: 'Local' },
                { label: 'Nombre de custodia', value: 'Banco Scotiabank' },
                { label: 'Tipo de Mercado', value: 'Primario' }
            ];

            container.innerHTML = campos.map(campo => `
        <div class="info-field">
            <div class="info-label">${campo.label}</div>
            <div class="info-value">${campo.value}</div>
        </div>
    `).join('');
        }
        function llenarDocumentosGeneral() {
            const container = document.getElementById('tab-general');

            const documentosGenerales = [
                'Informe de Riesgos',
                'Informe Legal',
                'Acta de Comit√© de Inversiones'
            ];

            container.innerHTML = `
        <div style="margin-bottom: 20px;">
            <h4 style="color: #005C97; margin-bottom: 15px;">Documentos ya cargados:</h4>
            ${documentosGenerales.map(doc => `
                <div class="document-item">
                    <span style="color: #28a745;">üìÑ</span>
                    <span style="flex: 1;">${doc}</span>
                    <button class="btn btn-action" style="background: #17a2b8; color: white;" 
                            onclick="descargarDocumento('${doc}')">Descargar</button>
                </div>
            `).join('')}
        </div>
    `;
        }

        let documentosAdicionales = [];

        function configurarDocumentosTesoreria() {
            const container = document.getElementById('tab-tesoreria');

            container.innerHTML = `
        <div>
            <h4 style="color: #005C97; margin-bottom: 15px;">Documentos requeridos para aprobaci√≥n:</h4>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">
                    Confirmaci√≥n de compra
                </label>
                <div style="border: 2px dashed #ccc; padding: 20px; text-align: center; border-radius: 8px; cursor: pointer;"
                     onclick="triggerFileUpload('confirmacion-compra')">
                    <input type="file" id="confirmacion-compra" style="display: none;" 
                           accept=".pdf" onchange="handleFileUpload(this, 'Confirmaci√≥n de compra')">
                    <span id="status-confirmacion" style="color: #666;">üìÑ Seleccionar archivo PDF</span>
                </div>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">
                    Constancia de Confirmaci√≥n de Venta de Entidad Financiera
                </label>
                <div style="border: 2px dashed #ccc; padding: 20px; text-align: center; border-radius: 8px; cursor: pointer;"
                     onclick="triggerFileUpload('constancia-venta')">
                    <input type="file" id="constancia-venta" style="display: none;" 
                           accept=".pdf" onchange="handleFileUpload(this, 'Constancia de venta')">
                    <span id="status-constancia" style="color: #666;">üìÑ Seleccionar archivo PDF</span>
                </div>
            </div>

            <!-- Contenedor para documentos adicionales -->
            <div id="documentos-adicionales-container">
                <!-- Los documentos adicionales se agregar√°n aqu√≠ din√°micamente -->
            </div>
            
            <!-- Configuraci√≥n Avanzada -->
            <div style="margin-top: 30px; border-top: 2px solid #e9ecef; padding-top: 20px;">
                <h4 style="color: #005C97; margin-bottom: 15px;">‚öôÔ∏è Configuraci√≥n Avanzada</h4>
                <div style="display: flex; gap: 10px; align-items: end; margin-bottom: 15px;">
                    <div style="flex: 1;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">
                            Etiqueta del documento:
                        </label>
                        <input type="text" id="nueva-etiqueta" placeholder="Ej: Autorizaci√≥n especial" 
                               style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 5px;">
                    </div>
                    <button type="button" onclick="agregarDocumentoAdicional()" 
                            style="background: #17a2b8; color: white; border: none; padding: 10px 20px; border-radius: 5px; font-weight: 600; cursor: pointer;">
                        + Agregar Documento
                    </button>
                </div>
                <small style="color: #6c757d; font-style: italic;">
                    Los documentos agregados ser√°n requeridos para completar la aprobaci√≥n.
                </small>
            </div>
        </div>
    `;
        }
        function triggerFileUpload(inputId) {
            document.getElementById(inputId).click();
        }

        function handleFileUpload(input, docName) {
            const statusId = input.id === 'confirmacion-compra' ? 'status-confirmacion' : 'status-constancia';
            const statusElement = document.getElementById(statusId);

            if (input.files.length > 0) {
                const fileName = input.files[0].name;
                if (fileName.toLowerCase().endsWith('.pdf')) {
                    statusElement.innerHTML = `<span style="color: #28a745;">‚úÖ ${fileName}</span>`;
                    statusElement.parentElement.style.borderColor = '#28a745';
                    statusElement.parentElement.style.backgroundColor = '#f8fff8';
                } else {
                    statusElement.innerHTML = `<span style="color: #dc3545;">‚ùå Solo archivos PDF</span>`;
                    input.value = '';
                }
            }
        }

        function descargarDocumento(nombreDoc) {
            toastr.success(`Descargando: ${nombreDoc}`);
        }

        
        function configurarSeccionJustificacion() {
            const container = document.getElementById('seccionJustificacion');

            container.innerHTML = `
        <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600;">
                Justificaci√≥n de la operaci√≥n
            </label>
            <textarea id="justificacion" rows="4" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; resize: vertical;"
                      placeholder="Ingrese la justificaci√≥n para esta operaci√≥n..."></textarea>
        </div>
    `;
        }

                function agregarDocumentoAdicional() {
            const etiquetaInput = document.getElementById('nueva-etiqueta');
            const etiqueta = etiquetaInput.value.trim();

            if (!etiqueta) {
                toastr.error('Debe ingresar una etiqueta para el documento');
                return;
            }

            if (documentosAdicionales.some(doc => doc.etiqueta === etiqueta)) {
                toastr.error('Ya existe un documento con esa etiqueta');
                return;
            }

            const docId = 'doc-adicional-' + Date.now();
            const nuevoDoc = {
                id: docId,
                etiqueta: etiqueta,
                archivo: null
            };

            documentosAdicionales.push(nuevoDoc);

            renderizarDocumentosAdicionales();

            etiquetaInput.value = '';

            toastr.success(`Documento "${etiqueta}" agregado`);
        }

         function renderizarDocumentosAdicionales() {
            const container = document.getElementById('documentos-adicionales-container');

            container.innerHTML = documentosAdicionales.map(doc => `
        <div style="margin-bottom: 20px; position: relative;" id="container-${doc.id}">
            <label style="display: block; margin-bottom: 8px; font-weight: 600;">
                ${doc.etiqueta}
                <button type="button" onclick="eliminarDocumentoAdicional('${doc.id}')" 
                        style="background: #dc3545; color: white; border: none; padding: 2px 8px; border-radius: 3px; font-size: 12px; margin-left: 10px; cursor: pointer;">
                    ‚úï
                </button>
            </label>
            <div style="border: 2px dashed #ccc; padding: 20px; text-align: center; border-radius: 8px; cursor: pointer;"
                 onclick="triggerFileUpload('${doc.id}')">
                <input type="file" id="${doc.id}" style="display: none;" 
                       accept=".pdf" onchange="handleFileUploadAdicional(this, '${doc.etiqueta}')">
                <span id="status-${doc.id}" style="color: #666;">üìÑ Seleccionar archivo PDF</span>
            </div>
        </div>
    `).join('');
        }

                function handleFileUploadAdicional(input, etiqueta) {
            const statusElement = document.getElementById(`status-${input.id}`);
            const doc = documentosAdicionales.find(d => d.id === input.id);

            if (input.files.length > 0) {
                const fileName = input.files[0].name;
                if (fileName.toLowerCase().endsWith('.pdf')) {
                    statusElement.innerHTML = `<span style="color: #28a745;">‚úÖ ${fileName}</span>`;
                    statusElement.parentElement.style.borderColor = '#28a745';
                    statusElement.parentElement.style.backgroundColor = '#f8fff8';
                    if (doc) doc.archivo = input.files[0];
                } else {
                    statusElement.innerHTML = `<span style="color: #dc3545;">‚ùå Solo archivos PDF</span>`;
                    input.value = '';
                    if (doc) doc.archivo = null;
                }
            }
        }

          function eliminarDocumentoAdicional(docId) {
            documentosAdicionales = documentosAdicionales.filter(doc => doc.id !== docId);
            renderizarDocumentosAdicionales();
            toastr.info('Documento eliminado');
        }

             function getAreaParam() {
    const params = new URLSearchParams(window.location.search);
    return params.get("area");
  }

  const area = getAreaParam();
  if (area) {
    document.getElementById("area-badge").textContent = "Perfil: " + area;
  }
</script>
</body>
</html>
