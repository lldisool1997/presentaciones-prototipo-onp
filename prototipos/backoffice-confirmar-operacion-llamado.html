<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Back Office ¬∑ Registrar Instrucci√≥n</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { brand1:'#005C97', brand2:'#004a7c', line:'#e5e7eb', ink:'#2c3e50', muted:'#f9fafb' },
          boxShadow: { card:'0 8px 32px rgba(0,0,0,.08)', panel:'0 10px 30px rgba(0,0,0,.15)' }
        }
      }
    }
  </script>

  <!-- jQuery + Toastr + SweetAlert2 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/cleave.js/1.6.0/cleave.min.js"></script>

  <style>
    /* Toastr sin √≠conos embebidos */
    #toast-container > .toast-success,
    #toast-container > .toast-error,
    #toast-container > .toast-info,
    #toast-container > .toast-warning {
      background-image: none !important;
      background-repeat: none !important;
      padding-left: 14px !important;
    }

    .header {
      background: linear-gradient(135deg, #005C97 0%, #004a7c 100%);
      color: white; padding: 2rem; text-align: center;
    }
    .header h1 { font-size: 2rem; font-weight: 600; margin-bottom: .5rem; }
    .header p  { opacity:.9; font-size: 1.1rem; }

    .section-header{
      font-size:1.2rem; font-weight:600;
      background:linear-gradient(135deg,#f8f9fa 0%,#e9ecef 100%);
      border-left:4px solid #005C97; padding:.75rem 1rem;
      border-radius:6px; margin-bottom:1.5rem; color:#333;
    }

    /* Hover/click para zonas de subida */
    .file-upload-area, #drop{
      cursor:pointer; transition: border-color .2s, box-shadow .2s;
    }
    .file-upload-area:hover, #drop:hover{
      border-color:#60a5fa; box-shadow: inset 0 0 0 2px rgba(59,130,246,.25);
    }
  </style>
</head>
<body class="bg-gray-100 text-ink">

  <!-- badge de perfil/√°rea -->
  <div id="area-badge"
       style="position:absolute; top:15px; right:20px; background:#1e6ba8; color:#fff;
              font-weight:bold; font-size:.9rem; padding:6px 14px; border-radius:20px;
              box-shadow:0 2px 6px rgba(0,0,0,.15);">
    √Årea: -
  </div>

  <main class="max-w-[1100px] mx-auto px-4 py-6">
    <div class="header rounded-2xl rounded-b-none">
      <h1>Confirmar operaci√≥n</h1>
    </div>

    <!-- 1. Resumen -->
    <section class="bg-white border-line p-5">
      <div class="section-header">1. Resumen del movimiento</div>
      <div id="head" class="grid md:grid-cols-3 gap-3 text-[15px]"></div>

      <div class="mt-3 grid md:grid-cols-3 gap-3 text-[15px]">
        <div class="bg-muted border rounded-xl p-3">
          <div class="text-xs text-gray-500">Banco</div>
          <div id="head_banco" class="font-semibold">‚Äî</div>
        </div>
        <div class="bg-muted border rounded-xl p-3">
          <div class="text-xs text-gray-500">Documento</div>
          <div class="flex items-center gap-3">
            <span id="head_doc" class="font-semibold">‚Äî</span>
            <a id="btnDescargar" href="#" download
               class="ml-auto px-3 py-1.5 rounded-lg border-2 border-gray-300 bg-white hover:bg-gray-50 text-sm">
              Descargar
            </a>
          </div>
        </div>
        <!--<div class="bg-muted border rounded-xl p-3">
          <div class="text-xs text-gray-500">Estado esperado</div>
          <div class="font-semibold">CANCELADO (al guardar instrucci√≥n)</div>
        </div>-->
      </div>
    </section>

    <!-- 2. Desagregado -->
    <section class="bg-white border-line p-5">
      <div class="section-header">2. Desagregado</div>

      <div class="flex items-center justify-between mb-2">
        <div class="text-sm">
          <span class="px-2.5 py-1 rounded-full text-xs font-semibold bg-blue-50 text-blue-700">Debe: <b id="sumDebe">0.00</b></span>
          <span class="px-2.5 py-1 rounded-full text-xs font-semibold bg-emerald-50 text-emerald-700 ml-1">Haber: <b id="sumHaber">0.00</b></span>
          <span class="px-2.5 py-1 rounded-full text-xs font-semibold bg-amber-50 text-amber-700 ml-1">Diferencia: <b id="sumDiff">0.00</b></span>
        </div>
      </div>

      <div class="border rounded-2xl overflow-hidden">
        <table class="w-full text-sm">
          <thead>
            <tr class="bg-gray-50 text-gray-600">
              <th class="text-left p-3">Concepto</th>
              <th class="text-center p-3 w-40">Debe/Haber</th>
              <th class="text-right p-3 w-48">Monto</th>
            </tr>
          </thead>
          <tbody id="tbody" class="divide-y divide-gray-100"></tbody>
          <tfoot class="divide-y divide-gray-100">
             <tr class="bg-gray-50 text-gray-600">
              <th class="text-left p-3"></th>
              <th class="text-center p-3 w-40">Total</th>
              <th class="text-right p-3 w-48" id="montoTotal">Monto</th>
              <th class="text-center p-3 w-20"></th>
            </tr>
          </tfoot>
        </table>
      </div>

      <!--<div class="mt-3 flex justify-between items-center">
        <button id="btnAgregar" type="button"
                class="px-4 py-2.5 rounded-xl bg-white border-2 border-gray-300 hover:bg-gray-50 font-semibold">
          + Agregar l√≠nea
        </button>
        <div class="text-xs text-gray-500">La suma debe cuadrar con el monto del llamado.</div>
      </div>-->
    </section>

    <!-- 3. Sustento documentario (NUEVO) -->
    <section class="bg-white rounded-2xl rounded-t-none   p-5 mb-5">
      <div class="section-header">3. Sustento documentario</div>

      <!-- Drop principal (PDF obligatorio) -->
      <div class="p-4 rounded-xl bg-gray-50 border border-line">
        <label class="block text-sm font-semibold mb-2">Constancia de operaci√≥n</label>
        <div id="drop" class="rounded-md border-2 border-dashed border-gray-300 bg-muted p-4 max-w-md">
          <input id="file" type="file" accept=".pdf" class="hidden">
          <div class="text-center text-sm">
            <div class="font-semibold">üìÑ Seleccionar archivo</div>
            <div class="text-gray-500">PDF</div>
          </div>
          <div id="fileName" class="mt-2 text-blue-700 font-medium hidden"></div>
        </div>
      </div>

      <!-- Campos din√°micos (agregar m√°s PDFs) -->
      <div class="mt-4">
        <div id="documentFields" class="grid md:grid-cols-3 gap-3 mb-3"></div>
        <div class="flex items-center gap-2 mb-2">
          <input id="newDocumentName" type="text" placeholder="Nombre del nuevo documento"
                 class="px-3 py-2 rounded-sm border border-gray-300 w-[280px]">
          <button type="button" class="add-document-btn px-3 py-2 rounded-sm bg-[#218838] hover:bg-[#145221] text-white">
            + Agregar documento
          </button>
        </div>
        
      </div>
    </section>

    <!-- 4. Acciones -->
    <section class="flex justify-end gap-3">
      <a href="javascript:history.back()" class="px-4 py-2.5 rounded-xl border-2 border-gray-300 bg-white hover:bg-gray-50">Cancelar</a>
      <button id="btnGuardar" disabled
              class="px-5 py-2.5 rounded-xl bg-blue-600 hover:bg-blue-700 text-white font-semibold disabled:opacity-50">
        Confirmar Operaci√≥n
      </button>
    </section>
  </main>

  <script>
  // =================== TOASTR ===================
  toastr.options = {
    closeButton:true,newestOnTop:true,progressBar:true,
    positionClass:"toast-top-right",timeOut:2600,extendedTimeOut:1200,
    showDuration:160,hideDuration:160,showMethod:"fadeIn",hideMethod:"fadeOut"
  };

  // =================== Cat√°logo de conceptos por FLAG ===================
  // 1 = Local, 2 = Extranjero, 3 = Extranjero EUR, 4 = IK (Instrumentos de Capital)
  const CATALOGO_CONCEPTOS_BY_FLAG = {
    "1":[
      { concepto:"Llamado de Capital",                 dhLabel:"Saldo Positivo (+)",                side:"DEBE"  },
      { concepto:"Rescate de Capital",                 dhLabel:"Saldo Negativo (-)",                side:"HABER" },
      { concepto:"Devoluci√≥n de capital",              dhLabel:"Saldo Negativo (-)",                side:"HABER" },
      { concepto:"Distribuci√≥n de dividendos",         dhLabel:"Ingreso (+)",                       side:"HABER" },
      { concepto:"Perdida Distribucion de dividendos", dhLabel:"Ingreso (-)",                       side:"DEBE"  },
      { concepto:"Perdida por Diferencia de cambio",   dhLabel:"Diferencia por tipo de cambio (+)", side:"DEBE"  },
      { concepto:"Ganancia por Diferencia de cambio",  dhLabel:"Ingreso (+)",                       side:"HABER" }
    ],
    "2":[
      { concepto:"Capital comprometido",               dhLabel:"Saldo Positivo (+)",                side:"DEBE"  },
      { concepto:"Llamado de Capital",                 dhLabel:"Saldo Positivo (+)",                side:"DEBE"  },
      { concepto:"Rescate de Capital",                 dhLabel:"Saldo Negativo (-)",                side:"HABER" },
      { concepto:"Devoluci√≥n de capital",              dhLabel:"Saldo Negativo (-)",                side:"HABER" },
      { concepto:"Distribuci√≥n de dividendos",         dhLabel:"Ingreso (+)",                       side:"HABER" },
      { concepto:"Perdida Distribucion de dividendos", dhLabel:"Ingreso (-)",                       side:"DEBE"  },
      { concepto:"Perdida por Diferencia de cambio",   dhLabel:"Diferencia por tipo de cambio (+)", side:"DEBE"  },
      { concepto:"Ganancia por Diferencia de cambio",  dhLabel:"Ingreso (+)",                       side:"HABER" }
    ],
    "3":[
      { concepto:"Capital comprometido",               dhLabel:"Saldo Positivo (+)",                side:"DEBE"  },
      { concepto:"Llamado de Capital",                 dhLabel:"Saldo Positivo (+)",                side:"DEBE"  },
      { concepto:"Rescate de Capital (o Retrocesi√≥n)", dhLabel:"Saldo Negativo (-)",                side:"HABER" },
      { concepto:"Devoluci√≥n de capital",              dhLabel:"Saldo Negativo (-)",                side:"HABER" },
      { concepto:"Distribucion de dividendos (o dietas)", dhLabel:"Ingreso (+)",                    side:"HABER" },
      { concepto:"Perdida Distribucion de dividendos", dhLabel:"Ingreso (-)",                       side:"DEBE"  },
      { concepto:"Ganancia por Diferencia de cambio",  dhLabel:"Diferencia por tipo de cambio (+)", side:"DEBE"  }
    ],
    "4":[
      { concepto:"Compra",                                              dhLabel:"Ingreso (+)", side:"HABER" },
      { concepto:"Liquidaci√≥n",                                         dhLabel:"Ingreso (-)", side:"DEBE"  },
      { concepto:"Ingreso extra (Rebates)",                             dhLabel:"Ingreso (+)", side:"HABER" },
      { concepto:"Estimaci√≥n/Provisi√≥n: Cuenta x cobrar (Debe)",        dhLabel:"Ingreso (+)", side:"HABER" },
      { concepto:"Estimaci√≥n/Provisi√≥n: Cuenta x cobrar (Haber)",       dhLabel:"Ingreso (-)", side:"DEBE"  },
      { concepto:"Cancelaci√≥n por Reinversi√≥n (Debe)",                  dhLabel:"Ingreso (+)", side:"HABER" },
      { concepto:"Cancelaci√≥n por Reinversi√≥n (Haber)",                 dhLabel:"Ingreso (-)", side:"DEBE"  },
      { concepto:"Cancelaci√≥n por Ingreso a Tesorer√≠a (Debe)",          dhLabel:"Ingreso (+)", side:"HABER" },
      { concepto:"Cancelaci√≥n por Ingreso a Tesorer√≠a (Haber)",         dhLabel:"Ingreso (-)", side:"DEBE"  }
    ]
  };

  // =================== Helpers ===================
  const qs       = new URLSearchParams(location.search);
  const invId    = qs.get("inv")  || "‚Äî";
  const movId    = qs.get("mov")  || "‚Äî";
  const movTipo  = qs.get("tipo") || "Llamado";
  const movFecha = qs.get("fecha")|| "‚Äî";
  const movMontoS= qs.get("monto")|| "0.00";
  const flagCtas = (qs.get("ctas") || "1").trim();  // default Local
  const movDoc   = qs.get("doc")  || "documento.pdf";
  const banco    = qs.get("bank") || "Banco de Cr√©dito del Per√∫ (BCP)";

  const montoLlamado = parseFloat(String(movMontoS).replace(/[^\d.-]/g,"")) || 0;

  function money(n){ return (n||0).toLocaleString('es-PE',{minimumFractionDigits:2, maximumFractionDigits:2}); }
  function parseMoney(s){ return parseFloat(String(s).replace(/[^\d.-]/g,"")) || 0; }

  function renderHeader(){
    $("#head").html(`
      <div class="bg-muted border rounded-xl p-3">
        <div class="text-xs text-gray-500">Inversi√≥n</div>
        <div class="font-semibold">${invId}</div>
      </div>
      <div class="bg-muted border rounded-xl p-3">
        <div class="text-xs text-gray-500">Movimiento</div>
        <div class="font-semibold">${movId} ¬∑ ${movTipo}</div>
      </div>
      <div class="bg-muted border rounded-xl p-3">
        <div class="text-xs text-gray-500">Fecha / Monto</div>
        <div class="font-semibold">${movFecha} ¬∑ USD ${money(montoLlamado)}</div>
      </div>
    `);
    $("#head_banco").text(banco);
    $("#head_doc").text(movDoc);
    $("#btnDescargar").attr("href", "#").on("click", function(e){
      if(qs.get("docUrl")) $(this).attr("href", qs.get("docUrl"));
      else{ e.preventDefault(); toastr.info("No hay URL real del documento en esta demo."); }
    });
  }

  // ===== Cat√°logo activo =====
  const CATALOGO_CONCEPTOS = CATALOGO_CONCEPTOS_BY_FLAG[flagCtas] || CATALOGO_CONCEPTOS_BY_FLAG["1"];

  // =================== Estado del desagregado ===================
  let rows = []; // { concepto, dh, dhLabel, monto }
  const $tbody = $("#tbody");

  const conceptoOptionsHTML = [
    '<option value="">Seleccione‚Ä¶</option>',
    ...CATALOGO_CONCEPTOS.map(c => `<option value="${c.concepto}">${c.concepto}</option>`)
  ].join("");

  function nuevaFila(concepto="", monto=""){
    const item = CATALOGO_CONCEPTOS.find(c => c.concepto === concepto);
    return { concepto: concepto || "", dh: item?.side || "", dhLabel: item?.dhLabel || "", monto };
  }

  function dhBadgeHTML(label, side){
    const base = 'px-2.5 py-1 rounded-full text-xs font-semibold';
    if(side==="DEBE")  return `<span class="${base} bg-blue-50 text-blue-700" data-role="dh-badge">${label||"‚Äî"}</span>`;
    if(side==="HABER") return `<span class="${base} bg-emerald-50 text-emerald-700" data-role="dh-badge">${label||"‚Äî"}</span>`;
    return `<span class="${base} bg-gray-100 text-gray-500" data-role="dh-badge">${label||"‚Äî"}</span>`;
  }

  function buildRowHTML(i, r){
    return `
      <tr class="hover:bg-gray-50" data-row="${i}">
        <td class="p-2">
          <select disabled data-i="${i}" data-k="concepto"
                  class="w-full rounded-xl border-2 border-gray-300 p-2.5 text-[15px] focus:border-blue-500">
            ${conceptoOptionsHTML}
          </select>
        </td>
        <td class="p-2 text-center">
          <div data-i="${i}" data-k="dh-view">${dhBadgeHTML(r.dhLabel, r.dh)}</div>
        </td>
        <td class="p-2 text-right">
          <input disabled data-i="${i}" data-k="monto" inputmode="decimal" placeholder="0.00"
                 class="monto-input w-full text-right rounded-xl border-2 border-gray-300 p-2.5 text-[15px] focus:border-blue-500"
                 value="${r.monto||""}">
        </td>
      </tr>
    `;
  }

  function applyMasks() {
  document.querySelectorAll('.monto-input').forEach(el => {
    if (!el.cleave) { // evitar aplicar dos veces
      el.cleave = new Cleave(el, {
        numeral: true,
        numeralThousandsGroupStyle: 'thousand',
        numeralDecimalMark: '.',
        delimiter: ',',
        numeralDecimalScale: 2
      });
    }
  });
}


  function hydrateRowValues(i){
    const r = rows[i];
    const $row = $tbody.find('tr[data-row="' + i + '"]');
    $row.find('select[data-k="concepto"]').val(r.concepto||"");
    $row.find('input[data-k="monto"]').val(r.monto||"");
  }

  function attachRowHandlers(i){
    const $row = $tbody.find('tr[data-row="' + i + '"]');
    const $concepto = $row.find('select[data-k="concepto"]');
    const $monto    = $row.find('input[data-k="monto"]');
    const $dhView   = $row.find('[data-k="dh-view"]');

    $concepto.off("change").on("change", function(){
      const val  = $(this).val();
      const item = CATALOGO_CONCEPTOS.find(c => c.concepto === val);
      rows[i].concepto = val || "";
      rows[i].dh       = item?.side    || "";
      rows[i].dhLabel  = item?.dhLabel || "";
      $dhView.html(dhBadgeHTML(rows[i].dhLabel, rows[i].dh));
      updateTotals();
    });

    $monto.off("input blur")
      .on("input", function(){ rows[i].monto = $(this).val(); updateTotals(); })
      .on("blur",  function(){
        const num = parseMoney($(this).val());
        rows[i].monto = num ? num.toFixed(2) : "";
        $(this).val(rows[i].monto); updateTotals();
      });
  }

  function renderAllRows(){
    $tbody.empty();
    rows.forEach((r,i)=>{ $tbody.append(buildRowHTML(i,r)); hydrateRowValues(i); attachRowHandlers(i); });
    applyMasks();
    updateTotals();
  }

  function addRow(prefill=null){
    rows.push(prefill ? nuevaFila(prefill.concepto || "", prefill.monto || "") : nuevaFila());
    const i = rows.length - 1;
    $tbody.append(buildRowHTML(i, rows[i]));
    applyMasks();
    hydrateRowValues(i);
    attachRowHandlers(i);
    updateTotals();
    toastr.info("L√≠nea agregada.");
  }

  function reindexRowsAfterRemoval(){ renderAllRows(); }
  function removeRow(i){ rows.splice(i,1); toastr.warning("L√≠nea eliminada."); reindexRowsAfterRemoval(); }
  window.removeRow = removeRow;

  function updateTotals(){
    const totDebe  = rows.reduce((acc,r)=> acc + (r.dh==="DEBE"  ? parseMoney(r.monto) : 0), 0);
    const totHaber = rows.reduce((acc,r)=> acc + (r.dh==="HABER" ? parseMoney(r.monto) : 0), 0);
    const diff     = (totDebe - totHaber) - montoLlamado;

    $("#sumDebe").text(money(totDebe));
    $("#sumHaber").text(money(totHaber));
    $("#sumDiff").text(money(diff));
    $("#montoTotal").text(money(totDebe - totHaber));

    const balanced  = Math.abs(diff) < 0.005;
    const allFilled = rows.length>0 && rows.every(r=> r.concepto && (r.dh==="DEBE"||r.dh==="HABER") && parseMoney(r.monto)>0 );
    $("#btnGuardar").prop("disabled", !(allFilled && balanced));

    const $diff = $("#sumDiff").parent();
    $diff.removeClass("bg-emerald-50 text-emerald-700 bg-amber-50 text-amber-700 bg-red-50 text-red-700");
    $diff.addClass(balanced ? "bg-emerald-50 text-emerald-700" : "bg-amber-50 text-amber-700");
  }

  // =================== Subida de documentos (basado en tu registro-llamado) ===================
  // Estado de adjuntos din√°micos y principal
  let filesUploaded = {};     // { fieldId: boolean } para din√°micos
  let documentCounter = 1;

  function markInvalid($el){ $el.addClass("ring-2 ring-red-400 border-red-400"); }
  function clearInvalid($el){ $el.removeClass("ring-2 ring-red-400 border-red-400"); }

  function validatePdf(file){
    if(!file) return { ok:false, msg:"Adjunta el documento de notificaci√≥n (PDF)." };
    const isPdf = /\.pdf$/i.test(file.name||"");
    if(!isPdf) return { ok:false, msg:"Formato no permitido. Solo PDF." };
    if(file.size > 10*1024*1024) return { ok:false, msg:"El archivo supera 10MB." };
    return { ok:true };
  }

  function ensureDocumentFieldsContainer(){
    let cont = document.getElementById('documentFields');
    if(!cont){ cont = document.createElement('div'); cont.id='documentFields'; document.body.appendChild(cont); }
    return cont;
  }

  function createDocumentField(docName, fieldId, isCustom=true){
    const container = ensureDocumentFieldsContainer();

    const group = document.createElement('div');
    group.className = 'file-upload-group p-3 rounded-xl border border-line bg-gray-50';
    group.id = `field_${fieldId}`;

    const header = document.createElement('div');
    header.className = 'flex items-center gap-2 mb-2';
    const label = document.createElement('label');
    label.className = 'font-semibold';
    label.textContent = docName;
    header.appendChild(label);

    if(isCustom){
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'px-2 py-1 rounded-md text-white bg-red-500 hover:bg-red-600 text-xs';
      btn.textContent = '‚úï';
      btn.addEventListener('click', ()=> removeCustomDocument(fieldId));
      header.appendChild(btn);
    }

    const uploadArea = document.createElement('div');
    uploadArea.className = 'file-upload-area text-center rounded-md border-2 border-dashed border-gray-300 bg-white p-4';
    uploadArea.innerHTML = `
      <div class="font-medium">üìÑ Seleccionar archivo</div>
      <div class="text-gray-500 text-sm mt-1">PDF</div>
    `;

    const input = document.createElement('input');
    input.type = 'file';
    input.id = fieldId;
    input.accept = '.pdf';
    input.className = 'hidden';
    input.addEventListener('change', ()=> handleDynamicUpload(input, docName));

    group.appendChild(header);
    group.appendChild(uploadArea);
    group.appendChild(input);
    container.appendChild(group);

    filesUploaded[fieldId] = false; // inicial
  }

  // delega click sobre el √°rea para abrir el input
  $(document).off('click.openDynamic','.file-upload-area').on('click.openDynamic','.file-upload-area',function(e){
    if (e.target.closest('button')) return;
    const input = this.parentElement.querySelector('input[type="file"]');
    if(input) input.click();
  });

  function handleDynamicUpload(input, labelName){
    const area = input.previousElementSibling;
    const file = input.files[0];
    const v = validatePdf(file);
    if(!v.ok){
      input.value = '';
      filesUploaded[input.id] = false;
      area.innerHTML = `
        <div class="text-red-600">‚å´ ${v.msg}</div>
        <div class="text-gray-500 text-sm mt-1">PDF</div>
      `;
      $(area).addClass('ring-2 ring-red-400 border-red-400');
    } else {
      filesUploaded[input.id] = true;
      area.innerHTML = `
        <div class="file-name">üìé ${file.name}</div>
        <div class="text-green-600 text-sm">Archivo cargado correctamente</div>
      `;
      $(area).removeClass('ring-2 ring-red-400 border-red-400');
    }
    checkDocsForEnable();
  }

  function addCustomDocument(){
    const $name = $("#newDocumentName");
    const docName = ($name.val()||"").trim();
    if(!docName){ toastr.warning("Ingresa un nombre para el documento."); return; }
    const fieldId = `custom_${documentCounter++}`;
    createDocumentField(docName, fieldId, true);
    $name.val('');
  }

  function removeCustomDocument(fieldId){
    const el = document.getElementById(`field_${fieldId}`);
    if(el) el.remove();
    delete filesUploaded[fieldId];
    checkDocsForEnable();
  }

  // habilita/deshabilita guardar si hay din√°micos y falta alguno
  function checkDocsForEnable(){
    const ids = Object.keys(filesUploaded);
    if(!ids.length) return; // si no hay din√°micos, no bloquea
    const allOk = ids.every(id => filesUploaded[id]);
    // Nota: el bot√≥n tambi√©n depende del cuadre contable; esto solo no lo habilita
    if(!allOk) $("#btnGuardar").prop("disabled", true);
  }

  // valida el drop principal + din√°micos antes de guardar
  function validateDocsBeforeSave(){
    const $drop = $("#drop");
    const $file = $("#file");
    const f = $file[0].files[0];
    const v = validatePdf(f);
    if(!v.ok){
      markInvalid($drop);
      toastr.error(v.msg);
      return false;
    }
    clearInvalid($drop);

    // chequear din√°micos: si existen, todos deben estar OK
    const ids = Object.keys(filesUploaded);
    const missing = [];
    ids.forEach(id=>{
      if(!filesUploaded[id]){
        const label = document.querySelector(`#field_${id} label`)?.textContent?.trim() || id;
        missing.push(label);
        const area = document.querySelector(`#field_${id} .file-upload-area`);
        if(area) $(area).addClass('ring-2 ring-red-400 border-red-400');
      }
    });
    if(missing.length){
      toastr.warning("Adjunta los siguientes documentos: " + missing.join(", "));
      return false;
    }
    return true;
  }

  // =================== Guardar (actualizado para ‚Äúpago‚Äù) ===================
  async function guardar(){
    // 1) Validaciones contables (ya existentes)
    if($("#btnGuardar").prop("disabled")){
      toastr.error("El desagregado debe estar completo y cuadrado con el monto del llamado.");
      return;
    }
    // 2) Validar documentos
   // if(!validateDocsBeforeSave()) return;

    // 3) Confirmaci√≥n
    const step2 = await Swal.fire({
      title: "Confirmaci√≥n",
      text: "¬øConfirmas la operaci√≥n del llamado de capital?.",
      icon: "warning",
      showCancelButton: true,
      confirmButtonText: "S√≠, confirmar",
      cancelButtonText: "No",
      confirmButtonColor: "#0ea5e9"
    });
    if(!step2.isConfirmed){ toastr.info("Operaci√≥n cancelada."); return; }

    toastr.success("‚úÖ Instrucci√≥n registrada. Movimiento quedar√° en estado CANCELADO.");
    setTimeout(()=>{ window.location.href = "index.html?result=ok"; }, 1200);
  }

  // =================== INIT ===================
  $(function(){
    renderHeader();

    // fila default (Capital comprometido si existe; si no, el primero del cat√°logo)
    const DEFAULT_CONCEPTO =
      (CATALOGO_CONCEPTOS.find(c => c.concepto === "Capital comprometido")?.concepto)
      || (CATALOGO_CONCEPTOS[0]?.concepto || "");

    addRow({ concepto: DEFAULT_CONCEPTO, monto: "1,500,000.00" });
    addRow({ concepto: "Distribuci√≥n de dividendos", monto: "500,000.00" });

    $("#btnAgregar").on("click", ()=> addRow());
    $("#btnGuardar").on("click", guardar);

    // ---- Subida principal (drop) ----
    const $drop = $("#drop");
    const $file = $("#file");
    const $fileName = $("#fileName");

    // abrir file picker al hacer click en el recuadro
    $drop.off('click.open').on('click.open', function(e){
      if(e.target.id === 'file') return;
      $file.trigger('click');
    });

    // mostrar nombre y validar
    $file.off('change.main').on('change.main', function(){
      const f = this.files[0];
      const v = validatePdf(f);
      if(!v.ok){
        this.value = "";
        $fileName.addClass("hidden").text("");
        markInvalid($drop);
        toastr.error(v.msg);
        // reset textos
        $drop.find(".font-semibold").text("üìÑ Seleccionar archivo");
        $drop.find(".text-gray-500").text("PDF");
        return;
      }
      clearInvalid($drop);
      $fileName.removeClass("hidden").text(f.name);
      toastr.success("Documento adjuntado.");
    });

    // drag & drop
    $drop.off('dragover.dd dragleave.dd drop.dd')
      .on("dragover.dd", e=>{ e.preventDefault(); $drop.addClass("ring-2 ring-blue-300"); })
      .on("dragleave.dd", e=>{ e.preventDefault(); $drop.removeClass("ring-2 ring-blue-300"); })
      .on("drop.dd", function(e){
        e.preventDefault();
        $drop.removeClass("ring-2 ring-blue-300");
        const dt = e.originalEvent.dataTransfer;
        if(!(dt && dt.files && dt.files[0])) return;
        const f = dt.files[0];
        const v = validatePdf(f);
        if(!v.ok){
          $file.val("");
          $fileName.addClass("hidden").text("");
          markInvalid($drop);
          toastr.error(v.msg);
          // reset textos
          $drop.find(".font-semibold").text("üìÑ Seleccionar archivo");
          $drop.find(".text-gray-500").text("PDF");
          return;
        }
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(f);
        $file[0].files = dataTransfer.files;

        clearInvalid($drop);
        $fileName.removeClass("hidden").text(f.name);
        toastr.success("Documento adjuntado.");
      });

    // bot√≥n ‚Äú+ Agregar documento‚Äù
    $(document).off('click.addDoc','.add-document-btn').on('click.addDoc','.add-document-btn', function(e){
      e.preventDefault(); addCustomDocument();
    });
  });

  // badge de √°rea por querystring
  function getAreaParam(){ return new URLSearchParams(window.location.search).get("area"); }
  const area = getAreaParam();
  if(area){ document.getElementById("area-badge").textContent = "Perfil: " + area; }
  </script>
</body>
</html>
