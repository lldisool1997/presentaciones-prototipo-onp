<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Homologación SGAFCR ↔ SIGA (7 campos)</title>

  <!-- Select2 & Toastr -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet"/>

  <style>
    *{box-sizing:border-box}
    body{font-family:Segoe UI,system-ui,-apple-system,sans-serif;background:#f5f5f5;color:#2c3e50;margin:0}
    .container{max-width:1400px;margin:0 auto;padding:20px}
    .main-container{background:#fff;border-radius:14px;box-shadow:0 8px 32px rgba(0,0,0,.08);overflow:hidden}
    .header{background:linear-gradient(135deg,#005C97 0%, #004a7c 100%);color:#fff;padding:26px;text-align:center}
    .header h1{margin:0;font-weight:600}
    .content{padding:24px}

    .toolbar{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-bottom:16px}
    .btn{border:0;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}
    .btn-primary{background:linear-gradient(135deg,#3498db,#2980b9);color:#fff}
    .btn-ghost{background:#eef5fb}
    .btn-danger{background:#e74c3c;color:#fff}

    .card{background:#fff;border:1px solid #e8eef5;border-radius:12px;padding:18px;margin-bottom:18px}
    .section-title{font-weight:700;margin:0 0 12px 0;border-left:4px solid #1976d2;padding-left:10px}

    .grid{display:grid;gap:14px}
    .grid-3{grid-template-columns:repeat(3,1fr)}
    .grid-2{grid-template-columns:repeat(2,1fr)}
    label{font-size:.9rem;font-weight:600;margin-bottom:6px;display:block}
    input[type="text"], select, .select2-container--default .select2-selection--single{
      width:100%;background:#fff;border:2px solid #e6e8ec;border-radius:8px;padding:10px 12px;font-size:.95rem
    }
    input:focus, select:focus{outline:none;border-color:#3498db}

    .table-wrap{overflow:auto;border-radius:12px;border:1px solid #e8eef5}
    table{width:100%;min-width:1200px;border-collapse:collapse}
    th{background:linear-gradient(135deg,#34495e,#2c3e50);color:#fff;font-size:.8rem;padding:12px 8px;text-align:center}
    td{padding:10px 8px;border-bottom:1px solid #f0f3f7;font-size:.88rem;text-align:center}
    tr:nth-child(even){background:#f9fbfd}
    tr:hover{background:#eef6ff}
    .text-left{text-align:left}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;font-size:.75rem;font-weight:700}
    .pill.blue{background:#e8f2ff;color:#1a56db}
    .pill.teal{background:#e6fffb;color:#0d9488}
    .actions{display:flex;gap:8px;justify-content:center}
    .footer-note{font-size:.85rem;color:#556;margin-top:10px}

    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;padding:18px;z-index:10}
    .modal.open{display:flex}
    .modal-card{background:#fff;max-width:1200px;width:100%;border-radius:14px;box-shadow:0 10px 40px rgba(0,0,0,.2);overflow:hidden}
    .modal-hd{padding:16px 18px;background:#0f3d64;color:#fff;display:flex;align-items:center;justify-content:space-between}
    .modal-bd{padding:18px}

    /* Select2 muted */
    #sel_mercado + .select2-container .select2-selection--single,
    #sel_subcat  + .select2-container .select2-selection--single,
    #sel_tipo    + .select2-container .select2-selection--single,
    #f_cuenta    + .select2-container .select2-selection--single,
    #flt_mercado + .select2-container .select2-selection--single,
    #flt_grupo   + .select2-container .select2-selection--single,
    #flt_tipo    + .select2-container .select2-selection--single{
      border:1.5px solid #e5e7eb;border-radius:10px;height:42px
    }
    #sel_mercado + .select2-container .select2-selection__rendered,
    #sel_subcat  + .select2-container .select2-selection__rendered,
    #sel_tipo    + .select2-container .select2-selection__rendered,
    #f_cuenta    + .select2-container .select2-selection__rendered,
    #flt_mercado + .select2-container .select2-selection__rendered,
    #flt_grupo   + .select2-container .select2-selection__rendered,
    #flt_tipo    + .select2-container .select2-selection__rendered{
      line-height:40px;color:#374151;padding-left:12px;font-weight:500;  top: -10px; position: relative
    }
    #sel_mercado + .select2-container .select2-selection__arrow,
    #sel_subcat  + .select2-container .select2-selection__arrow,
    #sel_tipo    + .select2-container .select2-selection__arrow,
    #f_cuenta    + .select2-container .select2-selection__arrow,
    #flt_mercado + .select2-container .select2-selection__arrow,
    #flt_grupo   + .select2-container .select2-selection__arrow,
    #flt_tipo    + .select2-container .select2-selection__arrow{ top: 10px; }

    #sel_mercado + .select2-container .select2-dropdown,
    #sel_subcat  + .select2-container .select2-dropdown,
    #sel_tipo    + .select2-container .select2-dropdown,
    #f_cuenta    + .select2-container .select2-dropdown,
    #flt_mercado + .select2-container .select2-dropdown,
    #flt_grupo   + .select2-container .select2-dropdown,
    #flt_tipo    + .select2-container .select2-dropdown{
      border:1.5px solid #e5e7eb;border-radius:10px;box-shadow:0 6px 16px rgba(0,0,0,.06)
    }

    /* ===== Pagination ===== */
    .pagination{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;margin:10px 0}
    .pager-left{font-size:.9rem;color:#445}
    .pager-controls{display:flex;align-items:center;gap:8px}
    .btn-slim{border:1px solid #e2e8f0;background:#fff;border-radius:8px;padding:6px 10px;font-weight:600;cursor:pointer}
    .btn-slim[disabled]{opacity:.4;cursor:not-allowed}
    #pageSize{border:1px solid #e2e8f0;border-radius:8px;padding:6px 8px}
  </style>
</head>
<body>
  <div class="container">
    <div class="main-container">
      <div class="header">
        <h1>Listado de Homologación: Concepto vs Cta. Contable</h1>
      </div>

      <div class="content">
        <!-- ======= FILTROS ======= -->
        <div class="card" id="filtrosListado">
          <h3 class="section-title">Filtros del listado</h3>

          <div class="grid grid-3">
            <div>
              <label for="flt_concepto">Concepto</label>
              <input type="text" id="flt_concepto" placeholder="Buscar por concepto…">
            </div>
            <div>
              <label for="flt_debehaber">Debe/Haber</label>
            <select id="flt_debehaber">
            <option value="">Todos</option>
            <option>Saldo Positivo (+)</option>
            <option>Saldo Negativo (-)</option>
            <option>Ingreso (+)</option>
            <option>Ingreso (-)</option>
            <option>Diferencia por tipo de cambio (+)</option>
          </select>
            </div>
            <div>
              <label for="flt_mercado">Mercado</label>
              <select id="flt_mercado" style="width:100%"></select>
            </div>
          </div>

          <div class="grid grid-3" style="margin-top:12px">
            <div>
              <label for="flt_grupo">Subcategoría</label>
              <select id="flt_grupo" style="width:100%" disabled></select>
            </div>
            <div>
              <label for="flt_tipo">Tipo de Inversión</label>
              <select id="flt_tipo" style="width:100%" disabled></select>
            </div>
            <div>
              <label for="flt_cuenta">Cuenta contable</label>
              <input type="text" id="flt_cuenta" placeholder="Buscar por nro. de cuenta…">
            </div>
            <!--<div style="display:flex; align-items:end; gap:10px">
              <button class="btn btn-ghost" id="btnLimpiarFiltros">Limpiar</button>
            </div>-->
          </div>

          <!-- Filtros adicionales -->
          <div class="grid grid-3" style="margin-top:12px">
            
            <div>
              <label for="flt_area">Área</label>
              <select id="flt_area">
                <option value="">Todas</option>
              </select>
            </div>
            <div style="display:flex; align-items:end; gap:10px">
              <button class="btn btn-ghost" id="btnLimpiarFiltros2">Limpiar filtros</button>
            </div>
          </div>
        </div>

        <div class="toolbar">
          <button class="btn btn-primary" id="btnNuevo">+ Registrar homologación</button>
        </div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Mercado</th>
                <th>Subcategoría</th>
                <th>Tipo de Inversión</th>
                <th class="text-left">Concepto (SGAFCR)</th>
                <th>Debe/Haber</th>
                <th>Cuenta Contable</th>
                <th>Área</th>
                <th style="width:150px">Acciones</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>

        <!-- Paginación -->
        <div class="pagination">
          <div class="pager-left">
            <span id="rangeLabel">Mostrando 0–0 de 0</span>
          </div>
          <div class="pager-controls">
            <button id="pgFirst"  class="btn-slim" title="Primera">«</button>
            <button id="pgPrev"   class="btn-slim" title="Anterior">‹</button>
            <span id="pageInfo">Página 1 de 1</span>
            <button id="pgNext"   class="btn-slim" title="Siguiente">›</button>
            <button id="pgLast"   class="btn-slim" title="Última">»</button>
            <span style="margin-left:6px">/ por página</span>
            <select id="pageSize">
              <option selected>10</option>
              <option >25</option>
              <option>50</option>
              <option>100</option>
            </select>
          </div>
        </div>

        <div class="footer-note"></div>
      </div>
    </div>
  </div>

  <!-- Modal Form -->
  <div class="modal" id="modal">
    <div class="modal-card">
      <div class="modal-hd">
        <div id="modalTitle">Registrar homologación</div>
        <button class="btn btn-danger" id="btnCerrarModal">X</button>
      </div>
      <div class="modal-bd">
        <form id="form">
          <!-- 1) Clasificación: Mercado → Grupo → Tipo -->
          <div class="card">
            <h3 class="section-title">Clasificación de Inversiones</h3>
            <div class="grid grid-3">
              <div>
                <label for="sel_mercado">Mercado</label>
                <select id="sel_mercado" style="width:100%"></select>
              </div>
              <div>
                <label for="sel_subcat">Subcategoría</label>
                <select id="sel_subcat" style="width:100%" disabled></select>
              </div>
              <div>
                <label for="sel_tipo">Tipo de Inversión</label>
                <select id="sel_tipo" style="width:100%" disabled></select>
              </div>
            </div>
          </div>

          <!-- 2) Campos de homologación -->
          <div class="grid grid-3">
            <div>
              <label>Concepto (SGAFCR)</label>
              <input type="text" id="f_concepto" placeholder="Llamado de Capital, Rescate, Dividendos…" required/>
            </div>
            <div>
              <label>Debe/Haber</label>
              <select id="f_debehaber" required>
  <option value="">Seleccione…</option>
  <option>Saldo Positivo (+)</option>
  <option>Saldo Negativo (-)</option>
  <option>Ingreso (+)</option>
  <option>Ingreso (-)</option>
  <option>Diferencia por tipo de cambio (+)</option>
</select>
            </div>
            <div>
              <label>Cuenta Contable</label>
              <select id="f_cuenta" style="width:100%"></select>
            </div>
          </div>

          <div class="grid grid-2" style="margin-top:12px">
            <div>
              <label>Área encargada</label>
              <select id="f_area" required>
                <option value="">Seleccione…</option>
                <option>Tesorería</option>
                <option>Contabilidad</option>
                <option>Rebates Tesorería</option>
                <option>Rebates Contabilidad</option>
              </select>
            </div>
          </div>

          <div style="margin-top:16px;display:flex;gap:10px;justify-content:flex-end">
            <button type="button" class="btn btn-ghost" id="btnCancelar">Cancelar</button>
            <button type="submit" class="btn btn-primary" id="btnGuardar">Guardar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- JS libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

  <script>
/* ---------- JSON MOCK de 3 niveles ---------- */
const CATALOGO_INSTRUMENTOS = {
  "Local": {
    "Depósitos y Certificados en el BCRP": ["Depósito BCRP","Certificado del BCRP"],
    "Depósitos en el Sistema Financiero": ["Depósito a Plazo","Instrumento Sintético","Instrumento Estructurado","Cuenta Remunerada"],
    "Instrumentos de Corto Plazo": ["Instrumento de Corto Plazo","Papel Comercial","Pagarés","Operación de Reporte"],
    "Gobierno": ["Bono Soberano","Bono Global","Bono con Garantía de Gobierno","Bono Titulizado Gobierno"],
    "Bonos Sistema Financiero": ["Bono Corporativo","Bono Subordinado","Bono Hipotecario","Otros Sistema Financiero","Bonos de Arrendamiento Financiero"],
    "Bonos Empresas no Financieras": ["Bono Corporativo"],
    "Instrumentos Titulizados": ["Bono en Fideicomiso","Bonos Titulizados"],
    "Instrumento de Mediano Plazo y Largo Plazo": ["Instrumento de Mediano Plazo y Largo Plazo"],
    "Fondos de Renta Fija": ["Fondo Privado"],
    "Mandato": ["Mandato"],
    "Fondos Mutuos": ["Fondo Mutuo"],
    "Inversiones Inmobiliarias": ["Inmobiliarias"],
    "Fondos de Inversión": ["Fondo Privado"],

    // === Tus nombres exactos para FI local ===
    "FI: FONDOS DE INVERSION": ["FI1: FONDO PRIVADO"]
  },

  "Extranjero": {
    "Depósitos en el Sistema Financiero": ["Depósito a Plazo","Instrumento Sintético","Instrumento Estructurado","Cuenta Remunerada"],
    "Depósitos en el BCRP": ["Depósito BCRP"],
    "Instrumentos de Corto Plazo": ["Instrumento de Corto Plazo","Papel Comercial"],
    "Mandato": ["Mandato"],
    "Instrumentos de Deuda": ["Instrumento Organismos Supranacionales","Inversiones en Notas y Depósitos Estructurados"],
    "Fondos de Renta Fija": ["Fondo Mutuo","ETF","Fondo Privado"],
    "Inversión Directa en Instrumentos de Capital": ["Fondo Mutuo","ETF"],
    "Mandatos de Private Equity": ["Mandato"],
    "Inversión Directa en Private Equity": ["Fondo Privado"],
    "Fondos de Real Assets": ["Fondo Mutuo","Fondo Privado"],

    // === Tus nombres exactos para FI/IK exterior ===
    "FI: FONDO DE INVERSION": ["FIX: FONDOS DE INVERSIÓN MERCADO EXTERNO"],
    "IK: FONDOS MUTUOS MERCADO EXTERNO": ["IK1: FONDOS MUTUOS MERCADO EXTERNO"]
  },

  // === Mercado extra para EUR con tu nombre exacto ===
  "Extranjero EUR": {
    "FI: FONDO DE INVERSION": ["FIX: FONDOS DE INVERSIÓN MERCADO EXTERNO"]
  }
};

/* ---------- HOMOLOGACIÓN (Mercado + Concepto → Debe/Haber, Cuenta, Área) ---------- */
const HOMOLOGACION = {
  // ===== EXTRANJERO =====
  "Extranjero::Llamado de Capital":                { debehaber:"Saldo Positivo (+)",  cuenta:"3025203",  area:"Tesorería" },
  "Extranjero::Rescate de Capital":                { debehaber:"Saldo Negativo (-)",  cuenta:"3025203",  area:"Tesorería" },
  "Extranjero::Devolución de capital":             { debehaber:"Saldo Negativo (-)",  cuenta:"3025204",  area:"Tesorería" },
  "Extranjero::Distribución de dividendos":        { debehaber:"Ingreso (+)",         cuenta:"7731104",  area:"Tesorería" },
  "Extranjero::Perdida Distribucion de dividendos":{ debehaber:"Ingreso (-)",         cuenta:"679310104",area:"Tesorería" },
  "Extranjero::Perdida por Diferencia de cambio":  { debehaber:"Diferencia por tipo de cambio (+)", cuenta:"6767302", area:"Contabilidad" },
  "Extranjero::Ganancia por Diferencia de cambio": { debehaber:"Ingreso (+)",         cuenta:"7767302",  area:"Contabilidad" },

  // ===== LOCAL =====
  "Local::Llamado de Capital":                     { debehaber:"Saldo Positivo (+)",  cuenta:"3025202",  area:"Tesorería" },
  "Local::Rescate de Capital":                     { debehaber:"Saldo Negativo (-)",  cuenta:"3025203",  area:"Tesorería" },
  "Local::Devolución de capital":                  { debehaber:"Saldo Negativo (-)",  cuenta:"3025204",  area:"Tesorería" },
  "Local::Distribución de dividendos":             { debehaber:"Ingreso (+)",         cuenta:"7731104",  area:"Tesorería" },
  "Local::Perdida Distribucion de dividendos":     { debehaber:"Ingreso (-)",         cuenta:"679310104",area:"Tesorería" },
  "Local::Perdida por Diferencia de cambio":       { debehaber:"Diferencia por tipo de cambio (+)", cuenta:"6767301", area:"Contabilidad" },
  "Local::Ganancia por Diferencia de cambio":      { debehaber:"Ingreso (+)",         cuenta:"7767301",  area:"Contabilidad" },

  // ===== EXTRANJERO EUR =====
  "Extranjero EUR::Llamado de Capital":            { debehaber:"Saldo Positivo (+)",  cuenta:"3025204",  area:"Tesorería" },
  "Extranjero EUR::Rescate de Capital (o Retrocesión)": { debehaber:"Saldo Negativo (-)", cuenta:"3025204", area:"Tesorería" },
  "Extranjero EUR::Devolución de capital":         { debehaber:"Saldo Negativo (-)",  cuenta:"3025204",  area:"Tesorería" },
  "Extranjero EUR::Distribucion de dividendos (o dietas)": { debehaber:"Ingreso (+)", cuenta:"7731104",  area:"Tesorería" },
  "Extranjero EUR::Perdida Distribucion de dividendos": { debehaber:"Ingreso (-)",    cuenta:"679310104",area:"Tesorería" },
  "Extranjero EUR::Ganancia por Diferencia de cambio": { debehaber:"Diferencia por tipo de cambio (+)", cuenta:"7767303", area:"Contabilidad" },

  // ===== IK: INSTRUMENTOS DE CAPITAL =====
  "Extranjero::Compra":                             { debehaber:"Ingreso (+)",        cuenta:"3026203",  area:"Rebates Tesorería" },
  "Extranjero::Liquidación":                        { debehaber:"Ingreso (-)",        cuenta:"3026205",  area:"Rebates Tesorería" },
  "Extranjero::Ingreso extra (Rebates)":            { debehaber:"Ingreso (+)",        cuenta:"1682209",  area:"Rebates Tesorería" },
  "Extranjero::Estimación/Provisión: Cuenta x cobrar (Debe)":  { debehaber:"Ingreso (+)", cuenta:"7794101", area:"Rebates Contabilidad" },
  "Extranjero::Estimación/Provisión: Cuenta x cobrar (Haber)": { debehaber:"Ingreso (-)", cuenta:"7794101", area:"Rebates Contabilidad" },
  "Extranjero::Cancelación por Reinversión (Debe)":            { debehaber:"Ingreso (+)", cuenta:"10XXXX",  area:"Rebates Tesorería" },
  "Extranjero::Cancelación por Reinversión (Haber)":           { debehaber:"Ingreso (-)", cuenta:"10XXXX",  area:"Rebates Tesorería" },
  "Extranjero::Cancelación por Ingreso a Tesorería (Debe)":    { debehaber:"Ingreso (+)", cuenta:"1682209", area:"Rebates Tesorería" },
  "Extranjero::Cancelación por Ingreso a Tesorería (Haber)":   { debehaber:"Ingreso (-)", cuenta:"1682209", area:"Rebates Tesorería" }
};

/* Áreas únicas para filtro */
const AREAS = Array.from(new Set(Object.values(HOMOLOGACION).map(x => x.area))).sort();

/* ---------- Derivados ---------- */
function buildFila({ mercado, grupo, tipoCatalogo, concepto }) {
  const h = HOMOLOGACION[`${mercado}::${concepto}`];
  if (!h) return null;
  return { mercado, grupo, tipoCatalogo, concepto, debehaber: h.debehaber, cuenta: h.cuenta, area: h.area };
}

const MOCK = [
  // ===== FI: FONDO DE INVERSION — LOCAL (FI1) =====
  buildFila({ mercado:"Local", grupo:"FI: FONDOS DE INVERSION", tipoCatalogo:"FI1: FONDO PRIVADO", concepto:"Llamado de Capital" }),
  buildFila({ mercado:"Local", grupo:"FI: FONDOS DE INVERSION", tipoCatalogo:"FI1: FONDO PRIVADO", concepto:"Rescate de Capital" }),
  buildFila({ mercado:"Local", grupo:"FI: FONDOS DE INVERSION", tipoCatalogo:"FI1: FONDO PRIVADO", concepto:"Devolución de capital" }),
  buildFila({ mercado:"Local", grupo:"FI: FONDOS DE INVERSION", tipoCatalogo:"FI1: FONDO PRIVADO", concepto:"Distribución de dividendos" }),
  buildFila({ mercado:"Local", grupo:"FI: FONDOS DE INVERSION", tipoCatalogo:"FI1: FONDO PRIVADO", concepto:"Perdida Distribucion de dividendos" }),
  buildFila({ mercado:"Local", grupo:"FI: FONDOS DE INVERSION", tipoCatalogo:"FI1: FONDO PRIVADO", concepto:"Perdida por Diferencia de cambio" }),
  buildFila({ mercado:"Local", grupo:"FI: FONDOS DE INVERSION", tipoCatalogo:"FI1: FONDO PRIVADO", concepto:"Ganancia por Diferencia de cambio" }),

  // ===== FI: FONDO DE INVERSION — EXTRANJERO =====
  buildFila({ mercado:"Extranjero", grupo:"FI: FONDO DE INVERSION", tipoCatalogo:"FIX: FONDOS DE INVERSIÓN MERCADO EXTERNO", concepto:"Llamado de Capital" }),
  buildFila({ mercado:"Extranjero", grupo:"FI: FONDO DE INVERSION", tipoCatalogo:"FIX: FONDOS DE INVERSIÓN MERCADO EXTERNO", concepto:"Rescate de Capital" }),
  buildFila({ mercado:"Extranjero", grupo:"FI: FONDO DE INVERSION", tipoCatalogo:"FIX: FONDOS DE INVERSIÓN MERCADO EXTERNO", concepto:"Devolución de capital" }),
  buildFila({ mercado:"Extranjero", grupo:"FI: FONDO DE INVERSION", tipoCatalogo:"FIX: FONDOS DE INVERSIÓN MERCADO EXTERNO", concepto:"Distribución de dividendos" }),
  buildFila({ mercado:"Extranjero", grupo:"FI: FONDO DE INVERSION", tipoCatalogo:"FIX: FONDOS DE INVERSIÓN MERCADO EXTERNO", concepto:"Perdida Distribucion de dividendos" }),
  buildFila({ mercado:"Extranjero", grupo:"FI: FONDO DE INVERSION", tipoCatalogo:"FIX: FONDOS DE INVERSIÓN MERCADO EXTERNO", concepto:"Perdida por Diferencia de cambio" }),
  buildFila({ mercado:"Extranjero", grupo:"FI: FONDO DE INVERSION", tipoCatalogo:"FIX: FONDOS DE INVERSIÓN MERCADO EXTERNO", concepto:"Ganancia por Diferencia de cambio" }),

  // ===== FI: FONDO DE INVERSION — EXTRANJERO EUR =====
  buildFila({ mercado:"Extranjero EUR", grupo:"FI: FONDO DE INVERSION", tipoCatalogo:"FIX: FONDOS DE INVERSIÓN MERCADO EXTERNO", concepto:"Llamado de Capital" }),
  buildFila({ mercado:"Extranjero EUR", grupo:"FI: FONDO DE INVERSION", tipoCatalogo:"FIX: FONDOS DE INVERSIÓN MERCADO EXTERNO", concepto:"Rescate de Capital (o Retrocesión)" }),
  buildFila({ mercado:"Extranjero EUR", grupo:"FI: FONDO DE INVERSION", tipoCatalogo:"FIX: FONDOS DE INVERSIÓN MERCADO EXTERNO", concepto:"Devolución de capital" }),
  buildFila({ mercado:"Extranjero EUR", grupo:"FI: FONDO DE INVERSION", tipoCatalogo:"FIX: FONDOS DE INVERSIÓN MERCADO EXTERNO", concepto:"Distribucion de dividendos (o dietas)" }),
  buildFila({ mercado:"Extranjero EUR", grupo:"FI: FONDO DE INVERSION", tipoCatalogo:"FIX: FONDOS DE INVERSIÓN MERCADO EXTERNO", concepto:"Perdida Distribucion de dividendos" }),
  buildFila({ mercado:"Extranjero EUR", grupo:"FI: FONDO DE INVERSION", tipoCatalogo:"FIX: FONDOS DE INVERSIÓN MERCADO EXTERNO", concepto:"Perdida por Diferencia de cambio" }),
  buildFila({ mercado:"Extranjero EUR", grupo:"FI: FONDO DE INVERSION", tipoCatalogo:"FIX: FONDOS DE INVERSIÓN MERCADO EXTERNO", concepto:"Ganancia por Diferencia de cambio" }),

  // ===== IK: FONDOS MUTUOS MERCADO EXTERNO — EXTRANJERO =====
  buildFila({ mercado:"Extranjero", grupo:"IK: FONDOS MUTUOS MERCADO EXTERNO", tipoCatalogo:"IK1: FONDOS MUTUOS MERCADO EXTERNO", concepto:"Compra" }),
  buildFila({ mercado:"Extranjero", grupo:"IK: FONDOS MUTUOS MERCADO EXTERNO", tipoCatalogo:"IK1: FONDOS MUTUOS MERCADO EXTERNO", concepto:"Liquidación" }),
  buildFila({ mercado:"Extranjero", grupo:"IK: FONDOS MUTUOS MERCADO EXTERNO", tipoCatalogo:"IK1: FONDOS MUTUOS MERCADO EXTERNO", concepto:"Ingreso extra (Rebates)" }),
  buildFila({ mercado:"Extranjero", grupo:"IK: FONDOS MUTUOS MERCADO EXTERNO", tipoCatalogo:"IK1: FONDOS MUTUOS MERCADO EXTERNO", concepto:"Estimación/Provisión: Cuenta x cobrar (Debe)" }),
  buildFila({ mercado:"Extranjero", grupo:"IK: FONDOS MUTUOS MERCADO EXTERNO", tipoCatalogo:"IK1: FONDOS MUTUOS MERCADO EXTERNO", concepto:"Estimación/Provisión: Cuenta x cobrar (Haber)" }),
  buildFila({ mercado:"Extranjero", grupo:"IK: FONDOS MUTUOS MERCADO EXTERNO", tipoCatalogo:"IK1: FONDOS MUTUOS MERCADO EXTERNO", concepto:"Cancelación por Reinversión (Debe)" }),
  buildFila({ mercado:"Extranjero", grupo:"IK: FONDOS MUTUOS MERCADO EXTERNO", tipoCatalogo:"IK1: FONDOS MUTUOS MERCADO EXTERNO", concepto:"Cancelación por Reinversión (Haber)" }),
  buildFila({ mercado:"Extranjero", grupo:"IK: FONDOS MUTUOS MERCADO EXTERNO", tipoCatalogo:"IK1: FONDOS MUTUOS MERCADO EXTERNO", concepto:"Cancelación por Ingreso a Tesorería (Debe)" }),
  buildFila({ mercado:"Extranjero", grupo:"IK: FONDOS MUTUOS MERCADO EXTERNO", tipoCatalogo:"IK1: FONDOS MUTUOS MERCADO EXTERNO", concepto:"Cancelación por Ingreso a Tesorería (Haber)" })
].filter(Boolean);

const CUENTAS = Array.from(new Set(Object.values(HOMOLOGACION).map(x => x.cuenta)));

/* ---------- STATE ---------- */
const STORAGE_KEY = "homologacion_7campos_v1";
let data = [];
let editIndex = null;

/* ===== PAGINATION STATE ===== */
let pageIndex = 1;     // 1-based
let pageSize  = 10;    // default
let totalPages = 1;

/* ---------- helpers ---------- */
const toOptions = (arrOrObj) => Array.isArray(arrOrObj)
  ? arrOrObj.map(v=>({id:v,text:v}))
  : Object.keys(arrOrObj).map(k=>({id:k,text:k}));
const habilitar = ($el, enabled) => $el.prop("disabled", !enabled).trigger("change.select2");
const clearAndDisable = ($el)=>{ $el.val(null).trigger("change"); $el.prop("disabled", true); };
const debounce = (fn, ms=250) => { let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn.apply(this,args), ms); }; };

/* SIN persistencia */
function save(){ /* no-op */ }
function load(){ data = MOCK.slice(); refreshTable(); }

/* ---------- Render tabla (paginada) ---------- */
function renderTableRows(rowsPaged){
  const tbody = document.getElementById("tbody");
  tbody.innerHTML = "";
  if(!rowsPaged.length){
    tbody.innerHTML = `<tr><td colspan="8" style="color:#667">Sin resultados</td></tr>`;
    return;
  }
  rowsPaged.forEach((r)=>{
    const idx = data.indexOf(r);
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><span class="pill blue">${r.mercado}</span></td>
      <td>${r.grupo}</td>
      <td>${r.tipoCatalogo}</td>
      <td class="text-left">${r.concepto}</td>
      <td>${r.debehaber}</td>
      <td><span class="pill teal">${r.cuenta}</span></td>
      <td>${r.area}</td>
      <td class="actions">
        <button class="btn btn-ghost" onclick="onEdit(${idx})">Editar</button>
        <button class="btn btn-danger" onclick="onDelete(${idx})">Eliminar</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

/* ---------- Filtros (incluye Cuenta y Área) ---------- */
function applyFilters(){
  const qConcepto  = ($("#flt_concepto").val() || "").trim().toLowerCase();
  const qDebeHaber = $("#flt_debehaber").val() || "";
  const qMercado   = $("#flt_mercado").val() || "";
  const qGrupo     = $("#flt_grupo").val() || "";
  const qTipo      = $("#flt_tipo").val() || "";
  const qCuenta    = ($("#flt_cuenta").val() || "").trim();
  const qArea      = $("#flt_area").val() || "";

  return data.filter(r=>{
    if(qConcepto && !(`${r.concepto||""}`.toLowerCase().includes(qConcepto))) return false;
    if(qDebeHaber && r.debehaber !== qDebeHaber) return false;
    if(qMercado && r.mercado !== qMercado) return false;
    if(qGrupo && r.grupo !== qGrupo) return false;
    if(qTipo && r.tipoCatalogo !== qTipo) return false;
    if(qCuenta && !String(r.cuenta||"").includes(qCuenta)) return false;   // búsqueda por cuenta
    if(qArea && r.area !== qArea) return false;
    return true;
  });
}

/* ---------- Paginación + render ---------- */
function refreshTable(){
  const rows = applyFilters();

  totalPages = Math.max(1, Math.ceil(rows.length / pageSize));
  if(pageIndex > totalPages) pageIndex = totalPages;

  const start = (pageIndex - 1) * pageSize;
  const end   = Math.min(start + pageSize, rows.length);
  const pageRows = rows.slice(start, end);

  renderTableRows(pageRows);

  $("#rangeLabel").text(`Mostrando ${rows.length ? (start+1) : 0}–${end} de ${rows.length}`);
  $("#pageInfo").text(`Página ${pageIndex} de ${totalPages}`);
  $("#pgFirst, #pgPrev").prop("disabled", pageIndex <= 1);
  $("#pgNext, #pgLast").prop("disabled", pageIndex >= totalPages);
}

/* ---------- Modal & Select2 Init ---------- */
const modal = $("#modal");
function openModal(t){ $("#modalTitle").text(t); modal.addClass("open"); }
function closeModal(){
  modal.removeClass("open");
  $("#form")[0].reset();
  $("#sel_mercado, #sel_subcat, #sel_tipo, #f_cuenta").val(null).trigger("change");
  $("#sel_subcat, #sel_tipo").prop("disabled", true);
  editIndex = null;
}

$(document).ready(function(){
  // cuenta select2 (tags)
  $("#f_cuenta").select2({ tags:true, data: CUENTAS.map(v=>({id:v,text:v})), placeholder:"Escriba o seleccione la cuenta", width:"100%" });

  const $mercado = $("#sel_mercado");
  const $subcat  = $("#sel_subcat");
  const $tipo    = $("#sel_tipo");

  $mercado.select2({ placeholder:"Selecciona un mercado", allowClear:true, data: toOptions(CATALOGO_INSTRUMENTOS), width:"100%" });
  $subcat .select2({ placeholder:"Selecciona un grupo",   allowClear:true, width:"100%" });
  $tipo   .select2({ placeholder:"Selecciona un tipo",    allowClear:true, width:"100%" });

  $mercado.on("change", function(){
    const m = $(this).val();
    $subcat.empty().trigger("change");
    $tipo.empty().trigger("change");
    habilitar($tipo,false);
    if(!m){ habilitar($subcat,false); return; }
    $subcat.select2({ data: toOptions(CATALOGO_INSTRUMENTOS[m]), placeholder:"Selecciona un grupo", width:"100%", allowClear:true });
    $subcat.val(null).trigger("change");
    habilitar($subcat,true);
  });

  $subcat.on("change", function(){
    const m = $mercado.val(); const s = $(this).val();
    $tipo.empty().trigger("change");
    if(!m || !s){ habilitar($tipo,false); return; }
    $tipo.select2({ data: toOptions(CATALOGO_INSTRUMENTOS[m][s]), placeholder:"Selecciona un tipo", width:"100%", allowClear:true });
    $tipo.val(null).trigger("change");
    habilitar($tipo,true);
  });

  toastr.options = { positionClass:"toast-top-right", progressBar:true, timeOut:2500 };

  $("#btnNuevo").on("click", ()=>{ editIndex=null; openModal("Registrar homologación"); });
  $("#btnCerrarModal, #btnCancelar").on("click", closeModal);

  /* Submit (autocompleta por HOMOLOGACION) */
  $("#form").on("submit", (e)=>{
    e.preventDefault();
    let row = {
      mercado: $("#sel_mercado").val(),
      grupo: $("#sel_subcat").val(),
      tipoCatalogo: $("#sel_tipo").val(),
      concepto: ($("#f_concepto").val() || "").trim(),
      debehaber: $("#f_debehaber").val(),
      cuenta: $("#f_cuenta").val(),
      area: $("#f_area").val()
    };
    if(!row.mercado || !row.grupo || !row.tipoCatalogo){
      toastr.error("Completa Mercado, Grupo y Tipo de Inversión"); return;
    }
    const key = `${row.mercado}::${row.concepto}`;
    const h = HOMOLOGACION[key];
    if (h) {
      row.debehaber = h.debehaber;
      row.cuenta    = h.cuenta;
      row.area      = h.area;
      if(!$("#f_cuenta").find(`option[value="${row.cuenta}"]`).length){
        $("#f_cuenta").append(new Option(row.cuenta, row.cuenta, true, true)).trigger("change");
      }
    }
    if(editIndex===null){ data.push(row); toastr.success("Registrado correctamente"); }
    else{ data[editIndex]=row; toastr.success("Actualizado correctamente"); }
    save(); pageIndex = 1; refreshTable(); closeModal();
  });

  /* Filtros (select2 en cascada ya arriba) */
  const $fM = $("#flt_mercado");
  const $fG = $("#flt_grupo");
  const $fT = $("#flt_tipo");

  $fM.empty().append('<option></option>').select2({
    data: toOptions(CATALOGO_INSTRUMENTOS),
    placeholder: "Todos",
    allowClear: true,
    width: "100%"
  }).val(null).trigger("change");

  $fG.empty().append('<option></option>').select2({ placeholder:"Todos", allowClear:true, width:"100%" }).prop("disabled", true);
  $fT.empty().append('<option></option>').select2({ placeholder:"Todos", allowClear:true, width:"100%" }).prop("disabled", true);

  $fM.on("change", function(){
    const m = $(this).val();
    $fG.empty().append('<option></option>').val(null).trigger("change").prop("disabled", true);
    $fT.empty().append('<option></option>').val(null).trigger("change").prop("disabled", true);
    if(!m){ pageIndex=1; refreshTable(); return; }
    $fG.select2({ data: toOptions(CATALOGO_INSTRUMENTOS[m]), placeholder:"Todos", allowClear:true, width:"100%" })
       .val(null).trigger("change").prop("disabled", false);
    pageIndex=1; refreshTable();
  });

  $fG.on("change", function(){
    const m = $fM.val(), g = $(this).val();
    $fT.empty().append('<option></option>').val(null).trigger("change").prop("disabled", true);
    if(!m || !g){ pageIndex=1; refreshTable(); return; }
    $fT.select2({ data: toOptions(CATALOGO_INSTRUMENTOS[m][g]), placeholder:"Todos", allowClear:true, width:"100%" })
       .val(null).trigger("change").prop("disabled", false);
    pageIndex=1; refreshTable();
  });

  $("#flt_tipo").on("change", ()=>{ pageIndex=1; refreshTable(); });
  $("#flt_debehaber").on("change", ()=>{ pageIndex=1; refreshTable(); });
  $("#flt_concepto").on("input", debounce(()=>{ pageIndex=1; refreshTable(); }, 250));

  // Filtros nuevos
  AREAS.forEach(a => $("#flt_area").append(`<option>${a}</option>`));
  $("#flt_cuenta").on("input", debounce(()=>{ pageIndex=1; refreshTable(); }, 200));
  $("#flt_area").on("change", ()=>{ pageIndex=1; refreshTable(); });

  // Limpiar
  $("#btnLimpiarFiltros").on("click", ()=>{
    $("#flt_concepto").val(""); $("#flt_debehaber").val("");
    $fM.val(null).trigger("change");
    $fG.empty().append('<option></option>').val(null).trigger("change").prop("disabled", true);
    $fT.empty().append('<option></option>').val(null).trigger("change").prop("disabled", true);
  });
  $("#btnLimpiarFiltros2").on("click", ()=>{
    $("#flt_cuenta").val("");
    $("#flt_area").val("");
    $("#btnLimpiarFiltros").trigger("click");
    pageIndex=1; refreshTable();
  });

  // Paginación
  pageSize = parseInt($("#pageSize").val(),10) || 10;
  $("#pageSize").on("change", function(){
    pageSize = parseInt(this.value,10) || 10;
    pageIndex = 1;
    refreshTable();
  });
  $("#pgFirst").on("click", ()=>{ pageIndex=1; refreshTable(); });
  $("#pgPrev").on("click",  ()=>{ if(pageIndex>1) pageIndex--; refreshTable(); });
  $("#pgNext").on("click",  ()=>{ if(pageIndex<totalPages) pageIndex++; refreshTable(); });
  $("#pgLast").on("click",  ()=>{ pageIndex=totalPages; refreshTable(); });

  load();
});

/* ---------- CRUD ---------- */
function onEdit(i){
  const r = data[i]; editIndex = i;
  $("#sel_mercado").val(r.mercado).trigger("change");
  setTimeout(()=>{
    $("#sel_subcat").select2({ data: toOptions(CATALOGO_INSTRUMENTOS[r.mercado]), width:"100%" })
                    .prop("disabled", false).val(r.grupo).trigger("change");
    setTimeout(()=>{
      $("#sel_tipo").select2({ data: toOptions(CATALOGO_INSTRUMENTOS[r.mercado][r.grupo]), width:"100%" })
                    .prop("disabled", false).val(r.tipoCatalogo).trigger("change");
    },0);
  },0);

  $("#f_concepto").val(r.concepto);
  $("#f_debehaber").val(r.debehaber);

  if(!$("#f_cuenta").find(`option[value="${r.cuenta}"]`).length){
    $("#f_cuenta").append(new Option(r.cuenta, r.cuenta, true, true)).trigger("change");
  }else{
    $("#f_cuenta").val(r.cuenta).trigger("change");
  }
  $("#f_area").val(r.area);
  openModal("Editar homologación");
}

function onDelete(i){
  if(!confirm("¿Eliminar este registro?")) return;
  data.splice(i,1); save(); refreshTable(); toastr.warning("Registro eliminado");
}

window.onEdit = onEdit;
window.onDelete = onDelete;
  </script>
</body>
</html>
