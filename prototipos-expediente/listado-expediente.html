<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Expediente Digital ¬∑ Documentos</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand1:'#005C97',
            brand2:'#004a7c',
            ink:'#2c3e50'
          },
          boxShadow: { card:'0 8px 32px rgba(0,0,0,.08)' }
        }
      }
    }
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  
</head>
<body class="bg-white text-slate-800">
  <main class="max-w-full mx-auto p-4 md:p-6">
    <!-- Header -->
    <header class="bg-gradient-to-r from-brand1 to-brand2 text-white rounded-2xl rounded-b-none p-6">
      <h1 class="text-2xl md:text-3xl font-semibold">Expediente Digital</h1>
      <p class="opacity-90 text-sm md:text-base">Listado de documentos</p>
    </header>

    <!-- Filtros -->
    <section class="bg-white p-5">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
        <div>
          <label class="block text-sm font-semibold mb-1">Clase Activo</label>
          <select id="fClase" class="w-full rounded-xl border-2 border-gray-200 p-2.5 focus:border-brand1 focus:outline-none">
            <option value="">Todos</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-semibold mb-1">Mercado</label>
          <select id="fMercado" class="w-full rounded-xl border-2 border-gray-200 p-2.5 focus:border-brand1 focus:outline-none" disabled>
            <option value="">Todos</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-semibold mb-1">Subcategor√≠a</label>
          <select id="fSub" class="w-full rounded-xl border-2 border-gray-200 p-2.5 focus:border-brand1 focus:outline-none" disabled>
            <option value="">Todos</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-semibold mb-1">Tipo Instrumento</label>
          <select id="fTipo" class="w-full rounded-xl border-2 border-gray-200 p-2.5 focus:border-brand1 focus:outline-none" disabled>
            <option value="">Todos</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-semibold mb-1">C√≥digo de Inversi√≥n</label>
          <input id="fCodigo" value="INV-6053" type="text" placeholder="Ej: INV-0001"
                 class="w-full rounded-xl border-2 border-gray-200 p-2.5 focus:border-brand1 focus:outline-none"/>
        </div>
      </div>

      <div class="mt-5 flex gap-3">
        <button id="btnBuscar" class="px-5 py-2.5 rounded-xl bg-blue-600 hover:bg-blue-700 text-white font-bold uppercase tracking-wide shadow">
          Buscar
        </button>
        <button id="btnLimpiar" class="px-5 py-2.5 rounded-xl bg-slate-500 hover:bg-slate-600 text-white font-bold uppercase tracking-wide shadow">
          Limpiar
        </button>
      </div>
    </section>
      <section class="bg-white  pb-2 px-5">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
        <div>
          <label class="block font-semibold mb-1 text-[16px]">Expediente: ${EXPEDIENTE}</label>
            <div class="flex flex-row gap-3">
                <div class="font-semibold">Leyenda:</div>
                <div class="flex flex-row gap-2">
                    <img src="svg/close-lock.svg" alt="Ver" class="w-5 h-5 object-contain" loading="lazy" decoding="async">
                    Bloqueado
                </div>
                <div class="flex flex-row gap-2">
                    <img src="svg/open-lock.svg" alt="Ver" class="w-5 h-5 object-contain" loading="lazy" decoding="async">
                    Liberado
                </div>
            </div>
        </div>
      </div>

    </section>
        <!-- Filtros -->
    <section class="bg-white  p-5">
      <div class="grid grid-cols-1 md:grid-cols-1 lg:grid-cols-1 gap-4">
        <div>
               <div class="overflow-x-auto rounded-2xl rounded-t-none text-center justify-center flex">
        <table class="text-sm ">
          <thead class="bg-slate-800 text-white sticky top-0 text-[12px]">
            <tr>
              <th class="px-8 text-center uppercase">N¬∞ Item</th>
              <th class="px-3 text-center uppercase">Clase de Activo</th>
              <th class="px-3 text-center uppercase">Mercado</th>
              <th class="px-3 text-center uppercase">Subcategor√≠a</th>
              <th class="px-3 text-center uppercase">Tipo de Instrumento</th>
              <th class="px-3 text-center uppercase">C√≥digo de Inversi√≥n</th>
              <th class="px-3 text-center uppercase">Asociado al</th>
              <th class="px-3 text-left uppercase">Etiqueta del Documento</th>
              <th class="px-3 text-left uppercase">Nombre del Documento</th>
              <th class="px-3 text-center uppercase">Nro P√°ginas</th>
              <th class="px-3 text-center uppercase">Nro P√°gina Inicial</th>
              <th class="px-3 text-center uppercase">Nro P√°gina Final</th>
              <th class="px-8 text-center uppercase">Ver Detalle</th>
              <th class="px-3 text-center uppercase">grabar</th>
              <th class="px-3 text-center uppercase">editar</th>
              <th class="px-3 text-center uppercase">retirar<br>/eliminar</th>
              <th class="px-3 text-center uppercase">hist√≥rico</th>
              <th class="px-3 text-center uppercase">estado</th>
              <th class="px-3 text-center uppercase">Unidad Org√°nica</th>
            </tr>
          </thead>
          <tbody id="tablaBody" class="[&>tr:nth-child(even)]:bg-slate-50">
            <!-- filas -->
          </tbody>
        </table>
      </div>
        </div>
      </div>

    </section>

    <!-- Tabla -->
    <section class="bg-white rounded-2xl rounded-t-none shadow-[0_12px_24px_-12px_rgba(0,0,0,0.25)]">



      <!-- Empty state -->
      <div id="emptyState" class="hidden p-10 text-center text-slate-500">
        <div class="text-3xl mb-2">üìÑ</div>
        <p>No se encontraron resultados con los filtros actuales.</p>
      </div>

      <!-- Controles de paginaci√≥n -->
<div class="flex flex-col gap-3 px-4 pb-4">
  <div class="flex items-center justify-between flex-wrap gap-3">
    <!-- Items por p√°gina -->
    <div class="flex items-center gap-2">
      <label for="pageSize" class="text-sm text-slate-700">Items por p√°gina</label>
      <select id="pageSize" class="rounded-xl border-2 border-gray-200 py-1.5 px-3 focus:border-brand1 focus:outline-none">
        <option>5</option>
        <option>10</option>
        <option selected>15</option>
        <option>20</option>
        <option>50</option>
      </select>
    </div>

    <!-- Paginaci√≥n -->
    <nav id="pagination" class="inline-flex select-none overflow-hidden rounded-xl border border-slate-200"></nav>
  </div>
</div>
    </section>
    
    <!-- Modal Historial (Tailwind only) -->
<div id="twModalHist" class="fixed inset-0 z-[100] hidden">
  <!-- Backdrop -->
  <div data-backdrop class="absolute inset-0 bg-black/50 backdrop-blur-sm opacity-0 transition-opacity"></div>

  <!-- Panel -->
  <div class="absolute inset-0 flex items-center justify-center p-4">
   <div class="w-full max-w-6xl bg-white rounded-2xl md:rounded-3xl overflow-hidden shadow-2xl opacity-0 scale-95
            transition-all duration-150 ease-out ring-1 ring-slate-200"
     role="dialog" aria-modal="true" aria-labelledby="mh-title" aria-describedby="mh-desc">
      <!-- Header -->
      <div class="bg-gradient-to-r from-brand1 to-brand2 text-white px-5 py-3 flex items-center justify-between">
        <div>
          <h3 id="mh-title" class="text-base md:text-lg font-semibold">Historial</h3>
          <p id="mh-meta" class="opacity-90 text-xs md:text-sm"></p>
        </div>
        <button type="button" class="close-btn inline-flex items-center justify-center w-8 h-8 rounded-lg hover:bg-white/10 focus:outline-none focus:ring-2 focus:ring-white/60" aria-label="Cerrar">
          <img src="svg/close.svg" alt="Cerrar" class="w-5 h-5">
        </button>
      </div>

      <!-- Body -->
      <div class="p-4" id="mh-desc">
         <div class="grid grid-cols-1 md:grid-cols-3 gap-3 text-sm mb-3">
            Datos iniciales de la creaci√≥n del documento
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 text-sm mb-3">
          <div><span class="font-semibold">Usuario Creaci√≥n:</span> <span id="mhUsuario">‚Äî</span></div>
          <div><span class="font-semibold">Fecha Creaci√≥n:</span> <span id="mhFecha">‚Äî</span></div>
          <div><span class="font-semibold">IP Creaci√≥n:</span> <span id="mhIP">‚Äî</span></div>
        </div>

        <div class="overflow-x-auto rounded-lg ring-1 ring-slate-200">
          <table class="min-w-[1200px] w-full text-xs">
            <thead class="bg-slate-800 text-white">
              <tr>
                <th class="px-3 py-2 text-center uppercase">Fecha y Hora Mod.</th>
                <th class="px-3 py-2 text-center uppercase">Usuario</th>
                <th class="px-3 py-2 text-center uppercase">Nombre del Usuario</th>
                <th class="px-3 py-2 text-center uppercase">IP</th>
                <th class="px-3 py-2 text-center uppercase">Nombre del archivo</th>
                <th class="px-3 py-2 text-center uppercase">N¬∞ p√°ginas</th>
                <th class="px-3 py-2 text-center uppercase">p√°g. inicial</th>
                <th class="px-3 py-2 text-center uppercase">p√°g. final</th>
                <th class="px-3 py-2 text-center uppercase">Nro. orden</th>
                <th class="px-3 py-2 text-center uppercase">Ver Detalle</th>
              </tr>
            </thead>
            <tbody id="mhTbody" class="[&>tr:nth-child(even)]:bg-slate-50"></tbody>
          </table>
        </div>
      </div>

      <!-- Footer -->
      <div class="px-4 py-3 bg-slate-50 flex justify-end">
        <button type="button" class="close-btn px-4 py-2 rounded-xl bg-slate-700 text-white hover:bg-slate-800">
          Cerrar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal PDF (Tailwind only) -->
<div id="twModalPDF" class="fixed inset-0 z-[110] hidden">
  <!-- Backdrop -->
  <div data-backdrop class="absolute inset-0 bg-black/60 backdrop-blur-sm opacity-0 transition-opacity"></div>

  <!-- Panel centrado -->
  <div class="absolute inset-0 flex items-center justify-center p-4">
    <div class="w-full max-w-[1400px] bg-white rounded-2xl md:rounded-3xl overflow-hidden shadow-2xl
                opacity-0 scale-95 transition-all duration-150 ease-out ring-1 ring-slate-200"
         role="dialog" aria-modal="true" aria-labelledby="pdf-title">
      
      <!-- Barra -->
      <header class="bg-gradient-to-r from-brand1 to-brand2 text-white px-5 py-3 flex items-center justify-between">
        <h2 id="pdf-title" class="text-base md:text-lg font-semibold">Visor PDF</h2>
        <div class="flex items-center gap-2">
          <!--<a id="btnNuevaPestana"
             class="inline-flex items-center gap-2 rounded-xl bg-white/10 hover:bg-white/15 px-3 py-1.5"
             target="_blank" rel="noopener">
            <img src="svg/visor.svg" class="w-4 h-4" alt=""> Abrir
          </a>
          <a id="btnDescargar"
             class="inline-flex items-center gap-2 rounded-xl bg-white/10 hover:bg-white/15 px-3 py-1.5">
            <img src="svg/descargar.svg" class="w-4 h-4" alt=""> Descargar
          </a>-->
          <button type="button"
                  class="pdf-close inline-flex items-center justify-center w-9 h-9 rounded-lg hover:bg-white/10 focus:outline-none focus:ring-2 focus:ring-white/60"
                  aria-label="Cerrar">
            <img src="svg/close.svg" alt="Cerrar" class="w-5 h-5">
          </button>
        </div>
      </header>

      <!-- Contenedor del PDF -->
      <div class="h-[78vh]">
        <div id="pdfContainer" class="w-full h-full">
          <!-- PDFObject insertar√° aqu√≠ el visor nativo del navegador -->
        </div>
      </div>
    </div>
  </div>
</div>



  </main>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfobject/2.2.12/pdfobject.min.js"></script>
<script>
  /***********************
   *  CONFIG
   ***********************/
  const API_FILTERS_URL = '../recursos/investment-data.json'; // cambia si quieres


  // valores por defecto
const DEFAULTS = {
  clase:  'Inversiones Alternativas',
  mercado:'Local',
  sub:    'Fondos de inversi√≥n',
  tipo:   'Fondo privado'
};

// DEMO: reemplaza por tu API real si la tienes
async function fetchHistorialDocumento({ codigo, nombre }) {
  return [
    { fecha:"27/06/2025, 9:53:36 a. m.", usuario:"CYACTAYO", ip:"172.16.8.94", serie:"NOTIFICACI√ìN", tipo:"NOTIFICACI√ìN", doc:nombre||"D23-CONSTANCIA ENV√çO ELECTR√ìNICO.pdf", paginas:2, sistema:"VIC", principal:29, pfinal:30, orden:21 },
    { fecha:"27/06/2025, 9:53:20 a. m.", usuario:"CYACTAYO", ip:"172.16.8.94", serie:"NOTIFICACI√ìN", tipo:"NOTIFICACI√ìN", doc:nombre||"D23-CONSTANCIA ENV√çO ELECTR√ìNICO.pdf", paginas:2, sistema:"VIC", principal:30, pfinal:31, orden:22 },
    { fecha:"26/06/2025, 4:03:02 p. m.", usuario:"JHUANCAR", ip:"172.16.34.132", serie:"NOTIFICACI√ìN", tipo:"NOTIFICACI√ìN", doc:"CONSTANCIA ENV√çO ELECTR√ìNICO.pdf", paginas:2, sistema:"VIC", principal:32, pfinal:33, orden:23 }
  ];
}


  /***********************
   *  ESTADO
   ***********************/
  let DOCUMENTOS = [];
  let investmentData = {};
  let FILTERED = null;                        // dataset filtrado (o null)
  const STATE = { page: 1, size: 15 };        // paginaci√≥n
  const PAGE_SIZE_OPTIONS = [5, 10, 15, 20, 50];

  /***********************
   *  HELPERS
   ***********************/
  function fillSelect(select, values, includeTodos = true) {
    select.innerHTML = '';
    if (includeTodos) {
      const optAll = document.createElement('option');
      optAll.value = '';
      optAll.textContent = 'Todos';
      select.appendChild(optAll);
    }
    (values || []).forEach(v => {
      const opt = document.createElement('option');
      opt.value = v;
      opt.textContent = v;
      select.appendChild(opt);
    });
    select.disabled = !(values && values.length);
  }

  // valores por defecto

// preseleccionar en cascada
function preselectFilters({clase, mercado, sub, tipo} = {}) {
  const fClase   = document.getElementById('fClase');
  const fMercado = document.getElementById('fMercado');
  const fSub     = document.getElementById('fSub');
  const fTipo    = document.getElementById('fTipo');

  // 1) Clase
  if (clase && investmentData[clase]) {
    fClase.value = clase;
    fClase.dispatchEvent(new Event('change')); // llena mercados
  }

  // 2) Mercado
  if (mercado && fMercado.options.length) {
    fMercado.value = mercado;
    fMercado.dispatchEvent(new Event('change')); // llena subcategor√≠as
  }

  // 3) Subcategor√≠a
  if (sub && fSub.options.length) {
    fSub.value = sub;
    fSub.dispatchEvent(new Event('change')); // llena tipos
  }

  // 4) Tipo
  if (tipo && fTipo.options.length) {
    fTipo.value = tipo;
  }
}

  /***********************
   *  CARGA DE FILTROS (AJAX)
   ***********************/
  async function loadInvestmentData(AJAX_URL) {
    try {
      const data = await $.ajax({
        url: AJAX_URL,
        method: 'GET',
        dataType: 'json',
        cache: false,
        headers: { 'Accept': 'application/json' }
      });
      investmentData = data || {};
    } catch (err) {
      const parsed = err?.responseJSON ? err.responseJSON : (() => { try { return JSON.parse(err?.responseText||''); } catch { return null; } })();
      console.group('AJAX error ¬∑ loadInvestmentData');
      console.error('URL:', AJAX_URL);
      console.error('Status:', err?.status, err?.statusText);
      console.error(parsed ? parsed : (err?.responseText || '').slice(0, 800));
      console.groupEnd();

      // Fallback m√≠nimo para no romper cascada
      investmentData = { "Inversiones Alternativas": { "Local": { "Fondos de inversi√≥n": { "Fondo Privado": {} } } } };
    }
    initCascadingFilters();
  }

  function initCascadingFilters() {
    const fClase   = document.getElementById('fClase');
    const fMercado = document.getElementById('fMercado');
    const fSub     = document.getElementById('fSub');
    const fTipo    = document.getElementById('fTipo');

    fillSelect(fClase, Object.keys(investmentData));

    fClase.onchange = () => {
      const c = fClase.value;
      fillSelect(fMercado, c ? Object.keys(investmentData[c] || {}) : []);
      fillSelect(fSub, []);
      fillSelect(fTipo, []);
    };

    fMercado.onchange = () => {
      const c = fClase.value, m = fMercado.value;
      const subs = (c && m) ? Object.keys((investmentData[c] || {})[m] || {}) : [];
      fillSelect(fSub, subs);
      fillSelect(fTipo, []);
    };

    fSub.onchange = () => {
      const c = fClase.value, m = fMercado.value, s = fSub.value;
      const tipos = (c && m && s) ? Object.keys(((investmentData[c] || {})[m] || {})[s] || {}) : [];
      fillSelect(fTipo, tipos);
    };
  }

  /***********************
   *  DATA DEMO
   ***********************/
async function fetchDocumentos(){
  return [
    {
      "bloqueado": true, "orden": 1, "clase": "Inversiones Alternativas", "mercado": "Local",
      "subcat": "Fondos de inversi√≥n", "tipo": "Fondo Privado", "codigo": "INV-6053",
      "asociado": "Instrumento", "etiqueta": "Informe de Riesgos", "nombre": "informe-riesgos.pdf",
      "paginas": 8, "principal": 1, "pfinal": 8, "uo": "DIN.IF", "msj": "√âXITO", "estado": "√âXITO",
      "fecha":"26/06/2025, 4:03:02 p. m.", "usuario":"JHUANCAR", "ip":"172.16.34.132",
      "historial": [
        { "fecha":"26/06/2025, 4:03:02 p. m.", "usuario":"JSIFUENTESR", "nombreUsuario":"Josue Sifuentes", "ip":"172.16.34.132", "serie":"NOTIFICACI√ìN", "tipo":"NOTIFICACI√ìN", "doc":"informe-riesgos.pdf", "paginas":8, "sistema":"VIC", "principal":1,  "pfinal":8,  "orden":1 },
        { "fecha":"27/06/2025, 9:53:20 a. m.",  "usuario":"JSIFUENTESR", "nombreUsuario":"Josue Sifuentes", "ip":"172.16.8.94",   "serie":"NOTIFICACI√ìN", "tipo":"NOTIFICACI√ìN", "doc":"informe-riesgos.pdf", "paginas":8, "sistema":"VIC", "principal":1,  "pfinal":8,  "orden":1 }
      ]
    },
    {
      "bloqueado": false, "orden": 2, "clase": "Inversiones Alternativas", "mercado": "Local",
      "subcat": "Fondos de inversi√≥n", "tipo": "Fondo Privado", "codigo": "INV-6053",
      "asociado": "Instrumento", "etiqueta": "Informe Legal", "nombre": "informe-legal.pdf",
      "paginas": 1, "principal": 9, "pfinal": 9, "uo": "DIN.IF", "msj": "√âXITO", "estado": "√âXITO",
      "fecha":"26/06/2025, 4:03:02 p. m.", "usuario":"JHUANCAR", "ip":"172.16.34.132",
      "historial": [
        { "fecha":"26/06/2025, 4:10:12 p. m.", "usuario":"JSIFUENTESR", "nombreUsuario":"Josue Sifuentes","ip":"172.16.34.132", "serie":"NOTIFICACI√ìN", "tipo":"NOTIFICACI√ìN", "doc":"informe-legal.pdf", "paginas":1, "sistema":"VIC", "principal":9,  "pfinal":9,  "orden":2 },
        { "fecha":"27/06/2025, 9:55:10 a. m.",  "usuario":"JSIFUENTESR", "nombreUsuario":"Josue Sifuentes","ip":"172.16.8.94",   "serie":"NOTIFICACI√ìN", "tipo":"NOTIFICACI√ìN", "doc":"informe-legal.pdf", "paginas":1, "sistema":"VIC", "principal":9,  "pfinal":9,  "orden":2 }
      ]
    },
    {
      "bloqueado": false, "orden": 3, "clase": "Inversiones Alternativas", "mercado": "Local",
      "subcat": "Fondos de inversi√≥n", "tipo": "Fondo Privado", "codigo": "INV-6053",
      "asociado": "Instrumento", "etiqueta": "Acta de Comit√© de Inversiones", "nombre": "acta-de-comite-de-inversiones.pdf",
      "paginas": 2, "principal": 10, "pfinal": 11, "uo": "DIN.IF", "msj": "√âXITO", "estado": "√âXITO",
      "fecha":"26/06/2025, 4:03:02 p. m.", "usuario":"JHUANCAR", "ip":"172.16.34.132",
      "historial": [
        { "fecha":"26/06/2025, 4:15:00 p. m.", "usuario":"JSIFUENTESR", "nombreUsuario":"Josue Sifuentes", "ip":"172.16.34.132", "serie":"NOTIFICACI√ìN", "tipo":"NOTIFICACI√ìN", "doc":"acta-de-comite-de-inversiones.pdf", "paginas":2, "sistema":"VIC", "principal":10, "pfinal":11, "orden":3 },
        { "fecha":"27/06/2025, 9:57:22 a. m.",  "usuario":"JSIFUENTESR", "nombreUsuario":"Josue Sifuentes", "ip":"172.16.8.94",   "serie":"NOTIFICACI√ìN", "tipo":"NOTIFICACI√ìN", "doc":"acta-de-comite-de-inversiones.pdf", "paginas":2, "sistema":"VIC", "principal":10, "pfinal":11, "orden":3 }
      ]
    },
    {
      "bloqueado": true, "orden": 4, "clase": "Inversiones Alternativas", "mercado": "Local",
      "subcat": "Fondos de inversi√≥n", "tipo": "Fondo Privado", "codigo": "INV-6053",
      "asociado": "Instrumento", "etiqueta": "Acta de Suscripci√≥n", "nombre": "acta-de-suscripcion.pdf",
      "paginas": 5, "principal": 12, "pfinal": 16, "uo": "DIN.IF", "msj": "√âXITO", "estado": "√âXITO",
      "fecha":"26/06/2025, 4:03:02 p. m.", "usuario":"JHUANCAR", "ip":"172.16.34.132",
      "historial": [
        { "fecha":"26/06/2025, 4:20:45 p. m.", "usuario":"JSIFUENTESR", "nombreUsuario":"Josue Sifuentes", "ip":"172.16.34.132", "serie":"NOTIFICACI√ìN", "tipo":"NOTIFICACI√ìN", "doc":"acta-de-suscripcion.pdf", "paginas":5, "sistema":"VIC", "principal":12, "pfinal":16, "orden":4 },
        { "fecha":"27/06/2025, 9:59:01 a. m.",  "usuario":"JSIFUENTESR", "nombreUsuario":"Josue Sifuentes", "ip":"172.16.8.94",   "serie":"NOTIFICACI√ìN", "tipo":"NOTIFICACI√ìN", "doc":"acta-de-suscripcion.pdf", "paginas":5, "sistema":"VIC", "principal":12, "pfinal":16, "orden":4 }
      ]
    },
    {
      "bloqueado": false, "orden": 5, "clase": "Inversiones Alternativas", "mercado": "Local",
      "subcat": "Fondos de inversi√≥n", "tipo": "Fondo Privado", "codigo": "INV-6053",
      "asociado": "Llamado de Capital", "etiqueta": "Documento de notificaci√≥n del llamado", "nombre": "documento-notificacion.pdf",
      "paginas": 3, "principal": 17, "pfinal": 19, "uo": "DIN.IF", "msj": "√âXITO", "estado": "√âXITO",
      "fecha":"26/06/2025, 4:03:02 p. m.", "usuario":"JHUANCAR", "ip":"172.16.34.132",
      "historial": [
        { "fecha":"26/06/2025, 4:27:10 p. m.", "usuario":"JSIFUENTESR", "nombreUsuario":"Josue Sifuentes", "ip":"172.16.34.132", "serie":"NOTIFICACI√ìN", "tipo":"NOTIFICACI√ìN", "doc":"documento-notificacion.pdf", "paginas":3, "sistema":"VIC", "principal":17, "pfinal":19, "orden":5 },
        { "fecha":"27/06/2025, 10:02:40 a. m.", "usuario":"JSIFUENTESR", "nombreUsuario":"Josue Sifuentes","ip":"172.16.8.94",   "serie":"NOTIFICACI√ìN", "tipo":"NOTIFICACI√ìN", "doc":"documento-notificacion.pdf", "paginas":3, "sistema":"VIC", "principal":17, "pfinal":19, "orden":5 }
      ]
    },
    {
      "bloqueado": true, "orden": 6, "clase": "Inversiones Alternativas", "mercado": "Local",
      "subcat": "Fondos de inversi√≥n", "tipo": "Fondo Privado", "codigo": "INV-6053",
      "asociado": "Desagregado de Llamado de Capital", "etiqueta": "Constancia de operaci√≥n", "nombre": "constancia-operacion.pdf",
      "paginas": 7, "principal": 20, "pfinal": 26, "uo": "OAD.TE", "msj": "√âXITO", "estado": "√âXITO",
      "fecha":"26/06/2025, 4:03:02 p. m.", "usuario":"JHUANCAR", "ip":"172.16.34.132",
      "historial": [
        { "fecha":"26/06/2025, 4:35:18 p. m.", "usuario":"EGUERRERO", "nombreUsuario":"Evelyn Guerrero Paitan", "ip":"172.16.34.132", "serie":"NOTIFICACI√ìN", "tipo":"NOTIFICACI√ìN", "doc":"constancia-operacion.pdf", "paginas":7, "sistema":"VIC", "principal":20, "pfinal":26, "orden":6 },
        { "fecha":"27/06/2025, 10:05:03 a. m.", "usuario":"EGUERRERO", "nombreUsuario":"Evelyn Guerrero Paitan", "ip":"172.16.8.94",   "serie":"NOTIFICACI√ìN", "tipo":"NOTIFICACI√ìN", "doc":"constancia-operacion.pdf", "paginas":7, "sistema":"VIC", "principal":20, "pfinal":26, "orden":6 }
      ]
    },
    {
      "bloqueado": true, "orden": 7, "clase": "Inversiones Alternativas", "mercado": "Local",
      "subcat": "Fondos de inversi√≥n", "tipo": "Fondo Privado", "codigo": "INV-6053",
      "asociado": "Distribuci√≥n de Capital", "etiqueta": "Documento de notificaci√≥n de la distribuci√≥n", "nombre": "constancia-operacion.pdf",
      "paginas": 7, "principal": 20, "pfinal": 26, "uo": "DIN.IF", "msj": "√âXITO", "estado": "√âXITO",
      "fecha":"26/06/2025, 4:03:02 p. m.", "usuario":"JHUANCAR", "ip":"172.16.34.132",
      "historial": [
        { "fecha":"26/06/2025, 4:39:50 p. m.", "usuario":"JSIFUENTESR", "nombreUsuario":"Josue Sifuentes", "ip":"172.16.34.132", "serie":"NOTIFICACI√ìN", "tipo":"NOTIFICACI√ìN", "doc":"constancia-operacion.pdf", "paginas":7, "sistema":"VIC", "principal":20, "pfinal":26, "orden":6 },
        { "fecha":"27/06/2025, 10:06:18 a. m.", "usuario":"JSIFUENTESR", "nombreUsuario":"Josue Sifuentes", "ip":"172.16.8.94",   "serie":"NOTIFICACI√ìN", "tipo":"NOTIFICACI√ìN", "doc":"constancia-operacion.pdf", "paginas":7, "sistema":"VIC", "principal":20, "pfinal":26, "orden":6 }
      ]
    },
    {
      "bloqueado": true, "orden": 8, "clase": "Inversiones Alternativas", "mercado": "Local",
      "subcat": "Fondos de inversi√≥n", "tipo": "Fondo Privado", "codigo": "INV-6053",
      "asociado": "Desagregado Distribuci√≥n de Capital", "etiqueta": "Constancia de operaci√≥n", "nombre": "documento-notificacion.pdf",
      "paginas": 7, "principal": 20, "pfinal": 26, "uo": "OAD.TE", "msj": "√âXITO", "estado": "√âXITO",
      "fecha":"26/06/2025, 4:03:02 p. m.", "usuario":"JHUANCAR", "ip":"172.16.34.132",
      "historial": [
        { "fecha":"26/06/2025, 4:42:12 p. m.", "usuario":"EGUERRERO", "nombreUsuario":"Evelyn Guerrero Paitan", "ip":"172.16.34.132", "serie":"NOTIFICACI√ìN", "tipo":"NOTIFICACI√ìN", "doc":"documento-notificacion.pdf", "paginas":7, "sistema":"VIC", "principal":20, "pfinal":26, "orden":6 },
        { "fecha":"27/06/2025, 10:07:41 a. m.", "usuario":"EGUERRERO", "nombreUsuario":"Evelyn Guerrero Paitan", "ip":"172.16.8.94",   "serie":"NOTIFICACI√ìN", "tipo":"NOTIFICACI√ìN", "doc":"documento-notificacion.pdf", "paginas":7, "sistema":"VIC", "principal":20, "pfinal":26, "orden":6 }
      ]
    }
  ];
}


  /***********************
   *  RENDER TABLA
   ***********************/
  function renderTabla(list){
    const tbody = document.getElementById('tablaBody');
    const empty = document.getElementById('emptyState');
    tbody.innerHTML = '';

    if(!list.length){
      empty.classList.remove('hidden');
      return;
    }
    empty.classList.add('hidden');

    const rows = list.map(d => `
      <tr class="hover:bg-blue-50 transition">
        <td class="px-3 py-2 text-[12px]">
  <div class="flex items-center justify-center">
    <!-- √≠cono -->
    <a href="#ver-doc"
       class="inline-flex h-8 w-8 items-center justify-center rounded-lg
              text-slate-600 hover:text-blue-700
              focus:outline-none focus:ring-2 focus:ring-blue-500/60"
       title="Ver documento" aria-label="Ver documento">
      <img src="svg/lock.svg" alt="Ver" class="w-5 h-5 object-contain" loading="lazy" decoding="async">
    </a>

    <!-- n√∫mero (misma altura que el √≠cono) -->
    <a href="#ver-doc"
       class="inline-flex h-8 min-w-[2rem] items-center justify-center rounded-lg
              text-slate-600 hover:text-blue-700 leading-none
              focus:outline-none focus:ring-2 focus:ring-blue-500/60"
       title="Ver documento" aria-label="Ver documento">
      <span class="tabular-nums">${d.orden ?? ''}</span>
    </a>
  </div>
</td>

        <td class="px-3 py-2 text-[12px] text-center">${d.clase ?? ''}</td>
        <td class="px-3 py-2 text-[12px] text-center">${d.mercado ?? ''}</td>
        <td class="px-3 py-2 text-[12px] text-center">${d.subcat ?? ''}</td>
        <td class="px-3 py-2 text-[12px] text-center">${d.tipo ?? ''}</td>
        <td class="px-3 py-2 text-[12px] text-center font-semibold text-slate-700">${d.codigo ?? ''}</td>
        <td class="px-3 py-2 text-[12px] text-center">${d.asociado ?? ''}</td>
        <td class="px-3 py-2 text-[12px] text-left">${d.etiqueta ?? ''}</td>
        <td class="px-3 py-2 text-[12px] text-left">${d.nombre ?? ''}</td>
        <td class="px-3 py-2 text-[12px] text-center">${d.paginas ?? ''}</td>
        <td class="px-3 py-2 text-[12px] text-center">${d.principal ?? ''}</td>
        <td class="px-3 py-2 text-[12px] text-center">${d.pfinal ?? ''}</td>
 <td class="px-3 py-2 text-[12px] text-center">
<a href="#ver-pdf"
   data-action="pdf"
   data-title="${d.etiqueta || d.nombre || 'Documento PDF'}"
   data-nombre="${d.nombre || ''}"
   data-src="pdf/informe-riesgo.pdf"             
   data-page="${d.principal || 1}"
   class="inline-flex bg-blue-700 items-center justify-center p-1.5 rounded-lg hover:bg-blue-800 focus:outline-none focus:ring-2 focus:ring-blue-500/60"
   title="Ver PDF" aria-label="Ver PDF">
  <img src="svg/visor.svg" alt="Ver" class="w-5 h-5 object-contain" loading="lazy" decoding="async">
</a>
<a href="pdf/informe-riesgo.pdf"
   data-action="download-pdf"
   data-src="pdf/informe-riesgo.pdf"
   data-filename="Informe-de-Riesgo.pdf"
   class="inline-flex bg-blue-700 items-center justify-center p-1.5 rounded-lg
          text-slate-600 hover:text-blue-700 hover:bg-blue-800
          focus:outline-none focus:ring-2 focus:ring-blue-500/60"
   title="Descargar documento" aria-label="Descargar documento">
  <img src="svg/descargar.svg" alt="Descargar" class="w-5 h-5 object-contain" loading="lazy" decoding="async">
</a>

</td>

<td class="px-3 py-2 text-[12px] text-center">
  <a href="#grabar-doc" class="inline-flex bg-blue-700 items-center justify-center p-1.5 rounded-lg
                            text-slate-600 hover:text-blue-700 hover:bg-blue-800
                            focus:outline-none focus:ring-2 focus:ring-blue-500/60"
     title="Grabar" aria-label="Grabar">
    <img src="svg/grabar.svg" alt="Grabar" class="w-5 h-5 object-contain" loading="lazy" decoding="async">
  </a>
</td>

<td class="px-3 py-2 text-[12px] text-center">
  <a href="#editar-doc" class="inline-flex bg-blue-700 items-center justify-center p-1.5 rounded-lg
                            text-slate-600 hover:text-blue-700 hover:bg-blue-800
                            focus:outline-none focus:ring-2 focus:ring-blue-500/60"
     title="Editar" aria-label="Editar">
    <img src="svg/editar.svg" alt="Editar" class="w-5 h-5 object-contain" loading="lazy" decoding="async">
  </a>
</td>

<td class="px-3 py-2 text-[12px] text-center">
  <a href="#eliminar-doc" class="inline-flex bg-blue-700 items-center justify-center p-1.5 rounded-lg
                              text-slate-600 hover:text-blue-700 hover:bg-blue-800
                              focus:outline-none focus:ring-2 focus:ring-blue-500/60"
     title="Retirar/Eliminar" aria-label="Retirar o eliminar">
    <img src="svg/trash.svg" alt="Eliminar" class="w-5 h-5 object-contain" loading="lazy" decoding="async">
  </a>
</td>

<td class="px-3 py-2 text-[12px] text-center">
  <a href="#"
   data-action="historial"
   data-cod="${d.codigo ?? ''}"
   data-nombre="${d.nombre ?? ''}"
   data-uo="${d.uo ?? ''}"
   data-usuario-crea="${d.usuario ?? ''}" 
   data-fecha-crea="${d.fecha ?? ''}"
   data-ip-crea="${d.ip ?? ''}"
   class="inline-flex bg-blue-700 items-center justify-center p-1.5 rounded-lg hover:bg-blue-800 focus:outline-none focus:ring-2 focus:ring-blue-500/60"
   title="Hist√≥rico" aria-label="Hist√≥rico">
  <img src="svg/historico.svg" alt="Hist√≥rico" class="w-5 h-5 object-contain">
</a>

</td>

   <td class="px-3 py-2 text-[12px] text-center">${d.estado ?? ''}</td>


        <td class="px-3 py-2 text-[12px] text-center">
            <div class="p-1 border border-blue-400 bg-blue-200 rounded-lg">
                <b class="text-blue-900">${d.uo ?? ''}</b>
            </div>
            </td>
      </tr>
    `).join('');
    tbody.insertAdjacentHTML('beforeend', rows);
  }

  /***********************
   *  PAGINACI√ìN
   ***********************/
  function datasetActual(){ return FILTERED ?? DOCUMENTOS; }

  function clampPage(totalPages){
    if (STATE.page < 1) STATE.page = 1;
    if (STATE.page > totalPages) STATE.page = totalPages || 1;
  }

  function pageSlice(ds){
    const start = (STATE.page - 1) * STATE.size;
    return ds.slice(start, start + STATE.size);
  }

  function renderPagination(totalItems){
    const nav = document.getElementById('pagination');
    nav.innerHTML = '';

    const totalPages = Math.max(1, Math.ceil(totalItems / STATE.size));
    clampPage(totalPages);

    const btn = (label, page, {active=false, disabled=false}={}) => `
      <button type="button" data-page="${page}"
        class="px-3 py-1.5 ${active ? 'bg-slate-800 text-white' : 'bg-white text-slate-700'} ${disabled ? 'opacity-40 cursor-not-allowed' : 'hover:bg-slate-100'}">
        ${label}
      </button>`;

    // ¬´
    nav.insertAdjacentHTML('beforeend', btn('¬´', STATE.page - 1, {disabled: STATE.page === 1}));

    // n√∫meros con ventana [curr-1, curr, curr+1] + extremos
    const pages = [];
    const push = p => { if (!pages.includes(p) && p>=1 && p<=totalPages) pages.push(p); };
    push(1); push(STATE.page-1); push(STATE.page); push(STATE.page+1); push(totalPages);
    pages.sort((a,b)=>a-b);

    let last = 0;
    for (const p of pages) {
      if (p - last > 1) nav.insertAdjacentHTML('beforeend', `<span class="px-2 py-1.5 bg-white text-slate-400">‚Ä¶</span>`);
      nav.insertAdjacentHTML('beforeend', btn(String(p), p, {active: p===STATE.page}));
      last = p;
    }

    // ¬ª
    nav.insertAdjacentHTML('beforeend', btn('¬ª', STATE.page + 1, {disabled: STATE.page === totalPages}));

    // Delegaci√≥n de eventos
    nav.onclick = (e) => {
      const b = e.target.closest('button[data-page]');
      if (!b) return;
      const next = Number(b.dataset.page);
      if (Number.isNaN(next)) return;
      if (next < 1 || next > totalPages) return;
      STATE.page = next;
      refreshView();
    };
  }

  function refreshView(){
    const ds = datasetActual();
    const total = ds.length;
    const totalPages = Math.max(1, Math.ceil(total / STATE.size));
    clampPage(totalPages);

    // si est√° fuera de rango despu√©s de un filtro, ajusta y corta
    renderPagination(total);
    renderTabla(pageSlice(ds));

    // empty state si no hay nada
    document.getElementById('emptyState').classList.toggle('hidden', total > 0);
  }

  // Cambio de page size
  document.getElementById('pageSize').addEventListener('change', (e) => {
    const val = Number(e.target.value);
    STATE.size = PAGE_SIZE_OPTIONS.includes(val) ? val : 15;
    STATE.page = 1;
    refreshView();
  });

  /***********************
   *  FILTROS
   ***********************/
  function aplicarFiltros(){
    const fClase  = document.getElementById('fClase').value;
    const fMerc   = document.getElementById('fMercado').value;
    const fSub    = document.getElementById('fSub').value;
    const fTipo   = document.getElementById('fTipo').value;
    const fCodigo = document.getElementById('fCodigo').value.trim().toLowerCase();

    const out = DOCUMENTOS.filter(d => {
      if (fClase && d.clase !== fClase) return false;
      if (fMerc && d.mercado !== fMerc) return false;
      if (fSub && d.subcat !== fSub) return false;
      if (fTipo && d.tipo !== fTipo) return false;
      if (fCodigo && !(d.codigo||'').toLowerCase().includes(fCodigo)) return false;
      return true;
    });

    FILTERED = out.length ? out : [];
    STATE.page = 1;
    refreshView();
  }

  document.getElementById('btnBuscar').addEventListener('click', aplicarFiltros);
  document.getElementById('btnLimpiar').addEventListener('click', () => {
    document.getElementById('fClase').value = '';
    fillSelect(document.getElementById('fMercado'), []);
    fillSelect(document.getElementById('fSub'), []);
    fillSelect(document.getElementById('fTipo'), []);
    document.getElementById('fCodigo').value = '';
    FILTERED = null;
    STATE.page = 1;
    refreshView();
  });

  // Buscar con Enter
  document.getElementById('fCodigo').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') aplicarFiltros();
  });

  /***********************
   *  INIT
   ***********************/
  (async function init(){
    await loadInvestmentData("../recursos/investment.json"); // filtros
     preselectFilters(DEFAULTS);                               // ‚Üê preselecciona
    DOCUMENTOS = await fetchDocumentos();                    // data demo
    refreshView();                                           // primera carga con paginaci√≥n
  })();

  // ===== Modal helpers (Tailwind only) =====
const twModal = document.getElementById('twModalHist');
const twBackdrop = twModal.querySelector('[data-backdrop]');
const twPanel = twModal.querySelector('[role="dialog"]');

function openTwModal() {
  twModal.classList.remove('hidden');
  document.body.classList.add('overflow-hidden');
  requestAnimationFrame(() => {
    twBackdrop.classList.add('opacity-100');
    twPanel.classList.add('opacity-100','scale-100');
  });

  // focus trap + Escape
  const focusable = twModal.querySelectorAll('a,button,select,textarea,input,[tabindex]:not([tabindex="-1"])');
  const first = focusable[0], last = focusable[focusable.length - 1];
  function trap(e){
    if (e.key === 'Tab') {
      if (e.shiftKey && document.activeElement === first) { e.preventDefault(); last.focus(); }
      else if (!e.shiftKey && document.activeElement === last) { e.preventDefault(); first.focus(); }
    }
    if (e.key === 'Escape') closeTwModal();
  }
  twModal._trapHandler = trap;
  twModal.addEventListener('keydown', trap);
  setTimeout(() => (first || twPanel).focus(), 10);
}

function closeTwModal() {
  twBackdrop.classList.remove('opacity-100');
  twPanel.classList.remove('opacity-100','scale-100');
  setTimeout(() => {
    twModal.classList.add('hidden');
    document.body.classList.remove('overflow-hidden');
    if (twModal._trapHandler) twModal.removeEventListener('keydown', twModal._trapHandler);
  }, 150);
}

twModal.addEventListener('click', (e) => {
  if (e.target === twBackdrop || e.target.closest('.close-btn')) closeTwModal();
});

// Hook: abre modal desde cualquier bot√≥n con data-action="historial"
// Abrir modal usando el historial embebido en DOCUMENTOS
document.addEventListener('click', async (e) => {
  const btn = e.target.closest('[data-action="historial"]');
  if (!btn) return;

  const codigo = btn.getAttribute('data-cod') || '';
  const nombre = btn.getAttribute('data-nombre') || '';
  const uo     = btn.getAttribute('data-uo') || '';
  const usuario     = btn.getAttribute('data-usuario-crea') || '';
  const fecha     = btn.getAttribute('data-fecha-crea') || '';
  const ip     = btn.getAttribute('data-ip-crea') || '';

  // Busca el documento por c√≥digo + nombre (primero en filtrados, si no en todos)
  const ds  = datasetActual();
  let doc   = ds.find(x => (x.codigo||'') === codigo && (x.nombre||'') === nombre);
  if (!doc) doc = DOCUMENTOS.find(x => (x.codigo||'') === codigo && (x.nombre||'') === nombre);

  // Cabecera/meta
  document.getElementById('mh-title').textContent = `Historial ‚Äî ${nombre || 'Documento'}`;
  document.getElementById('mh-meta').textContent  = `C√≥digo: ${codigo} ¬∑ UO: ${uo || '‚Äî'}`;

  // Datos iniciales (si tienes esos campos en doc, √∫salos; si no, relleno b√°sico)
  document.getElementById('mhUsuario').textContent = usuario || '‚Äî';
  document.getElementById('mhFecha').textContent   = fecha   || '‚Äî';
  document.getElementById('mhIP').textContent      = ip      || '‚Äî';

  // Tabla desde doc.historial
  const rows = Array.isArray(doc?.historial) ? doc.historial : [];
  const tbody = document.getElementById('mhTbody');

  if (!rows.length) {
    tbody.innerHTML = `
      <tr>
        <td colspan="12" class="px-3 py-6 text-center text-slate-500">Sin registros de historial.</td>
      </tr>`;
  } else {
    tbody.innerHTML = rows.map(r => `
      <tr class="hover:bg-blue-50 transition">
        <td class="px-3 py-2 text-center">${r.fecha ?? ''}</td>
        <td class="px-3 py-2 text-center">${r.usuario ?? ''}</td>
        <td class="px-3 py-2 text-center">${r.nombreUsuario ?? ''}</td>
        <td class="px-3 py-2 text-center">${r.ip ?? ''}</td>
        <td class="px-3 py-2 text-left">${r.doc ?? ''}</td>
        <td class="px-3 py-2 text-center">${r.paginas ?? ''}</td>
        <td class="px-3 py-2 text-center">${r.principal ?? ''}</td>
        <td class="px-3 py-2 text-center">${r.pfinal ?? ''}</td>
        <td class="px-3 py-2 text-center">${r.orden ?? ''}</td>
        <td class="px-3 py-2 text-center">
         <a href="#ver-pdf"
   data-action="pdf"
   data-title="${r.doc }"
   data-nombre="${r.doc || ''}"
   data-src="pdf/informe-riesgo.pdf"             
   data-page="${r.principal || 1}"
   class="inline-flex bg-blue-700 items-center justify-center p-1.5 rounded-lg hover:bg-blue-800 focus:outline-none focus:ring-2 focus:ring-blue-500/60"
   title="Ver PDF" aria-label="Ver PDF">
  <img src="svg/visor.svg" alt="Ver" class="w-5 h-5 object-contain" loading="lazy" decoding="async">
</a>
        </td>
      </tr>
    `).join('');
  }

  openTwModal();
});

// ===== Modal PDF helpers (PDFObject + fallback nativo) =====
const twPdfModal    = document.getElementById('twModalPDF');
const twPdfBackdrop = twPdfModal.querySelector('[data-backdrop]');
const twPdfPanel    = twPdfModal.querySelector('[role="dialog"]');
// Puedes tener <div id="pdfContainer"> o el viejo <iframe id="pdfFrame">
const pdfContainer  = document.getElementById('pdfContainer'); // recomendado
const pdfFrame      = document.getElementById('pdfFrame');     // fallback

function openTwPdfModal() {
  twPdfModal.classList.remove('hidden');
  document.body.classList.add('overflow-hidden');
  requestAnimationFrame(() => {
    twPdfBackdrop.classList.add('opacity-100');
    twPdfPanel.classList.add('opacity-100','scale-100');
  });
  // Esc
  function trap(e){ if (e.key === 'Escape') closeTwPdfModal(); }
  twPdfModal._trapHandler = trap;
  document.addEventListener('keydown', trap);
}

function closeTwPdfModal() {
  twPdfBackdrop.classList.remove('opacity-100');
  twPdfPanel.classList.remove('opacity-100','scale-100');
  setTimeout(() => {
    twPdfModal.classList.add('hidden');
    document.body.classList.remove('overflow-hidden');
    // limpiar viewer
    if (pdfContainer) pdfContainer.innerHTML = '';
    if (pdfFrame) pdfFrame.removeAttribute('src');
    if (twPdfModal._trapHandler) document.removeEventListener('keydown', twPdfModal._trapHandler);
  }, 150);
}

twPdfModal.addEventListener('click', (e) => {
  if (e.target === twPdfBackdrop || e.target.closest('.pdf-close')) closeTwPdfModal();
});

// Abre visor usando PDFObject (y si no, visor nativo en <iframe>)
function openPdfViewer(url, { title='Visor PDF', page=1 } = {}) {
  document.getElementById('pdf-title').textContent = title;

  const abs       = new URL(url, window.location.href).href;
  const viewerUrl = `${abs}#page=${Number(page)||1}&zoom=page-width`;

  if (window.PDFObject && pdfContainer) {
    // Embebe usando visor nativo del navegador dentro del contenedor
    PDFObject.embed(viewerUrl, '#pdfContainer', {
      height: '80vh',
      fallbackLink:
        `<p class="p-4 text-sm text-slate-600">
           No se pudo mostrar el PDF aqu√≠.
           <a href="${abs}" target="_blank" rel="noopener" class="text-blue-600 underline">Abrir en otra pesta√±a</a> o descarga desde la barra superior.
         </p>`
    });
  } else if (pdfFrame) {
    // Fallback: usa el <iframe id="pdfFrame">
    pdfFrame.src = viewerUrl;
  } else {
    // √öltimo recurso: abrir nueva pesta√±a
    window.open(abs, '_blank', 'noopener');
    return;
  }

  openTwPdfModal();
}

// Delegaci√≥n: cualquier bot√≥n con data-action="pdf"
document.addEventListener('click', (e) => {
  const btn = e.target.closest('[data-action="pdf"]');
  if (!btn) return;
  e.preventDefault();

  let url = btn.getAttribute('data-src');
  if (!url) {
    const nombre = btn.getAttribute('data-nombre');
    if (nombre) url = `pdf/${encodeURIComponent(nombre)}`;
  }

  const page  = Number(btn.getAttribute('data-page') || '1') || 1;
  const title = btn.getAttribute('data-title') || 'Visor PDF';

  if (!url) {
    console.warn('openPdfViewer: no hay URL del PDF (data-src o data-nombre)');
    return;
  }
  openPdfViewer(url, { title, page });
});


// Descarga un PDF SIN abrir pesta√±a
async function downloadPdf(url, filename) {
  const abs  = new URL(url, window.location.href).href;
  const name = filename || abs.split('/').pop() || 'documento.pdf';

  // 1) http/https ‚Üí forzamos descarga con fetch + blob
  if (/^https?:/.test(abs)) {
    try {
      const res = await fetch(abs, { cache: 'no-store' });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const blob = await res.blob();
      const objectUrl = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = objectUrl;
      a.download = name;
      a.style.display = 'none';
      document.body.appendChild(a);
      a.click();
      a.remove();

      setTimeout(() => URL.revokeObjectURL(objectUrl), 1000);
      return;
    } catch (err) {
      console.warn('downloadPdf (fetch fallo, usando fallback):', err);
      // cae al fallback de abajo
    }
  }

  // 2) file:// u otros ‚Üí intentamos solo con <a download> (sin abrir nueva pesta√±a)
  const a = document.createElement('a');
  a.href = abs;
  a.setAttribute('download', name);
  a.style.display = 'none';
  document.body.appendChild(a);
  a.click();
  a.remove();
}


// Delegaci√≥n para cualquier bot√≥n con data-action="download-pdf"
document.addEventListener('click', (e) => {
  const btn = e.target.closest('[data-action="download-pdf"]');
  if (!btn) return;
  e.preventDefault();
  const url  = btn.getAttribute('data-src') || btn.getAttribute('href');
  const name = btn.getAttribute('data-filename') || '';
  if (!url) return;
  downloadPdf(url, name);
});


</script>

</body>
</html>
