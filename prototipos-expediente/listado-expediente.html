<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Expediente Digital ¬∑ Documentos</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand1:'#005C97',
            brand2:'#004a7c',
            ink:'#2c3e50'
          },
          boxShadow: { card:'0 8px 32px rgba(0,0,0,.08)' }
        }
      }
    }
  </script>
  <style>
  .collapsible{
    max-height: 0;            /* cerrado por defecto */
    opacity: 0;
    overflow: hidden;
    transition: max-height .3s ease, opacity .2s ease;
  }
  .collapsible.open{
    max-height: 2000px;       /* algo suficientemente grande */
    opacity: 1;
  }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastr@2.1.4/build/toastr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/toastr@2.1.4/build/toastr.min.js"></script>

  <link rel="stylesheet" href="https://cdn.datatables.net/2.1.5/css/dataTables.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/3.1.1/css/buttons.dataTables.min.css">
<script src="https://cdn.datatables.net/2.1.5/js/dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/3.1.1/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/3.1.1/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/3.1.1/js/buttons.print.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
<script>
  toastr.options = {
    closeButton: true,
    progressBar: true,
    newestOnTop: true,
    preventDuplicates: true,
    positionClass: "toast-top-right",
    timeOut: 3000,
    extendedTimeOut: 1500,
    showDuration: 200,
    hideDuration: 200
  };
</script>
</head>
<body class="bg-white text-slate-800">
  <main class="max-w-full mx-auto p-4 md:p-6">
    <!-- Header -->
    <header class="bg-gradient-to-r from-brand1 to-brand2 text-white rounded-2xl rounded-b-none p-6 text-center">
      <h1 class="text-2xl md:text-3xl font-semibold">Expediente Digital</h1>
      <p class="opacity-90 text-sm md:text-base">Listado de documentos</p>
    </header>

    <!-- Filtros -->
    <section class="bg-white p-5">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-4">
        <div>
          <label class="block text-sm font-semibold mb-1">Clase Activo</label>
          <select id="fClase" class="w-full rounded-xl border-2 border-gray-200 p-2.5 focus:border-brand1 focus:outline-none">
            <option value="">Todos</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-semibold mb-1">Mercado</label>
          <select id="fMercado" class="w-full rounded-xl border-2 border-gray-200 p-2.5 focus:border-brand1 focus:outline-none" disabled>
            <option value="">Todos</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-semibold mb-1">Subcategor√≠a</label>
          <select id="fSub" class="w-full rounded-xl border-2 border-gray-200 p-2.5 focus:border-brand1 focus:outline-none" disabled>
            <option value="">Todos</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-semibold mb-1">Tipo de Inversi√≥n</label>
          <select id="fTipo" class="w-full rounded-xl border-2 border-gray-200 p-2.5 focus:border-brand1 focus:outline-none" disabled>
            <option value="">Todos</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-semibold mb-1">Nombre/Descripcion</label>
          <input id="fDesc" class="w-full rounded-xl border-2 border-gray-200 p-2.5 focus:border-brand1 focus:outline-none">
        </div>
        <div>
          <label class="block text-sm font-semibold mb-1">C√≥digo de Inversi√≥n</label>
          <input id="fCodigo" type="text" placeholder="Ej: INV-0001"
                 class="w-full rounded-xl border-2 border-gray-200 p-2.5 focus:border-brand1 focus:outline-none"/>
        </div>
      </div>

      <div class="mt-5 flex gap-3">
        <button id="btnBuscar" class="px-5 py-2.5 rounded-xl bg-blue-600 hover:bg-blue-700 text-white font-bold uppercase tracking-wide shadow">
          Buscar
        </button>
        <button id="btnLimpiar" class="px-5 py-2.5 rounded-xl bg-slate-500 hover:bg-slate-600 text-white font-bold uppercase tracking-wide shadow">
          Limpiar
        </button>
      </div>
    </section>

    <section class="bg-white pb-2 px-5">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
        <div class="flex flex-row gap-4 items-center">
          <div class="font-semibold">Leyenda:</div>
          <div class="flex items-center gap-2">
            <img src="svg/close-lock.svg" alt="Bloqueado" class="w-5 h-5 object-contain" loading="lazy" decoding="async">
            Bloqueado
          </div>
          <div class="flex items-center gap-2">
            <img src="svg/open-lock.svg" alt="Liberado" class="w-5 h-5 object-contain" loading="lazy" decoding="async">
            Liberado
          </div>
        </div>
      </div>
    </section>

    <!-- Tabla Nivel 1 (Padre) -->
    <section class="bg-white p-5">
      <div class="overflow-x-auto text-center justify-center flex w-full">
        <table class="text-sm w-full">
          <!-- THEAD Nivel 1 -->
          <thead class="bg-slate-800 text-white sticky top-0 text-[12px]">
            <tr>
              <th class="px-3 py-2 text-center uppercase">N¬∞ Item</th>
              <th class="px-3 py-2 text-center uppercase">Clase de Activo</th>
              <th class="px-3 py-2 text-center uppercase">Mercado</th>
              <th class="px-3 py-2 text-center uppercase">Subcategor√≠a</th>
              <th class="px-3 py-2 text-center uppercase">Tipo de Inversi√≥n</th>
              <th class="px-3 py-2 text-center uppercase">Nombre/Descripci√≥n</th>
              <th class="px-3 py-2 text-center uppercase">C√≥digo de Inversi√≥n</th>
               <th class="px-3 py-2 text-center uppercase w-[70px]">Acciones</th>
            </tr>
          </thead>
          <tbody id="tablaBodyPadre" class="[&>tr:nth-child(odd)]:bg-slate-50">
            <!-- filas nivel 1 + slice detalle nivel 2 -->
          </tbody>
        </table>
      </div>
    </section>

    <!-- Empty state -->
    <section class="bg-white rounded-2xl rounded-t-none shadow-[0_12px_24px_-12px_rgba(0,0,0,0.25)]">
      <div id="emptyState" class="hidden p-10 text-center text-slate-500">
        <div class="text-3xl mb-2">üìÑ</div>
        <p>No se encontraron resultados con los filtros actuales.</p>
      </div>

      <!-- Controles de paginaci√≥n -->
      <div class="flex flex-col gap-3 px-4 pb-4">
        <div class="flex items-center justify-between flex-wrap gap-3">
          <!-- Items por p√°gina -->
          <div class="flex items-center gap-2">
            <label for="pageSize" class="text-sm text-slate-700">Items por p√°gina</label>
            <select id="pageSize" class="rounded-xl border-2 border-gray-200 py-1.5 px-3 focus:border-brand1 focus:outline-none">
              <option>5</option>
              <option>10</option>
              <option selected>15</option>
              <option>20</option>
              <option>50</option>
            </select>
          </div>

          <!-- Paginaci√≥n -->
          <nav id="pagination" class="inline-flex select-none overflow-hidden rounded-xl border border-slate-200"></nav>
        </div>
      </div>
    </section>
      <section class="bg-white pb-2 px-5">
      <div>
        <div class="flex flex-row gap-4 items-center">
          <div class="font-semibold">Tipo documento sustentatorio:</div>
          <div class="flex items-center gap-2">
  <span class="flex items-center gap-1">
    <span class="w-3 h-3 rounded-full bg-blue-500 border border-blue-500"></span>
    Principal
  </span>
</div>

<div class="flex items-center gap-2">
  <span class="flex items-center gap-1">
    <span class="w-3 h-3 rounded-full bg-white border border-gray-400"></span>
    Adicional
  </span>
</div>

        </div>
      </div>
    </section>

    <!-- Modal Historial (Tailwind only) -->
    <div id="twModalHist" class="fixed inset-0 z-[100] hidden">
      <!-- Backdrop -->
      <div data-backdrop class="absolute inset-0 bg-black/50 backdrop-blur-sm opacity-0 transition-opacity"></div>

      <!-- Panel -->
      <div class="absolute inset-0 flex items-center justify-center p-4">
        <div class="w-full max-w-6xl bg-white rounded-2xl md:rounded-3xl overflow-hidden shadow-2xl opacity-0 scale-95
            transition-all duration-150 ease-out ring-1 ring-slate-200"
          role="dialog" aria-modal="true" aria-labelledby="mh-title" aria-describedby="mh-desc">
          <!-- Header -->
          <div class="bg-gradient-to-r from-brand1 to-brand2 text-white px-5 py-3 flex items-center justify-between">
            <div>
              <h3 id="mh-title" class="text-base md:text-lg font-semibold">Historial</h3>
              <p id="mh-meta" class="opacity-90 text-xs md:text-sm"></p>
            </div>
            <button type="button" class="close-btn inline-flex items-center justify-center w-8 h-8 rounded-lg hover:bg-white/10 focus:outline-none focus:ring-2 focus:ring-white/60" aria-label="Cerrar">
              <img src="svg/close.svg" alt="Cerrar" class="w-5 h-5">
            </button>
          </div>

          <!-- Body -->
          <div class="p-4" id="mh-desc">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-3 text-sm mb-3">
              Datos iniciales de la creaci√≥n del documento
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-3 text-sm mb-3">
              <div><span class="font-semibold">Usuario Creaci√≥n:</span> <span id="mhUsuario">‚Äî</span></div>
              <div><span class="font-semibold">Fecha Creaci√≥n:</span> <span id="mhFecha">‚Äî</span></div>
              <div><span class="font-semibold">IP Creaci√≥n:</span> <span id="mhIP">‚Äî</span></div>
            </div>

            <div class="overflow-x-auto rounded-lg ring-1 ring-slate-200">
              <table class="min-w-[1200px] w-full text-xs">
                <thead class="bg-slate-800 text-white">
                  <tr>
                    <th class="px-3 py-2 text-center uppercase">Fecha y Hora Mod.</th>
                    <th class="px-3 py-2 text-center uppercase">Usuario</th>
                    <th class="px-3 py-2 text-center uppercase">Nombre del Usuario</th>
                    <th class="px-3 py-2 text-center uppercase">IP</th>
                    <th class="px-3 py-2 text-center uppercase">Nombre del archivo</th>
                    <th class="px-3 py-2 text-center uppercase">N¬∞ p√°ginas</th>
                    <th class="px-3 py-2 text-center uppercase">p√°g. inicial</th>
                    <th class="px-3 py-2 text-center uppercase">p√°g. final</th>
                    <th class="px-3 py-2 text-center uppercase">Nro. orden</th>
                    <th class="px-3 py-2 text-center uppercase">Ver Detalle</th>
                  </tr>
                </thead>
                <tbody id="mhTbody" class="[&>tr:nth-child(even)]:bg-slate-50"></tbody>
              </table>
            </div>
          </div>

          <!-- Footer -->
          <div class="px-4 py-3 bg-slate-50 flex justify-end">
            <button type="button" class="close-btn px-4 py-2 rounded-xl bg-slate-700 text-white hover:bg-slate-800">
              Cerrar
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal PDF (Tailwind only) -->
    <div id="twModalPDF" class="fixed inset-0 z-[110] hidden">
      <!-- Backdrop -->
      <div data-backdrop class="absolute inset-0 bg-black/60 backdrop-blur-sm opacity-0 transition-opacity"></div>

      <!-- Panel centrado -->
      <div class="absolute inset-0 flex items-center justify-center p-4">
        <div class="w-full max-w-[1400px] bg-white rounded-2xl md:rounded-3xl overflow-hidden shadow-2xl
                opacity-0 scale-95 transition-all duration-150 ease-out ring-1 ring-slate-200"
             role="dialog" aria-modal="true" aria-labelledby="pdf-title">
          <!-- Barra -->
          <header class="bg-gradient-to-r from-brand1 to-brand2 text-white px-5 py-3 flex items-center justify-between">
            <h2 id="pdf-title" class="text-base md:text-lg font-semibold">Visor PDF</h2>
            <div class="flex items-center gap-2">
              <button type="button"
                      class="pdf-close inline-flex items-center justify-center w-9 h-9 rounded-lg hover:bg-white/10 focus:outline-none focus:ring-2 focus:ring-white/60"
                      aria-label="Cerrar">
                <img src="svg/close.svg" alt="Cerrar" class="w-5 h-5">
              </button>
            </div>
          </header>

          <!-- Contenedor del PDF -->
          <div class="h-[78vh]">
            <div id="pdfContainer" class="w-full h-full"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Agregar Documento -->
<div id="twModalAddDoc" class="fixed inset-0 z-[120] hidden">
  <div data-backdrop class="absolute inset-0 bg-black/50 backdrop-blur-sm opacity-0 transition-opacity"></div>
  <div class="absolute inset-0 flex items-center justify-center p-4">
    <div class="w-full max-w-xl bg-white rounded-2xl overflow-hidden shadow-2xl opacity-0 scale-95 transition-all duration-150 ease-out ring-1 ring-slate-200"
         role="dialog" aria-modal="true" aria-labelledby="adddoc-title">
      <header class="bg-gradient-to-r from-brand1 to-brand2 text-white px-5 py-3 flex items-center justify-between">
        <h3 id="adddoc-title" class="text-base md:text-lg font-semibold">Agregar Documento</h3>
        <button type="button" class="adddoc-close inline-flex items-center justify-center w-8 h-8 rounded-lg hover:bg-white/10">
          <img src="svg/close.svg" class="w-5 h-5" alt="Cerrar">
        </button>
      </header>

      <form id="addDocForm" class="p-4 grid gap-4 text-sm">

        <input type="hidden" id="addDocGroupIndex" />
        <div class="grid grid-cols-3 gap-4 p-2.5 border border-[#1478db] rounded-lg">
  <div>
    <label class="block mb-1" for="clase-activo-modal">Clase de activo</label>
    <div class="font-semibold" id="clase-activo-modal">
      Inversiones Alternativas
    </div>
  </div>
  <div>
    <label class="block mb-1" for="mercado-modal">Mercado</label>
    <div class="font-semibold" id="mercado-modal">
      Inversiones Alternativas
    </div>
  </div>
  <div>
    <label class="block mb-1" for="subcategoria-modal">Subcategor√≠a</label>
    <div class="font-semibold" id="subcategoria-modal">
      Inversiones Alternativas
    </div>
  </div>
  <div>
    <label class="block mb-1" for="tipo-instrumento-modal">Tipo de Inversi√≥n</label>
    <div class="font-semibold" id="tipo-instrumento-modal">
      Inversiones Alternativas
    </div>
  </div>
  <div>
    <label class="block mb-1" for="nombre-modal">Nombre/Descripci√≥n</label>
    <div class="font-semibold" id="nombre-modal">
      Nombre Desc
    </div>
  </div>
  <div>
    <label class="block mb-1" for="codigo-inversion-modal">C√≥digo de Inversi√≥n</label>
    <div class="font-semibold" id="codigo-inversion-modal">
      Nombre Desc
    </div>
  </div>
</div>


        <div>
          <label class="block font-semibold mb-1">Actividad</label>
          <select id="addDocAccion" class="w-full rounded-xl border-2 border-gray-200 p-2.5 focus:border-brand1 focus:outline-none" required>
            <option value="">Seleccione‚Ä¶</option>
            <option>Registro de Inversiones Financieras</option>
            <option>Aprobar Inversi√≥n</option>
            <option>Registrar Operaci√≥n</option>
            <option>Registro de Llamado de Capital</option>
            <option>Registro de Distribuci√≥n de Capital</option>
            <option>Cancelaci√≥n de Cup√≥n</option>
          </select>
        </div>

        <div id="addNumeracionWrap">
  <label class="block font-semibold mb-1">Numeraci√≥n (Orden)</label>
  <select id="addDocOrden"
          class="w-full rounded-xl border-2 border-gray-200 p-2.5 focus:border-brand1 focus:outline-none"
          required>
    <option value="">Seleccione‚Ä¶</option>
    <option value="1">1</option>
    <option value="2">2</option>
    <option value="3">3</option>
    <option value="4">4</option>
    <option value="5">5</option>
    <option value="6">6</option>
    <option value="7">7</option>
    <option value="8">8</option>
    <option value="9">9</option>
    <option value="10">10</option>
  </select>
</div>

        <div>
          <label class="block font-semibold mb-1">Etiqueta</label>
         <input id="addEtiqueta" type="text" class="w-full rounded-xl border-2 border-gray-200 p-2.5 focus:border-brand1 focus:outline-none" required>
        </div>





        <div>
          <label class="block font-semibold mb-1">Documento (PDF)</label>
          <div class="flex items-center gap-3">
            <input id="addDocFile" type="file" accept="application/pdf" class="hidden" />
            <button type="button" id="btnPickFile"
              class="inline-flex items-center gap-2 px-3 py-2 rounded-xl border-2 border-dashed border-slate-300 hover:bg-slate-50">
              <img src="svg/upload.svg" class="w-5 h-5" alt="Subir"> Subir archivo
            </button>
            <span id="addDocFileName" class="text-slate-600 text-xs">Ning√∫n archivo seleccionado</span>
          </div>
        </div>

        <div class="flex justify-end gap-2 pt-2">
          <button type="button" class="adddoc-close px-4 py-2 rounded-xl bg-slate-200 hover:bg-slate-300">Cancelar</button>
          <button type="submit" class="px-4 py-2 rounded-xl bg-blue-600 text-white hover:bg-blue-700">Guardar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal Detalle Notificaci√≥n -->
<div id="twModalNotif" class="fixed inset-0 z-[115] hidden">
  <div data-backdrop class="absolute inset-0 bg-black/50 backdrop-blur-sm opacity-0 transition-opacity"></div>
  <div class="absolute inset-0 flex items-center justify-center p-4">
    <div class="w-full max-w-4xl bg-white rounded-2xl overflow-hidden shadow-2xl opacity-0 scale-95 transition-all duration-150 ease-out ring-1 ring-slate-200"
         role="dialog" aria-modal="true" aria-labelledby="ntf-title">
      <header class="bg-gradient-to-r from-brand1 to-brand2 text-white px-5 py-3 flex items-center justify-between">
        <div>
          <h3 id="ntf-title" class="text-base md:text-lg font-semibold">Detalle de notificaci√≥n</h3>
          <p id="ntf-meta" class="opacity-90 text-xs md:text-sm"></p>
        </div>
        <button type="button" class="ntf-close inline-flex items-center justify-center w-8 h-8 rounded-lg hover:bg-white/10">
          <img src="svg/close.svg" class="w-5 h-5" alt="Cerrar">
        </button>
      </header>

      <div class="p-4">
        <div class="overflow-x-auto rounded-lg ring-1 ring-slate-200">
          <table class="min-w-[900px] w-full text-xs">
            <thead id="ntfThead" class="bg-slate-800 text-white">
              <tr>
                <th class="px-3 py-2 text-center uppercase">Usuario</th>
                <th class="px-3 py-2 text-center uppercase">Nombre</th>
                <th class="px-3 py-2 text-center uppercase">UO</th>
                <th class="px-3 py-2 text-center uppercase">Fecha y hora lectura</th>
              </tr>
            </thead>
            <tbody id="ntfTbody" class="[&>tr:nth-child(even)]:bg-slate-50"></tbody>
          </table>
        </div>
      </div>

      <div class="px-4 py-3 bg-slate-50 flex justify-end">
        <button type="button" class="ntf-close px-4 py-2 rounded-xl bg-slate-700 text-white hover:bg-slate-800">Cerrar</button>
      </div>
    </div>
  </div>
</div>


  </main>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfobject/2.2.12/pdfobject.min.js"></script>
  <script>
  /***********************
   *  CONFIG (cascada filtros)
   ***********************/
  const FILTERS_URL = '../recursos/investment.json';

  const DEFAULTS = {
    clase:  'Inversiones Alternativas',
    mercado:'Local',
    sub:    'Fondos de inversi√≥n',
    tipo:   'Fondo privado'
  };

  /***********************
   *  ESTADO
   ***********************/
  let GROUPS = [];              // ‚Üê ahora el JSON ya viene agrupado (nivel 1)
  let investmentData = {};
  let FILTERED = null;          // dataset filtrado de grupos
  const STATE = { page: 1, size: 15 };        // paginaci√≥n por grupos
  const PAGE_SIZE_OPTIONS = [5, 10, 15, 20, 50];

  //JSON AJAX XD
  // URL del JSON externo (ajusta la ruta seg√∫n tu proyecto)
const GROUPS_URL = 'recursos/documents.json';
function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

  /***********************
   *  HELPERS: selects y preselect
   ***********************/
  function fillSelect(select, values, includeTodos = true) {
    select.innerHTML = '';
    if (includeTodos) {
      const optAll = document.createElement('option');
      optAll.value = '';
      optAll.textContent = 'Todos';
      select.appendChild(optAll);
    }
    (values || []).forEach(v => {
      const opt = document.createElement('option');
      opt.value = v;
      opt.textContent = v;
      select.appendChild(opt);
    });
    select.disabled = !(values && values.length);
  }

  function preselectFilters({clase, mercado, sub, tipo} = {}) {
    const fClase   = document.getElementById('fClase');
    const fMercado = document.getElementById('fMercado');
    const fSub     = document.getElementById('fSub');
    const fTipo    = document.getElementById('fTipo');

    if (clase && investmentData[clase]) {
      fClase.value = clase;
      fClase.dispatchEvent(new Event('change'));
    }
    if (mercado && fMercado.options.length) {
      fMercado.value = mercado;
      fMercado.dispatchEvent(new Event('change'));
    }
    if (sub && fSub.options.length) {
      fSub.value = sub;
      fSub.dispatchEvent(new Event('change'));
    }
    if (tipo && fTipo.options.length) {
      fTipo.value = tipo;
    }
  }

  /***********************
   *  CARGA DE FILTROS (AJAX)
   ***********************/
  async function loadInvestmentData(AJAX_URL) {
    try {
      const data = await $.ajax({
        url: AJAX_URL,
        method: 'GET',
        dataType: 'json',
        cache: false,
        headers: { 'Accept': 'application/json' }
      });
      investmentData = data || {};
    } catch (err) {
      const parsed = err?.responseJSON ? err.responseJSON : (() => { try { return JSON.parse(err?.responseText||''); } catch { return null; } })();
      console.group('AJAX error ¬∑ loadInvestmentData');
      console.error('URL:', AJAX_URL);
      console.error('Status:', err?.status, err?.statusText);
      console.error(parsed ? parsed : (err?.responseText || '').slice(0, 800));
      console.groupEnd();

      // Fallback m√≠nimo para no romper cascada
      investmentData = { "Inversiones Alternativas": { "Local": { "Fondos de inversi√≥n": { "Fondo Privado": {} } } } };
    }
    initCascadingFilters();
  }

  function initCascadingFilters() {
    const fClase   = document.getElementById('fClase');
    const fMercado = document.getElementById('fMercado');
    const fSub     = document.getElementById('fSub');
    const fTipo    = document.getElementById('fTipo');

    fillSelect(fClase, Object.keys(investmentData));

    fClase.onchange = () => {
      const c = fClase.value;
      fillSelect(fMercado, c ? Object.keys(investmentData[c] || {}) : []);
      fillSelect(fSub, []);
      fillSelect(fTipo, []);
    };

    fMercado.onchange = () => {
      const c = fClase.value, m = fMercado.value;
      const subs = (c && m) ? Object.keys((investmentData[c] || {})[m] || {}) : [];
      fillSelect(fSub, subs);
      fillSelect(fTipo, []);
    };

    fSub.onchange = () => {
      const c = fClase.value, m = fMercado.value, s = fSub.value;
      const tipos = (c && m && s) ? Object.keys(((investmentData[c] || {})[m] || {})[s] || {}) : [];
      fillSelect(fTipo, tipos);
    };
  }

  /***********************
   *  JSON DEMO (3 niveles: Grupo ‚Üí Items ‚Üí Historial)
   *  Nivel 1 (grupo): { clase, mercado, subcat, tipo, codigo, items:[...] }
   *  Nivel 2 (item):  { fecha, asociado, etiqueta, nombre, paginas, principal, pfinal, uo, bloqueado, usuario, ip, historial:[...] }
   *  Nivel 3 (historial): array de movimientos del item.
   ***********************/
  async function fetchGrupos(){
    return [
     { 
        "clase": "Inversiones Alternativas",
        "mercado": "Local",
        "subcat": "Fondos de inversi√≥n",
        "tipo": "Fondo Privado",
        "codigo": "INV-6053",
        "items": [
          {
            "bloqueado": true, "orden": 1,
            "fecha":"22/09/2025, 4:03:02 p. m.",
            "asociado": "Registro de Inversiones Financieras",
            "etiqueta": "Informe de Riesgos",
            "nombre": "informe-riesgo.pdf",
            "paginas": 8, "principal": 1, "pfinal": 8,
            "uo": "DIN.IF", "usuario":"JHUANCAR", "ip":"172.16.34.132",
            "historial": [
              { "fecha":"26/06/2025, 4:03:02 p. m.", "usuario":"JSIFUENTESR", "nombreUsuario":"Josue Sifuentes", "ip":"172.16.34.132", "doc":"informe-riesgo.pdf", "paginas":8, "principal":1,  "pfinal":8,  "orden":1 },
              { "fecha":"27/06/2025, 9:53:20 a. m.",  "usuario":"JSIFUENTESR", "nombreUsuario":"Josue Sifuentes", "ip":"172.16.8.94",   "doc":"informe-riesgo.pdf", "paginas":8, "principal":1,  "pfinal":8,  "orden":1 }
            ]
          },
          {
            "bloqueado": false, "orden": 2,
            "fecha":"22/09/2025, 4:03:02 p. m.",
            "asociado": "Registro de Inversiones Financieras",
            "etiqueta": "Informe Legal",
            "nombre": "informe-legal.pdf",
            "paginas": 1, "principal": 9, "pfinal": 9,
            "uo": "DIN.IF", "usuario":"JHUANCAR", "ip":"172.16.34.132",
            "historial": [
              { "fecha":"26/06/2025, 4:10:12 p. m.", "usuario":"JSIFUENTESR", "nombreUsuario":"Josue Sifuentes", "ip":"172.16.34.132", "doc":"informe-legal.pdf", "paginas":1, "principal":9,  "pfinal":9,  "orden":2 },
              { "fecha":"27/06/2025, 9:55:10 a. m.",  "usuario":"JSIFUENTESR", "nombreUsuario":"Josue Sifuentes", "ip":"172.16.8.94",   "doc":"informe-legal.pdf", "paginas":1, "principal":9,  "pfinal":9,  "orden":2 }
            ]
          },
          {
            "bloqueado": false, "orden": 3,
            "fecha":"22/09/2025, 4:03:02 p. m.",
            "asociado": "Registro de Inversiones Financieras",
            "etiqueta": "Acta de Comit√© de Inversiones",
            "nombre": "acta-de-comite-de-inversiones.pdf",
            "paginas": 2, "principal": 10, "pfinal": 11,
            "uo": "DIN.IF", "usuario":"JHUANCAR", "ip":"172.16.34.132",
            "historial": [
              { "fecha":"26/06/2025, 4:15:00 p. m.", "usuario":"JSIFUENTESR","nombreUsuario":"Josue Sifuentes","ip":"172.16.34.132","doc":"acta-de-comite-de-inversiones.pdf","paginas":2,"principal":10,"pfinal":11,"orden":3 },
              { "fecha":"27/06/2025, 9:57:22 a. m.",  "usuario":"JSIFUENTESR","nombreUsuario":"Josue Sifuentes","ip":"172.16.8.94","doc":"acta-de-comite-de-inversiones.pdf","paginas":2,"principal":10,"pfinal":11,"orden":3 }
            ]
          },
          {
            "bloqueado": true, "orden": 4,
            "fecha":"22/09/2025, 4:03:02 p. m.",
            "asociado": "Registro de Inversiones Financieras",
            "etiqueta": "Acta de Suscripci√≥n",
            "nombre": "acta-de-suscripcion.pdf",
            "paginas": 5, "principal": 12, "pfinal": 16,
            "uo": "DIN.IF", "usuario":"JHUANCAR", "ip":"172.16.34.132",
            "historial": [
              { "fecha":"26/06/2025, 4:20:45 p. m.", "usuario":"JSIFUENTESR","nombreUsuario":"Josue Sifuentes","ip":"172.16.34.132","doc":"acta-de-suscripcion.pdf","paginas":5,"principal":12,"pfinal":16,"orden":4 },
              { "fecha":"27/06/2025, 9:59:01 a. m.",  "usuario":"JSIFUENTESR","nombreUsuario":"Josue Sifuentes","ip":"172.16.8.94","doc":"acta-de-suscripcion.pdf","paginas":5,"principal":12,"pfinal":16,"orden":4 }
            ]
          },
          {
            "bloqueado": false, "orden": 5,
            "fecha":"22/09/2025, 4:03:02 p. m.",
            "asociado": "Registro de Llamado de Capital",
            "etiqueta": "Documento de notificaci√≥n del llamado",
            "nombre": "documento-notificacion.pdf",
            "paginas": 3, "principal": 17, "pfinal": 19,
            "uo": "DIN.IF", "usuario":"JHUANCAR", "ip":"172.16.34.132",
            "historial": [
              { "fecha":"26/06/2025, 4:27:10 p. m.", "usuario":"JSIFUENTESR","nombreUsuario":"Josue Sifuentes","ip":"172.16.34.132","doc":"documento-notificacion.pdf","paginas":3,"principal":17,"pfinal":19,"orden":5 },
              { "fecha":"27/06/2025, 10:02:40 a. m.","usuario":"JSIFUENTESR","nombreUsuario":"Josue Sifuentes","ip":"172.16.8.94","doc":"documento-notificacion.pdf","paginas":3,"principal":17,"pfinal":19,"orden":5 }
            ]
          },
          {
            "bloqueado": true, "orden": 6,
            "fecha":"22/09/2025, 4:03:02 p. m.",
            "asociado": "Registrar Operaci√≥n",
            "etiqueta": "Constancia de operaci√≥n",
            "nombre": "constancia-operacion.pdf",
            "paginas": 7, "principal": 20, "pfinal": 26,
            "uo": "OAD.TE", "usuario":"JHUANCAR", "ip":"172.16.34.132",
            "historial": [
              { "fecha":"26/06/2025, 4:35:18 p. m.", "usuario":"EGUERRERO","nombreUsuario":"Evelyn Guerrero Paitan","ip":"172.16.34.132","doc":"constancia-operacion.pdf","paginas":7,"principal":20,"pfinal":26,"orden":6 },
              { "fecha":"27/06/2025, 10:05:03 a. m.","usuario":"EGUERRERO","nombreUsuario":"Evelyn Guerrero Paitan","ip":"172.16.8.94","doc":"constancia-operacion.pdf","paginas":7,"principal":20,"pfinal":26,"orden":6 }
            ]
          },
          {
            "bloqueado": true, "orden": 7,
            "fecha":"22/09/2025, 4:03:02 p. m.",
            "asociado": "Registro de Distribuci√≥n de Capital",
            "etiqueta": "Documento de notificaci√≥n de la distribuci√≥n",
            "nombre": "documento-notificacion.pdf",
            "paginas": 7, "principal": 20, "pfinal": 26,
            "uo": "DIN.IF", "usuario":"JHUANCAR", "ip":"172.16.34.132",
            "historial": [
              { "fecha":"26/06/2025, 4:39:50 p. m.","usuario":"JSIFUENTESR","nombreUsuario":"Josue Sifuentes","ip":"172.16.34.132","doc":"constancia-operacion.pdf","paginas":7,"principal":20,"pfinal":26,"orden":6 },
              { "fecha":"27/06/2025, 10:06:18 a. m.","usuario":"JSIFUENTESR","nombreUsuario":"Josue Sifuentes","ip":"172.16.8.94","doc":"constancia-operacion.pdf","paginas":7,"principal":20,"pfinal":26,"orden":6 }
            ]
          },
          {
            "bloqueado": true, "orden": 8,
            "fecha":"22/09/2025, 4:03:02 p. m.",
            "asociado": "Registrar Operaci√≥n",
            "etiqueta": "Constancia de operaci√≥n",
            "nombre": "documento-notificacion.pdf",
            "paginas": 7, "principal": 20, "pfinal": 26,
            "uo": "OAD.TE", "usuario":"JHUANCAR", "ip":"172.16.34.132",
            "historial": [
              { "fecha":"26/06/2025, 4:42:12 p. m.", "usuario":"EGUERRERO","nombreUsuario":"Evelyn Guerrero Paitan","ip":"172.16.34.132","doc":"documento-notificacion.pdf","paginas":7,"principal":20,"pfinal":26,"orden":6 },
              { "fecha":"27/06/2025, 10:07:41 a. m.","usuario":"EGUERRERO","nombreUsuario":"Evelyn Guerrero Paitan","ip":"172.16.8.94","doc":"documento-notificacion.pdf","paginas":7,"principal":20,"pfinal":26,"orden":6 }
            ]
          }
        ]
      }
   
    ];
  }

  function showTableLoading() {
  const tbody = document.getElementById('tablaBodyPadre');
  const skeleton = `
    <tr>
      <td colspan="8" class="p-0">
        <div class="w-full">
          ${Array.from({length: 3}).map(() => `
            <div class="animate-pulse border-b border-slate-200">
              <div class="grid grid-cols-6 gap-3 px-4 py-3">
                <div class="h-6 rounded bg-slate-200"></div>
                <div class="h-6 rounded bg-slate-200"></div>
                <div class="h-6 rounded bg-slate-200"></div>
                <div class="h-6 rounded bg-slate-200"></div>
                <div class="h-6 rounded bg-slate-200"></div>
                <div class="h-6 rounded bg-slate-200"></div>
              </div>
            </div>
          `).join('')}
        </div>
      </td>
    </tr>
  `;
  tbody.innerHTML = skeleton;
}

function clearTableLoading() {
  // no-op: el render real reemplaza todo el tbody
}

// Carga por AJAX con fallback y cache-busting
async function loadGruposAjax(url) {
  showTableLoading();
  try {
    const data = await $.ajax({
      url: url + (url.includes('?') ? '&' : '?') + '_=' + Date.now(), // cache-bust
      method: 'GET',
      dataType: 'json',
      cache: false,
      headers: { 'Accept': 'application/json' },
      timeout: 15000
    });

    if (!Array.isArray(data)) {
      console.warn('grupos.json no es un array; se devolver√° []');
      return [];
    }
    return data;
  } catch (err) {
    console.group('AJAX error ¬∑ loadGruposAjax');
    console.error('URL:', url);
    console.error('Status:', err?.status, err?.statusText);
    console.error(err?.responseText?.slice(0, 800) || err);
    console.groupEnd();

    // Muestra error en la tabla (bonito y sin romper)
    const tbody = document.getElementById('tablaBodyPadre');
    tbody.innerHTML = `
      <tr>
        <td colspan="6" class="px-4 py-6 text-center">
          <div class="inline-flex items-center gap-2 rounded-xl bg-red-50 text-red-700 border border-red-200 px-3 py-2">
            <span>‚ö†Ô∏è</span>
            <span>No se pudo cargar el listado. Intenta nuevamente.</span>
          </div>
        </td>
      </tr>`;
    return [];
  } finally {
    clearTableLoading();
  }
}

  /***********************
   *  RENDER (Nivel 1 con slice ‚Üí tabla Nivel 2)
   ***********************/
function renderNivel1(groups){
  const tbody = document.getElementById('tablaBodyPadre');
  const empty = document.getElementById('emptyState');
  tbody.innerHTML = '';

  if(!groups.length){
    empty.classList.remove('hidden');
    return;
  }
  empty.classList.add('hidden');

  const rows = groups.map((g, idx) => {
    const rowPadre = `
      <tr class="group-row hover:bg-blue-50 transition" data-group-idx="${idx}">
                <td class="px-3 py-2 text-[12px] text-center">
          <div class="flex items-center justify-center gap-2">
            <img src="svg/open-lock.svg" alt="Orden" class="w-4 h-4">
            <span>${g.orden || ''}</span>
          </div>
        </td>
        <td class="px-3 py-2 text-[12px] text-center">${g.clase || ''}</td>
        <td class="px-3 py-2 text-[12px] text-center">${g.mercado || ''}</td>
        <td class="px-3 py-2 text-[12px] text-center">${g.subcat || ''}</td>
        <td class="px-3 py-2 text-[12px] text-center">${g.tipo || ''}</td>
        <td class="px-3 py-2 text-[12px] text-center">${g.descripcion || ''}</td>
        <td class="px-3 py-2 text-[12px] text-center font-semibold">${g.codigo || ''}</td>
                <td class="px-3 py-2 text-[12px] text-center">
          <div class="flex flex-row gap-1 ">
            <button class="btn-toggle-items inline-flex items-center justify-center px-2 py-1 rounded-lg border border-slate-300 bg-white hover:bg-slate-100 text-[11px] font-semibold text-blue-700"
                    aria-expanded="false" title="Mostrar Documentos">
              Documentos Sustentatorios
            </button>
            <button class="btn-toggle-acciones inline-flex items-center justify-center px-2 py-1 rounded-lg border border-slate-300 bg-white hover:bg-slate-100 text-[11px] font-semibold text-green-700"
                    aria-expanded="false" title="Mostrar Acciones">
              Historial de Actividades

          </div>
        </td>
      </tr>`;

    // tabla de items (documentos)
    const detalleHeadItems = `
      <thead class="bg-slate-700 text-white text-[12px]">
        <tr>
          <th class="px-3 py-2 text-center uppercase">N¬∞ Item</th>
          <th class="px-3 py-2 text-center uppercase">Fecha y Hora</th>
          <th class="px-8 py-2 text-center uppercase">Actividad</th>
          <th class="px-8 py-2 text-center uppercase">#</th>
          <th class="px-3 py-2 text-left uppercase">Etiqueta del Documento</th>
          <th class="px-3 py-2 text-left uppercase">Nombre del Documento</th>
          <th class="text-center py-2 uppercase">Nro Pag</th>
          <th class="text-center py-2 uppercase">Nro Pag Ini.</th>
          <th class="text-center py-2 uppercase">Nro Pag Fin.</th>
          <th class="px-8 py-2 text-center uppercase">Ver Detalle</th>
          <th class="px-3 py-2 text-center uppercase">editar</th>
          <th class="px-3 py-2 text-center uppercase">hist√≥rico</th>
          <th class="px-3 py-2 text-center uppercase">Unidad Org√°nica</th>
        </tr>
      </thead>`;

      const detalleBodyItems = (g.items || []).map(d => `
        <tr class="hover:bg-blue-50 transition">
                   <td class="px-3 py-2 text-[12px] text-center">
  <div class="flex items-center justify-center gap-2">
    <img src="svg/open-lock.svg" alt="Orden" class="w-4 h-4">
    <span class="
      ${d.tipo_doc_sus === 'Principal' 
        ? 'bg-blue-600 text-white rounded-full px-2 py-0.5' 
        : ''}">
      ${d.orden || ''}
    </span>
  </div>
</td>

          <td class="px-3 py-2 text-[12px] text-center">${d.fecha ?? ''}</td>
          <td class="px-3 py-2 text-[12px] text-center">${d.asociado ?? ''}</td>
          <td class="px-3 py-2 text-[12px] text-center">${d.numeracion_doc ?? ''}</td>
          <td class="px-3 py-2 text-[12px] text-left">${d.etiqueta ?? ''}</td>
          <td class="px-3 py-2 text-[12px] text-left">${d.nombre ?? ''}</td>
          <td class="px-3 py-2 text-[12px] text-center">${d.paginas ?? ''}</td>
          <td class="px-3 py-2 text-[12px] text-center">${d.principal ?? ''}</td>
          <td class="px-3 py-2 text-[12px] text-center">${d.pfinal ?? ''}</td>

          <td class="px-3 py-2 text-[12px] text-center">
            <a href="#ver-pdf"
               data-action="pdf"
               data-title="${d.etiqueta || d.nombre || 'Documento PDF'}"
               data-nombre="${d.nombre || ''}"
               data-src="pdf/${encodeURIComponent(d.nombre || 'documento.pdf')}"
               data-page="${d.principal || 1}"
               class="inline-flex bg-blue-700 items-center justify-center p-1.5 rounded-lg hover:bg-blue-800 focus:outline-none focus:ring-2 focus:ring-blue-500/60"
               title="Ver PDF" aria-label="Ver PDF">
              <img src="svg/visor.svg" class="w-5 h-5" alt="">
            </a>
            <a href="pdf/${encodeURIComponent(d.nombre || 'documento.pdf')}"
               data-action="download-pdf"
               data-src="pdf/${encodeURIComponent(d.nombre || 'documento.pdf')}"
               data-filename="${(d.etiqueta||'Documento')}.pdf"
               class="inline-flex bg-blue-700 items-center justify-center p-1.5 rounded-lg hover:bg-blue-800 focus:outline-none focus:ring-2 focus:ring-blue-500/60"
               title="Descargar" aria-label="Descargar">
              <img src="svg/descargar.svg" class="w-5 h-5" alt="">
            </a>
          </td>

          <td class="px-3 py-2 text-[12px] text-center">
            <a href="#editar-doc" class="inline-flex bg-blue-700 items-center justify-center p-1.5 rounded-lg hover:bg-blue-800 focus:outline-none focus:ring-2 focus:ring-blue-500/60" title="Editar" aria-label="Editar">
              <img src="svg/editar.svg" class="w-5 h-5" alt="">
            </a>
          </td>

          <td class="px-3 py-2 text-[12px] text-center">
            <a href="#"
               data-action="historial"
               data-cod="${g.codigo ?? ''}"
               data-nombre="${d.nombre ?? ''}"
               data-uo="${d.uo ?? ''}"
               data-usuario-crea="${d.usuario ?? ''}"
               data-fecha-crea="${d.fecha ?? ''}"
               data-ip-crea="${d.ip ?? ''}"
               class="inline-flex bg-blue-700 items-center justify-center p-1.5 rounded-lg hover:bg-blue-800 focus:outline-none focus:ring-2 focus:ring-blue-500/60"
               title="Hist√≥rico" aria-label="Hist√≥rico">
              <img src="svg/historico.svg" class="w-5 h-5" alt="">
            </a>
          </td>

          <td class="px-3 py-2 text-[12px] text-center">
             <div class="inline-block p-1 border w-[80px] border-blue-400 bg-blue-200 rounded-lg">
    <b class="text-blue-900">${d.uo ?? ''}</b>
  </div>
          </td>
        </tr>
      `).join('');


    const rowDetalleItems = `
<tr class="detail-items bg-gray-100" aria-hidden="true">
  <td colspan="8" class="px-3 pt-0">
    <div class="collapsible">
      <div class="rounded-sm ring-1 ring-slate-200 shadow-sm overflow-hidden p-2">
        <div class="overflow-x-auto">
          <table class="min-w-[1200px] w-full text-sm tbl-documentos" data-id="${idx}">
            ${detalleHeadItems}
            <tbody class="[&>tr:nth-child(even)]:bg-slate-50">
              ${detalleBodyItems}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </td>
</tr>`;

    // tabla de acciones
    const accionesHead = `
  <thead class="bg-slate-700 text-white text-[12px]">
    <tr>
      <th class="px-3 py-2 text-center uppercase">N¬∞ Item</th>
      <th class="px-3 py-2 text-center uppercase">Fecha y hora</th>
      <th class="px-3 py-2 text-center uppercase">Actividad</th>
      <th class="px-3 py-2 text-center uppercase">Usuario</th>
      <th class="px-3 py-2 text-center uppercase">Nombre Usuario</th>
      <th class="px-3 py-2 text-center uppercase">IP</th>
      <th class="px-3 py-2 text-center uppercase">Unidad Org√°nica</th>
      <th class="px-3 py-2 text-center uppercase">Detalle</th>
    </tr>
  </thead>`;

const accionesBody = (g.acciones || []).map((a, ai) => {
  const hasDetalles = Array.isArray(a.detalles) && a.detalles.length > 0;
  return `
    <tr class="hover:bg-blue-50 transition">
      <td class="px-3 py-2 text-[12px] text-center">${a.orden ?? ''}</td>
      <td class="px-3 py-2 text-[12px] text-center">${a.fecha ?? ''}</td>
      <td class="px-3 py-2 text-[12px] text-center">${a.accion ?? ''}</td>
      <td class="px-3 py-2 text-[12px] text-center">${a.usuario ?? ''}</td>
      <td class="px-3 py-2 text-[12px] text-center">${a.nombreUsuario ?? ''}</td>
      <td class="px-3 py-2 text-[12px] text-center">${a.ip ?? ''}</td>
      <td class="px-3 py-2 text-[12px] text-center">
        <div class="inline-block p-1 border border-blue-400 bg-blue-200 rounded-lg w-[80px]">
          <b class="text-blue-900">${a.uo ?? ''}</b>
        </div>
      </td>
      <td class="px-3 py-2 text-[12px] text-center">
        ${
          hasDetalles
          ? `<a href="#detalle-notif"
                data-action="notif"
                data-cod="${g.codigo ?? ''}"
                data-action-idx="${ai}"
                class="inline-flex bg-green-700 items-center justify-center p-1.5 rounded-lg hover:bg-green-800 focus:outline-none focus:ring-2 focus:ring-green-500/60"
                title="Ver detalle" aria-label="Detalle notificaci√≥n">
               <img src="svg/historico.svg" class="w-5 h-5" alt="">
             </a>`
          : '‚Äî'
        }
      </td>
    </tr>
  `;
}).join('');


    const rowDetalleAcciones = `
<tr class="detail-acciones bg-gray-100" aria-hidden="true">
  <td colspan="8" class="px-3 pt-0">
    <div class="collapsible">
      <div class="rounded-sm ring-1 ring-slate-200 shadow-sm overflow-hidden p-2">
        <div class="overflow-x-auto ">
        <table class="min-w-[900px] w-full text-sm tbl-acciones"
       >
  ${accionesHead}
  <tbody class="[&>tr:nth-child(even)]:bg-slate-50">
    ${accionesBody}
  </tbody>
</table>

        </div>
      </div>
    </div>
  </td>
</tr>`;

    return rowPadre + rowDetalleItems + rowDetalleAcciones;
  }).join('');

  tbody.insertAdjacentHTML('beforeend', rows);
}
  /***********************
   *  PAGINACI√ìN (POR GRUPOS)
   ***********************/
  function datasetActual(){ return FILTERED ?? GROUPS; }

  function clampPage(totalPages){
    if (STATE.page < 1) STATE.page = 1;
    if (STATE.page > totalPages) STATE.page = totalPages || 1;
  }

  function pageSliceGroups(groups){
    const start = (STATE.page - 1) * STATE.size;
    return groups.slice(start, start + STATE.size);
  }

  function renderPagination(totalItems){
    const nav = document.getElementById('pagination');
    nav.innerHTML = '';

    const totalPages = Math.max(1, Math.ceil(totalItems / STATE.size));
    clampPage(totalPages);

    const btn = (label, page, {active=false, disabled=false}={}) => `
      <button type="button" data-page="${page}"
        class="px-3 py-1.5 ${active ? 'bg-slate-800 text-white' : 'bg-white text-slate-700'} ${disabled ? 'opacity-40 cursor-not-allowed' : 'hover:bg-slate-100'}">
        ${label}
      </button>`;

    // ¬´
    nav.insertAdjacentHTML('beforeend', btn('¬´', STATE.page - 1, {disabled: STATE.page === 1}));

    // n√∫meros con ventana
    const pages = [];
    const push = p => { if (!pages.includes(p) && p>=1 && p<=totalPages) pages.push(p); };
    push(1); push(STATE.page-1); push(STATE.page); push(STATE.page+1); push(totalPages);
    pages.sort((a,b)=>a-b);

    let last = 0;
    for (const p of pages) {
      if (p - last > 1) nav.insertAdjacentHTML('beforeend', `<span class="px-2 py-1.5 bg-white text-slate-400">‚Ä¶</span>`);
      nav.insertAdjacentHTML('beforeend', btn(String(p), p, {active: p===STATE.page}));
      last = p;
    }

    // ¬ª
    nav.insertAdjacentHTML('beforeend', btn('¬ª', STATE.page + 1, {disabled: STATE.page === totalPages}));

    // Delegaci√≥n
    nav.onclick = (e) => {
      const b = e.target.closest('button[data-page]');
      if (!b) return;
      const next = Number(b.dataset.page);
      if (Number.isNaN(next)) return;
      if (next < 1 || next > totalPages) return;
      STATE.page = next;
      refreshView();
    };
  }

// 2) Tu flujo
function refreshView() {
  const groups = datasetActual();
  const total = groups.length;
  const totalPages = Math.max(1, Math.ceil(total / STATE.size));
  clampPage(totalPages);

  // target donde pintas las filas (aj√∫stalo si tu render escribe en otro contenedor)
  const root = document.getElementById('tablaBodyPadre') || document;

  // a) destruye DTs ANTES de re-renderizar
  destroyTablesIn(root);

  renderPagination(total);
  renderNivel1(pageSliceGroups(groups)); // aqu√≠ re-escribes el DOM de las tablas hijas

  // b) re-inicializa DTs DESPU√âS del render
  initDataTablesAcciones(root);

  // empty state
  document.getElementById('emptyState').classList.toggle('hidden', total > 0);
}
  // Cambio de page size
  document.getElementById('pageSize').addEventListener('change', (e) => {
    const val = Number(e.target.value);
    STATE.size = PAGE_SIZE_OPTIONS.includes(val) ? val : 15;
    STATE.page = 1;
    refreshView();
  });

  /***********************
   *  FILTROS (aplican a NIVEL 1)
   ***********************/
  async function aplicarFiltros(){
  const fClase  = document.getElementById('fClase').value;
  const fMerc   = document.getElementById('fMercado').value;
  const fSub    = document.getElementById('fSub').value;
  const fTipo   = document.getElementById('fTipo').value;
  const fCodigo = document.getElementById('fCodigo').value.trim().toUpperCase();
  const fDesc = document.getElementById('fDesc').value.trim().toUpperCase();

  // mostrar skeleton inmediatamente
  showTableLoading();

  try {
    // finta 1500ms + carga del JSON
    const [data] = await Promise.all([
      $.ajax({
        url: GROUPS_URL + '?_=' + Date.now(),
        method: 'GET',
        dataType: 'json',
        cache: false
      }),
      sleep(1500)
    ]);

    let groups = Array.isArray(data) ? data : [];

    // filtrar con find / filter en el front
    groups = groups.filter(g => {
      if (fClase  && g.clase   !== fClase) return false;
      if (fMerc   && g.mercado !== fMerc)  return false;
      if (fSub    && g.subcat  !== fSub)   return false;
      if (fTipo   && g.tipo    !== fTipo)  return false;
      if (fDesc   && !(g.descripcion||'').toUpperCase().includes(fDesc))  return false;
      if (fCodigo && !(g.codigo||'').toUpperCase().includes(fCodigo)) return false;
      return true;
    });



    GROUPS   = groups;
    FILTERED = null;
    STATE.page = 1;
    refreshView();
  } catch(err){
    console.error('Error al cargar JSON:', err);
  }
}


  document.getElementById('btnBuscar').addEventListener('click', aplicarFiltros);
  document.getElementById('btnLimpiar').addEventListener('click', () => {
    document.getElementById('fClase').value = '';
    fillSelect(document.getElementById('fMercado'), []);
    fillSelect(document.getElementById('fSub'), []);
    fillSelect(document.getElementById('fTipo'), []);
    document.getElementById('fCodigo').value = '';
    FILTERED = null;
    STATE.page = 1;
    aplicarFiltros();
  });

  // Buscar con Enter
  document.getElementById('fCodigo').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') aplicarFiltros();
  });

  /***********************
   *  INIT
   ***********************/
  (async function init(){
    await loadInvestmentData(FILTERS_URL); // filtros en cascada
    //preselectFilters(DEFAULTS);
      // ‚Üê CARGA JSON EXTERNO CON LOADING
  GROUPS = await loadGruposAjax(GROUPS_URL);

  refreshView(); // render inicial (paginado por grupos)
  initDataTablesAcciones();
  })();

  /***********************
   *  Toggle (+)/(‚Äì) por fila de NIVEL 1
   ***********************/
// Reemplaza el toggle existente por este (maneja Items y Acciones)
// manejador de eventos
document.addEventListener('click', (e) => {
  const row = e.target.closest('tr.group-row');
  if (!row) return;

  const btnItems = e.target.closest('.btn-toggle-items');
  const btnAcc   = e.target.closest('.btn-toggle-acciones');

  const detailItems = row.nextElementSibling;                 // <tr class="detail-items">
  const detailAcc   = row.nextElementSibling?.nextElementSibling; // <tr class="detail-acciones">

  const setOpen = (trDetail, btn, open, colorClass) => {
    if (!trDetail || !btn) return;
    const box = trDetail.querySelector('.collapsible');
    box.classList.toggle('open', open);
    trDetail.setAttribute('aria-hidden', String(!open));
    btn.setAttribute('aria-expanded', String(open));
    btn.classList.toggle(colorClass, open);
  };

  if (btnItems) {
    const willOpen = !(detailItems?.querySelector('.collapsible')?.classList.contains('open'));
    setOpen(detailItems, btnItems, willOpen, 'bg-blue-200');
    // cerrar Acciones si se abre Items
    if (willOpen) setOpen(detailAcc, row.querySelector('.btn-toggle-acciones'), false, 'bg-green-200');
  }

  if (btnAcc) {
    const willOpen = !(detailAcc?.querySelector('.collapsible')?.classList.contains('open'));
    setOpen(detailAcc, btnAcc, willOpen, 'bg-green-200');
    // cerrar Items si se abre Acciones
    if (willOpen) setOpen(detailItems, row.querySelector('.btn-toggle-items'), false, 'bg-blue-200');
  }
});



  /***********************
   *  Modal Historial
   ***********************/
  const twModal = document.getElementById('twModalHist');
  const twBackdrop = twModal.querySelector('[data-backdrop]');
  const twPanel = twModal.querySelector('[role="dialog"]');

  function openTwModal() {
    twModal.classList.remove('hidden');
    document.body.classList.add('overflow-hidden');
    requestAnimationFrame(() => {
      twBackdrop.classList.add('opacity-100');
      twPanel.classList.add('opacity-100','scale-100');
    });

    // focus trap + Escape
    const focusable = twModal.querySelectorAll('a,button,select,textarea,input,[tabindex]:not([tabindex="-1"])');
    const first = focusable[0], last = focusable[focusable.length - 1];
    function trap(e){
      if (e.key === 'Tab') {
        if (e.shiftKey && document.activeElement === first) { e.preventDefault(); last.focus(); }
        else if (!e.shiftKey && document.activeElement === last) { e.preventDefault(); first.focus(); }
      }
      if (e.key === 'Escape') closeTwModal();
    }
    twModal._trapHandler = trap;
    twModal.addEventListener('keydown', trap);
    setTimeout(() => (first || twPanel).focus(), 10);
  }

  function closeTwModal() {
    twBackdrop.classList.remove('opacity-100');
    twPanel.classList.remove('opacity-100','scale-100');
    setTimeout(() => {
      twModal.classList.add('hidden');
      document.body.classList.remove('overflow-hidden');
      if (twModal._trapHandler) twModal.removeEventListener('keydown', twModal._trapHandler);
    }, 150);
  }

  twModal.addEventListener('click', (e) => {
    if (e.target === twBackdrop || e.target.closest('.close-btn')) closeTwModal();
  });

  // Abrir modal historial (lee historial del item en Nivel 2)
  document.addEventListener('click', async (e) => {
    const btn = e.target.closest('[data-action="historial"]');
    if (!btn) return;

    const codigo = btn.getAttribute('data-cod') || '';
    const nombre = btn.getAttribute('data-nombre') || '';
    const uo     = btn.getAttribute('data-uo') || '';
    const usuario= btn.getAttribute('data-usuario-crea') || '';
    const fecha  = btn.getAttribute('data-fecha-crea') || '';
    const ip     = btn.getAttribute('data-ip-crea') || '';

    // Busca grupo y item
    const groups = datasetActual();
    const grupo = groups.find(g => g.codigo === codigo);
    const item  = grupo?.items?.find(x => (x.nombre||'') === nombre);

    // Cabecera/meta
    document.getElementById('mh-title').textContent = `Historial ‚Äî ${nombre || 'Documento'}`;
    document.getElementById('mh-meta').textContent  = `C√≥digo: ${codigo} ¬∑ UO: ${uo || '‚Äî'}`;

    // Datos iniciales
    document.getElementById('mhUsuario').textContent = usuario || '‚Äî';
    document.getElementById('mhFecha').textContent   = fecha   || '‚Äî';
    document.getElementById('mhIP').textContent      = ip      || '‚Äî';

    // Cuerpo tabla
    const rows = Array.isArray(item?.historial) ? item.historial : [];
    const tbody = document.getElementById('mhTbody');

    if (!rows.length) {
      tbody.innerHTML = `
        <tr>
          <td colspan="12" class="px-3 py-6 text-center text-slate-500">Sin registros de historial.</td>
        </tr>`;
    } else {
      tbody.innerHTML = rows.map(r => `
        <tr class="hover:bg-blue-50 transition">
          <td class="px-3 py-2 text-center">${r.fecha ?? ''}</td>
          <td class="px-3 py-2 text-center">${r.usuario ?? ''}</td>
          <td class="px-3 py-2 text-center">${r.nombreUsuario ?? ''}</td>
          <td class="px-3 py-2 text-center">${r.ip ?? ''}</td>
          <td class="px-3 py-2 text-left">${r.doc ?? ''}</td>
          <td class="px-3 py-2 text-center">${r.paginas ?? ''}</td>
          <td class="px-3 py-2 text-center">${r.principal ?? ''}</td>
          <td class="px-3 py-2 text-center">${r.pfinal ?? ''}</td>
          <td class="px-3 py-2 text-center">${r.orden ?? ''}</td>
          <td class="px-3 py-2 text-center">
            <a href="#ver-pdf"
               data-action="pdf"
               data-title="${r.doc }"
               data-nombre="${r.doc || ''}"
               data-src="pdf/${encodeURIComponent(r.doc || 'documento.pdf')}"
               data-page="${r.principal || 1}"
               class="inline-flex bg-blue-700 items-center justify-center p-1.5 rounded-lg hover:bg-blue-800 focus:outline-none focus:ring-2 focus:ring-blue-500/60"
               title="Ver PDF" aria-label="Ver PDF">
              <img src="svg/visor.svg" alt="Ver" class="w-5 h-5 object-contain" loading="lazy" decoding="async">
            </a>
          </td>
        </tr>
      `).join('');
    }

    openTwModal();
  });

  /***********************
   *  Modal PDF + Descarga
   ***********************/
  const twPdfModal    = document.getElementById('twModalPDF');
  const twPdfBackdrop = twPdfModal.querySelector('[data-backdrop]');
  const twPdfPanel    = twPdfModal.querySelector('[role="dialog"]');
  const pdfContainer  = document.getElementById('pdfContainer');

  function openTwPdfModal() {
    twPdfModal.classList.remove('hidden');
    document.body.classList.add('overflow-hidden');
    requestAnimationFrame(() => {
      twPdfBackdrop.classList.add('opacity-100');
      twPdfPanel.classList.add('opacity-100','scale-100');
    });
    function trap(e){ if (e.key === 'Escape') closeTwPdfModal(); }
    twPdfModal._trapHandler = trap;
    document.addEventListener('keydown', trap);
  }

  function closeTwPdfModal() {
    twPdfBackdrop.classList.remove('opacity-100');
    twPdfPanel.classList.remove('opacity-100','scale-100');
    setTimeout(() => {
      twPdfModal.classList.add('hidden');
      document.body.classList.remove('overflow-hidden');
      if (pdfContainer) pdfContainer.innerHTML = '';
      if (twPdfModal._trapHandler) document.removeEventListener('keydown', twPdfModal._trapHandler);
    }, 150);
  }

  twPdfModal.addEventListener('click', (e) => {
    if (e.target === twPdfBackdrop || e.target.closest('.pdf-close')) closeTwPdfModal();
  });

  function openPdfViewer(url, { title='Visor PDF', page=1 } = {}) {
    document.getElementById('pdf-title').textContent = title;

    const abs       = new URL(url, window.location.href).href;
    const viewerUrl = `${abs}#page=${Number(page)||1}&zoom=page-width`;

    if (window.PDFObject && pdfContainer) {
      PDFObject.embed(viewerUrl, '#pdfContainer', {
        height: '80vh',
        fallbackLink:
          `<p class="p-4 text-sm text-slate-600">
             No se pudo mostrar el PDF aqu√≠.
             <a href="${abs}" target="_blank" rel="noopener" class="text-blue-600 underline">Abrir en otra pesta√±a</a> o descarga desde la barra superior.
           </p>`
      });
    } else {
      window.open(abs, '_blank', 'noopener');
      return;
    }
    openTwPdfModal();
  }

  // Delegaci√≥n PDF
  document.addEventListener('click', (e) => {
    const btn = e.target.closest('[data-action="pdf"]');
    if (!btn) return;
    e.preventDefault();

    let url = btn.getAttribute('data-src');
    if (!url) {
      const nombre = btn.getAttribute('data-nombre');
      if (nombre) url = `pdf/${encodeURIComponent(nombre)}`;
    }

    const page  = Number(btn.getAttribute('data-page') || '1') || 1;
    const title = btn.getAttribute('data-title') || 'Visor PDF';

    if (!url) {
      console.warn('openPdfViewer: no hay URL del PDF (data-src o data-nombre)');
      return;
    }
    openPdfViewer(url, { title, page });
  });

  // Descarga directa
  async function downloadPdf(url, filename) {
    const abs  = new URL(url, window.location.href).href;
    const name = filename || abs.split('/').pop() || 'documento.pdf';

    if (/^https?:/.test(abs)) {
      try {
        const res = await fetch(abs, { cache: 'no-store' });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const blob = await res.blob();
        const objectUrl = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = objectUrl;
        a.download = name;
        a.style.display = 'none';
        document.body.appendChild(a);
        a.click();
        a.remove();

        setTimeout(() => URL.revokeObjectURL(objectUrl), 1000);
        return;
      } catch (err) {
        console.warn('downloadPdf (fetch fallo, usando fallback):', err);
      }
    }
    const a = document.createElement('a');
    a.href = abs;
    a.setAttribute('download', name);
    a.style.display = 'none';
    document.body.appendChild(a);
    a.click();
    a.remove();
  }

  document.addEventListener('click', (e) => {
    const btn = e.target.closest('[data-action="download-pdf"]');
    if (!btn) return;
    e.preventDefault();
    const url  = btn.getAttribute('data-src') || btn.getAttribute('href');
    const name = btn.getAttribute('data-filename') || '';
    if (!url) return;
    downloadPdf(url, name);
  });

  // === Config m√≠nimos para auditor√≠a ===
const USUARIO_ACTUAL = { user: 'JSIFUENTESR', nombre: 'Josue Sifuentes' };

// Heur√≠stica UO por acci√≥n (aj√∫stala si cambian reglas)
const MAP_UO_POR_ACCION = {
  'Aprobar Inversi√≥n': 'OAD.TE',
  'Registrar Operaci√≥n': 'OAD.TE',
  'Cancelaci√≥n de Cup√≥n': 'OAD.TE',
  'Registro de Inversiones Financieras': 'DIN.IF',
  'Registro de Llamado de Capital': 'DIN.IF',
  'Registro de Distribuci√≥n de Capital': 'DIN.IF'
};

// Etiqueta por acci√≥n (puedes cambiar estas etiquetas por las que uses en UI)
const MAP_ETIQUETA_POR_ACCION = {
  'Registro de Inversiones Financieras': 'Documento Sustentatorio',
  'Aprobar Inversi√≥n': 'Confirmaci√≥n de compra',
  'Registrar Operaci√≥n': 'Constancia de operaci√≥n',
  'Registro de Llamado de Capital': 'Documento de notificaci√≥n del llamado',
  'Registro de Distribuci√≥n de Capital': 'Documento de notificaci√≥n de la distribuci√≥n',
  'Cancelaci√≥n de Cup√≥n': 'Sustento (Archivo)'
};

// Helpers fecha local
function nowPE() {
  return new Date().toLocaleString('es-PE', { hour12: true });
}

// Abrir/Cerrar modal Agregar
const addModal = document.getElementById('twModalAddDoc');
const addBackdrop = addModal.querySelector('[data-backdrop]');
const addPanel = addModal.querySelector('[role="dialog"]');
const addForm = document.getElementById('addDocForm');

function openAddModal(groupIdx) {
  const modal = document.getElementById('twModalAddDoc');
  const q = (s) => modal.querySelector(s);

  q('#addDocGroupIndex').value = String(groupIdx);

  // actividades √∫nicas del grupo (desde tus items)
  const g = datasetActual()[groupIdx] || {};
  const acts = [...new Set((g.items || []).map(d => d.asociado))];

  console.log(g)
  $('#clase-activo-modal').html(g.clase)
  $('#mercado-modal').html(g.mercado)
  $('#subcategoria-modal').html(g.subcat)
  $('#tipo-instrumento-modal').html(g.tipo)
  $('#nombre-modal').html(g.descripcion)
  $('#codigo-inversion-modal').html(g.codigo)

  const selAccion = q('#addDocAccion');
  selAccion.innerHTML = '<option value="">Seleccione‚Ä¶</option>';
  acts.forEach(a => {
    const opt = document.createElement('option');
    opt.value = a;
    opt.textContent = a;
    selAccion.appendChild(opt);
  });

  // reset numeraci√≥n/etiqueta
  const selOrden = q('#addDocOrden');
  selOrden.innerHTML = '<option value="">Seleccione‚Ä¶</option>';
  selOrden.disabled = true;
  selOrden.required = false; // se activar√° si hay valores
  q('#addEtiqueta').value = '';

  // abrir modal (tu animaci√≥n)
  modal.classList.remove('hidden');
  document.body.classList.add('overflow-hidden');
  const addBackdrop = modal.querySelector('[data-backdrop]');
  const addPanel = modal.querySelector('[role="dialog"]');
  requestAnimationFrame(() => {
    addBackdrop?.classList.add('opacity-100');
    addPanel?.classList.add('opacity-100','scale-100');
  });
}

document.getElementById('addDocAccion').addEventListener('change', (e) => {
  const modal = document.getElementById('twModalAddDoc');
  const q = (s) => modal.querySelector(s);

  const groupIdx = Number(q('#addDocGroupIndex').value);
  const g = datasetActual()[groupIdx] || {};
  const actividad = e.target.value;

  console.log(g)

  const selOrden = q('#addDocOrden');
  const inpEtiqueta = q('#addEtiqueta');

  // reset b√°sicos
  selOrden.innerHTML = '<option value="">Seleccione‚Ä¶</option>';
  selOrden.disabled = true;
  selOrden.required = false;
  inpEtiqueta.value = '';

  if (!actividad) return;

  // numeraciones YA USADAS en ESA actividad
  const usados = Array.from(new Set(
    (g.items || [])
      .filter(x => x.asociado === actividad)
      .map(x => Number(x.numeracion_doc))
      .filter(n => Number.isFinite(n) && n > 0)
  )).sort((a,b)=>a-b);

  if (usados.length) {
    for (const n of usados) {
      const opt = document.createElement('option');
      opt.value = String(n);
      opt.textContent = String(n);
      selOrden.appendChild(opt);
    }
    selOrden.disabled = false;
    selOrden.required = true; // obligatorio si hay opciones v√°lidas
  } else {
    // No hay numeraciones para esta actividad ‚Üí lo deshabilitamos
    const opt = document.createElement('option');
    opt.value = '';
    opt.textContent = 'No hay numeraciones para esta actividad';
    opt.disabled = true;
    selOrden.appendChild(opt);
    selOrden.disabled = true;
    selOrden.required = false;
  }

  // opcional: prellenar etiqueta con la √∫ltima usada en esa actividad
  const itemsAct = (g.items || []).filter(x => x.asociado === actividad);
  //if (itemsAct.length) inpEtiqueta.value = itemsAct[itemsAct.length - 1].etiqueta || '';
});


function closeAddModal(){
  addBackdrop.classList.remove('opacity-100');
  addPanel.classList.remove('opacity-100','scale-100');
  setTimeout(() => {
    addModal.classList.add('hidden');
    document.body.classList.remove('overflow-hidden');
    addForm.reset();
    document.getElementById('addDocFileName').textContent = 'Ning√∫n archivo seleccionado';
  }, 120);
}

// Delegaci√≥n: abrir modal desde bot√≥n por fila
document.addEventListener('click', (e) => {
  const btn = e.target.closest('.btn-add-doc');
  if (!btn) return;
  const idx = Number(btn.dataset.groupIdx ?? '-1');
  if (idx < 0) return;
  openAddModal(idx, GROUPS[idx]);
});

// Cerrar modal
addModal.addEventListener('click', (e) => {
  if (e.target === addBackdrop || e.target.closest('.adddoc-close')) closeAddModal();
});

// File picker con icono
document.getElementById('btnPickFile').addEventListener('click', () => {
  document.getElementById('addDocFile').click();
});
document.getElementById('addDocFile').addEventListener('change', (e) => {
  const f = e.target.files?.[0];
  document.getElementById('addDocFileName').textContent = f ? f.name : 'Ning√∫n archivo seleccionado';
});

// Construir y agregar Item + Acci√≥n
function agregarDocumentoAlGrupo(groupIdx, { accion, orden, fileName }){
  const groups = datasetActual(); // misma fuente que tu render
  const g = groups[groupIdx];
  if (!g) return;

  const fecha = nowPE();
  const uo = MAP_UO_POR_ACCION[accion] || '';
  const etiqueta = MAP_ETIQUETA_POR_ACCION[accion] || 'Documento';

  // Item nuevo (nivel 2)
  const nuevoItem = {
    bloqueado: false,
    orden: (Array.isArray(g.items) ? g.items.length + 1 : 1),
    fecha,
    asociado: accion,
    etiqueta,
    nombre: fileName || 'documento.pdf',
    paginas: 7,
    principal: 2,
    pfinal: 10,
    uo,
    usuario: USUARIO_ACTUAL.user,
    ip: '',
    tipo_doc_sus: "Adicionales",
    numeracion_doc: orden,
    historial: [
      {
        fecha,
        usuario: USUARIO_ACTUAL.user,
        nombreUsuario: USUARIO_ACTUAL.nombre,
        ip: '',
        doc: fileName || 'documento.pdf',
        paginas: '',
        principal: '',
        pfinal: '',
        orden: Number(orden) || ''
      }
    ]
  };

  // Acci√≥n (nivel del grupo)
  const nuevaAccion = {
    fecha,
    accion: "Agrega un nuevo documento adicional",
    usuario: USUARIO_ACTUAL.user,
    nombreUsuario: USUARIO_ACTUAL.nombre,
    ip: '',
    orden: g.acciones.length + 1,
    uo
  };

  // Mutar estado
  if (!Array.isArray(g.items)) g.items = [];
  g.items.push(nuevoItem);

  if (!Array.isArray(g.acciones)) g.acciones = [];
  g.acciones.push(nuevaAccion);
}

// Submit del formulario
addForm.addEventListener('submit', (e) => {
  e.preventDefault();
  const groupIdx = Number(document.getElementById('addDocGroupIndex').value || '-1');
const accion   = document.getElementById('addDocAccion').value.trim();
const orden    = document.getElementById('addDocOrden').value;
const file     = document.getElementById('addDocFile').files?.[0];

if (!accion) { toastr.error('Seleccione una acci√≥n.', 'Falta acci√≥n'); return; }
//if (!orden)  { toastr.error('Ingrese la numeraci√≥n (orden).', 'Falta numeraci√≥n'); return; }
if (!file)   { toastr.error('Seleccione un PDF.', 'Falta documento'); return; }
  agregarDocumentoAlGrupo(groupIdx, {
    accion,
    orden,
    fileName: file.name
  });
  toastr.success('Documento y acci√≥n agregados correctamente.', '¬°Listo!');

  closeAddModal();
  refreshView();  // re-render tabla con el item y con la acci√≥n nueva
});

// 1) Helpers
function destroyTablesIn(root = document) {
  root.querySelectorAll('.tbl-acciones, .tbl-documentos').forEach((tbl) => {
    if ($.fn.DataTable.isDataTable(tbl)) {
      $(tbl).DataTable().destroy(); // limpia instancia y eventos
    }
  });
}

function initDataTablesAcciones(root = document) {
  root.querySelectorAll('.tbl-acciones, .tbl-documentos').forEach((tbl) => {
    if (!$.fn.DataTable.isDataTable(tbl)) {
      new DataTable(tbl, {
        pageLength: 10,
        order: [],
        language: { url: 'https://cdn.datatables.net/plug-ins/2.1.5/i18n/es-ES.json' },
        retrieve: true, // si ya existiera, reusa
        initComplete() {
          const wrapper = this.api().table().container();

          // üëâ despu√©s del selector "Mostrar N registros"
          const lengthDiv = wrapper.querySelector('.dt-length') || wrapper.querySelector('.dataTables_length');
          if (lengthDiv && !lengthDiv.querySelector('.tbl-title')) {
            const spanTitulo = document.createElement('span');
            spanTitulo.className = 'tbl-title ml-3 font-bold text-gray-600 text-lg'; 
            // ‚Üë text-lg = grande, text-xl = a√∫n m√°s grande

            // depende de la clase de la tabla
            if (tbl.classList.contains('tbl-documentos')) {
              spanTitulo.textContent = 'Documentos Sustentatorios';
            } else if (tbl.classList.contains('tbl-acciones')) {
              spanTitulo.textContent = 'Historial de Actividades';
            }

            lengthDiv.appendChild(spanTitulo);
          }

          // üëâ solo aplica bot√≥n si es .tbl-documentos
          if (!tbl.classList.contains('tbl-documentos')) return;

          const filterDiv = wrapper.querySelector('.dt-search') || wrapper.querySelector('.dataTables_filter');
          if (!filterDiv) return;

          // bot√≥n pegado al buscador con tu atributo
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'btn-add-doc px-3 py-1 rounded text-white bg-blue-600';
          btn.textContent = 'Agregar Documento';

          // usa el mismo idx que renderizaste para esta tabla
          const idx = tbl.getAttribute('data-id') || '';
          btn.setAttribute('data-group-idx', idx);

          // estilo en l√≠nea para alinear
          filterDiv.style.display = 'flex';
          filterDiv.style.alignItems = 'center';
          filterDiv.style.gap = '8px';

          // evita duplicados
          if (!filterDiv.querySelector('.btn-add-doc')) {
            filterDiv.appendChild(btn);
          }
        }
      });
    }
  });
}

/***********************
 *  Modal Detalle Notificaci√≥n
 ***********************/
const ntfModal     = document.getElementById('twModalNotif');
const ntfBackdrop  = ntfModal.querySelector('[data-backdrop]');
const ntfPanel     = ntfModal.querySelector('[role="dialog"]');
const ntfThead     = document.getElementById('ntfThead');
const ntfTbody     = document.getElementById('ntfTbody');

function openNotifModal() {
  ntfModal.classList.remove('hidden');
  document.body.classList.add('overflow-hidden');
  requestAnimationFrame(() => {
    ntfBackdrop.classList.add('opacity-100');
    ntfPanel.classList.add('opacity-100','scale-100');
  });
}

function closeNotifModal() {
  ntfBackdrop.classList.remove('opacity-100');
  ntfPanel.classList.remove('opacity-100','scale-100');
  setTimeout(() => {
    ntfModal.classList.add('hidden');
    document.body.classList.remove('overflow-hidden');
  }, 150);
}

ntfModal.addEventListener('click', (e) => {
  if (e.target === ntfBackdrop || e.target.closest('.ntf-close')) closeNotifModal();
});

// Delegaci√≥n: bot√≥n "Detalle" en Acciones
document.addEventListener('click', (e) => {
  const btn = e.target.closest('[data-action="notif"]');
  if (!btn) return;
  e.preventDefault();

  const codigo = btn.getAttribute('data-cod');
  const aidx   = Number(btn.getAttribute('data-action-idx'));

  const grupos = datasetActual();
  const grupo  = grupos.find(g => g.codigo === codigo);
  const accion = grupo?.acciones?.[aidx];
  const rows   = Array.isArray(accion?.detalles) ? accion.detalles : [];

  if (!accion || !rows.length) {
    toastr?.warning?.('No hay detalles para esta notificaci√≥n');
    return;
  }

  // ¬øEs env√≠o o recepci√≥n?
  const accionTxt = (accion.accion || '').toLowerCase();
  const isSend = /env[i√≠]o/.test(accionTxt);          // "Env√≠o de notificaci√≥n ..."
  const isRecv = /recepci[o√≥]n/.test(accionTxt);      // "Recepci√≥n de notificaci√≥n ..."

  // Header din√°mico
  if (isSend) {
    ntfThead.innerHTML = `
      <tr>
        <th class="px-3 py-2 text-center uppercase">Usuario</th>
        <th class="px-3 py-2 text-center uppercase">Nombre</th>
        <th class="px-3 py-2 text-center uppercase">UO</th>
      </tr>
    `;
  } else {
    // Recepci√≥n (o fallback): incluye "Hora lectura"
    ntfThead.innerHTML = `
      <tr>
        <th class="px-3 py-2 text-center uppercase">Fecha y Hora lectura</th>
        <th class="px-3 py-2 text-center uppercase">Usuario</th>
        <th class="px-3 py-2 text-center uppercase">Nombre</th>
        <th class="px-3 py-2 text-center uppercase">IP</th>
        <th class="px-3 py-2 text-center uppercase">UO</th>

      </tr>
    `;
  }

  // T√≠tulo y meta
  document.getElementById('ntf-title').textContent = `Detalle ‚Äî ${accion.accion || 'Notificaci√≥n'}`;
  document.getElementById('ntf-meta').textContent  =
    `Fecha y hora: ${accion.fecha || '‚Äî'} ¬∑ Cantidad: ${rows.length}`;

  // Filas din√°micas
  ntfTbody.innerHTML = rows.map(r => {
    if (isSend) {
      // Sin columna "Hora lectura"
      return `
        <tr class="hover:bg-blue-50 transition">
          <td class="px-3 py-2 text-center">${r.usuario ?? ''}</td>
          <td class="px-3 py-2 text-center">${r.nombreUsuario ?? ''}</td>
          <td class="px-3 py-2 text-center">${r.uo ?? ''}</td>
        </tr>
      `;
    } else {
      // Con "Hora lectura"
      return `
        <tr class="hover:bg-blue-50 transition">
            <td class="px-3 py-2 text-center">${r.horaLectura ?? ''}</td>
          <td class="px-3 py-2 text-center">${r.usuario ?? ''}</td>
          <td class="px-3 py-2 text-center">${r.nombreUsuario ?? ''}</td>
          <td class="px-3 py-2 text-center">${r.ip ?? ''}</td>
          <td class="px-3 py-2 text-center">${r.uo ?? ''}</td>

        </tr>
      `;
    }
  }).join('');

  openNotifModal();
});



  </script>
</body>
</html>
