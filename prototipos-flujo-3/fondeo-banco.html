<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Tranferencia de Fondos</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { brand1:'#005C97', brand2:'#004a7c', line:'#e5e7eb', ink:'#2c3e50', muted:'#f9fafb' },
          boxShadow: { card:'0 8px 32px rgba(0,0,0,.08)', panel:'0 10px 30px rgba(0,0,0,.15)' }
        }
      }
    }
  </script>

  <!-- Toastr -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cleave.js/1.6.0/cleave.min.js"></script>

  <!-- Select2 -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.1.0/css/select2.min.css"/>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet"/>

  <style>
    /* Toastr: sin √≠conos por defecto */
    #toast-container > .toast-success,
    #toast-container > .toast-error,
    #toast-container > .toast-info,
    #toast-container > .toast-warning {
      background-image: none !important;
      background-repeat: none !important;
      padding-left: 14px !important;
    }
    /* Select2 ‚Äúmuted‚Äù y p-2.5 */
    .select2-container--default .select2-selection--single{
      height: 46px;                     /* p-2.5 + border */
      border: 2px solid #d1d5db;        /* gray-300 */
      border-radius: 0.75rem;           /* rounded-xl */
      background: #fff;
      display: flex; align-items: center;
    }
    .select2-container--default .select2-selection--single .select2-selection__rendered{
      line-height: 42px;                /* altura interior */
      padding-left: 12px;               /* p-2.5 feel */
      color:#111827;                    /* gray-900 */
      font-size: 15px;
      font-family: inherit;
      width: 100%;
    }
    .select2-container--default .select2-selection--single .select2-selection__arrow{
      height: 100%; right: 8px;
    }
    .select2-dropdown{
      border: 1.5px solid #e5e7eb;
      border-radius: 10px;
      box-shadow: 0 6px 16px rgba(0,0,0,.06);
    }
            .section-header {
            font-size: 1.2rem;
            font-weight: 600;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-left: 4px solid #005C97;
            padding: 0.75rem 1rem;
            border-radius: 6px;
            margin-bottom: 1.5rem;
            color: #333;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 25px;
            margin-bottom: 30px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .info-column {
            padding: 20px;
            border-left: 4px solid #3498db;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .info-item {
            margin-bottom: 15px;
        }

        .info-label {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
            font-size: 0.9em;
        }

        .info-value {
            color: #555;
            font-size: 1em;
        }

         .header {
            background: linear-gradient(135deg, #005C97 0%, #004a7c 100%);
            color: white;
            padding: 2rem;
            text-align: center;
        }

        .header h1 {
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

                .section-header {
            font-size: 1.2rem;
            font-weight: 600;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-left: 4px solid #005C97;
            padding: 0.75rem 1rem;
            border-radius: 6px;
            margin-bottom: 1.5rem;
            color: #333;
        }

                .config-section {
            margin-top: 1.5rem;
            padding: 1rem;
            background: #fff;
            border-radius: 6px;
            border: 1px solid #ddd;
        }

        .add-document-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        .add-document-btn:hover {
            background: #218838;
        }

        .remove-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8rem;
            margin-left: 0.5rem;
        }

        .remove-btn:hover {
            background: #c82333;
        }

        /* Hover y clic para las zonas de subida */
.file-upload-area, #drop{
  cursor: pointer;
  transition: border-color .2s, box-shadow .2s;
}
.file-upload-area:hover, #drop:hover{
  border-color: #60a5fa; /* blue-400 */
  box-shadow: inset 0 0 0 2px rgba(59,130,246,.25);
}



  </style>
</head>
<body class="bg-gray-100 text-ink">
<div id="area-badge"
     style="position: absolute; top: 15px; right: 20px;
            background-color: #1e6ba8; color: #fff;
            font-weight: bold; font-size: 0.9rem;
            padding: 6px 14px; border-radius: 20px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);">
  √Årea: -
</div>
  <!-- Topbar -->
  <!--<header class="sticky top-0 z-40 bg-gradient-to-br from-brand1 to-brand2 text-white shadow-md">
    <div class="max-w-[1100px] mx-auto px-4 py-3 flex items-center gap-3">
      <div class="w-9 h-9 rounded-xl bg-white/15 border border-white/25 grid place-items-center">
        <svg viewBox="0 0 24 24" class="w-5 h-5 fill-white"><path d="M12 2 3 7v10l9 5 9-5V7l-9-5Zm7 6-7 4-7-4m0 0 7-4m7 4v8l-7 4m-7-12v8l7 4"/></svg>
      </div>
      <div class="font-semibold">FCR ¬∑ Registrar Llamado de Capital</div>
      <div class="ml-auto text-sm opacity-90"></div>
    </div>
  </header>-->

  <main class="max-w-screen-2xl mx-auto px-4 py-6">
    
            <div class="header rounded-2xl rounded-b-none">
                <h1>Transferir fondos</h1>
            </div>
    <!-- Inversi√≥n seleccionada -->
    <section class="bg-white rounded-2xl rounded-t-none border border-line shadow-card p-5 mt-0">
         <div class="section-header">1. Informaci√≥n del Instrumento</div>
                <div class="info-grid">
                    <div class="info-column">
                        <div class="info-item">
                            <div class="info-label">C√≥digo del instrumento:</div>
                            <div class="info-value">INV-6053</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Nombre de la SAFI o General Partner:</div>
                            <div class="info-value">SAFI</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Capital comprometido:</div>
                            <div class="info-value">10,000,000.00</div>
                        </div>
                         <div class="info-item">
                            <div class="info-label">Correo de la persona de contacto (SAFI/GP):</div>
                            <div class="info-value">correo@gmail.com</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Tipo de custodia:</div>
                            <div class="info-value">Local-ONP</div>
                        </div>
                    </div>

                    <div class="info-column">
                        <div class="info-item">
                            <div class="info-label">Unidad de negocio:</div>
                            <div class="info-value">MACROFONDO</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Clasificaci√≥n de riesgos:</div>
                            <div class="info-value">AA+</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Fecha de suscripci√≥n del contrato:</div>
                            <div class="info-value">22/09/2025</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Plazo (a√±os):</div>
                            <div class="info-value">5</div>
                        </div>
                         <div class="info-item">
                            <div class="info-label">Informaci√≥n adicional:</div>
                            <div class="info-value">a</div>
                        </div>
                    </div>

                    <div class="info-column">
                        <div class="info-item">
                            <div class="info-label">Plazo de vencimiento:</div>
                            <div class="info-value">-</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Grupo econ√≥mico:</div>
                            <div class="info-value">Grupo Intercorp</div>
                        </div>
                           <div class="info-item">
                            <div class="info-label">Fecha de vencimiento:</div>
                            <div class="info-value">22/09/2030</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Activo custodiado:</div>
                            <div class="info-value">No</div>
                        </div>
                    </div>

                    <div class="info-column">
                        <div class="info-item">
                            <div class="info-label">Nombre Fondo:</div>
                            <div class="info-value">Fondo Privado Intercorp</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Moneda:</div>
                            <div class="info-value">PEN</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Nombre de la persona de contacto (SAFI/GP):</div>
                            <div class="info-value">persona</div>
                        </div>
                         <div class="info-item">
                            <div class="info-label">Nombre del custodio:</div>
                            <div class="info-value">Scotiabank</div>
                        </div>
                    </div>
                </div>
                   <div class="section-header">2. Informaci√≥n de la operaci√≥n financiera</div>
      <form id="formLlamado" class="space-y-5" novalidate>
        <input type="hidden" id="inv_id"/>

        <div class="grid md:grid-cols-3 gap-4">
         <!-- <div>
            <label class="block text-sm font-semibold mb-1">Fecha del llamado</label>
            <input id="fecha_llamado" type="date" required
                   class="w-full rounded-xl border-2 border-gray-300 p-2.5 text-[15px] focus:border-blue-500">
          </div>-->
          <div>
            <label class="block text-sm font-semibold mb-1">Monto</label>
            <input id="monto" type="text" inputmode="decimal" required
                   class="w-full rounded-xl border-2 border-gray-300 p-2.5 text-[15px] focus:border-blue-500"
                   placeholder="Ej. 1,310,067.70">
          </div>
            <div>
            <label class="block text-sm font-semibold mb-1">Moneda</label>
             <select id="entidad" class="w-1/2 rounded-xl border-2 border-gray-300 p-2.5 text-[15px] focus:border-blue-500">
                <option value="PEN" selected>PEN</option>
                <option value="USD">USD</option>
              </select>
          </div>
        </div>

        <!-- NUEVO: Cuenta Bancaria (Select2) -->
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-semibold mb-1">Banco cuenta de cargo</label>
            <select id="banco" style="width:100%"></select>
            <p class="text-xs text-gray-500 mt-1">Selecciona el banco desde donde se realizar√° el aporte.</p>
          </div>
          <div>
            <label class="block text-sm font-semibold mb-1">Nro cuenta bancaria</label>
            <select id="cuenta" style="width:100%"></select>
            <p class="text-xs text-gray-500 mt-1">Selecciona la cuenta desde donde se realizar√° el aporte.</p>
          </div>
        </div>
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-semibold mb-1">Banco cuenta destino</label>
            <select id="banco_destino" style="width:100%"></select>
            <p class="text-xs text-gray-500 mt-1">Selecciona el banco desde donde se realizar√° el aporte.</p>
          </div>
          <div>
            <label class="block text-sm font-semibold mb-1">Nro cuenta destino</label>
            <select id="cuenta_destino" style="width:100%"></select>
            <p class="text-xs text-gray-500 mt-1">Selecciona la cuenta desde donde se realizar√° el aporte.</p>
          </div>
        </div>
        <div class="section-header">3. Sustento documentario</div>
        <div class="p-5 rounded-md bg-gray-100">
                  <div class="text-center justify-center">
          <label class=" text-sm font-semibold mb-1">documento sustento de tranferencia</label>
          <div id="drop" class="rounded-sm border-2 border-dashed border-gray-300 bg-muted p-4 w-[30%] m-auto">
            <input id="file" type="file" accept=".pdf,.png,.jpg,.jpeg" required class="hidden">
            <div class="flex items-center text-center text-sm">
              <div class="text-center w-full">
                <div class="font-semibold">üìÑ Seleccionar archivo</div>
                <div class="text-gray-500">PDF</div>
              </div>
              
            </div>
            <div id="fileName" class="mt-2 text-blue-700 font-medium hidden"></div>
          </div>
        </div>
        <div>
          <div id="documentFields" class="mt-4 flex flex-row gap-3"></div>
        </div>
        <div class="config-section">
                    <h4>üîß Configuraci√≥n avanzada</h4>
                    <p style="color: #666; font-size: 0.9rem;">Agregue documentos adicionales para el √°rea seleccionada:
                    </p>
                   <input type="text" id="newDocumentName" placeholder="Nombre del nuevo documento"
  style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; width: 250px;">

<button type="button" class="add-document-btn" >+ Agregar Documento</button>
          </div>

        </div>

        

        <div class="flex justify-end gap-3">
          <a href="#" class="px-4 py-2.5 rounded-xl border-2 border-gray-300 bg-white hover:bg-gray-50">Cancelar</a>
          <button type="submit"
            class="px-5 py-2.5 rounded-xl bg-blue-600 hover:bg-blue-700 text-white font-semibold">
            Guardar llamado
          </button>
        </div>
      </form>
    </section>

    <!-- Formulario -->

  </main>

  <!-- Modal de confirmaci√≥n -->
  <div id="confirmModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">
    <div class="bg-white rounded-2xl shadow-panel w-[560px] max-w-[92vw] p-5">
      <h1 class="text-xl font-semibold text-ink flex items-center">
            <span class="border-l-4 border-[#3396d8] pl-2">Revisar y confirmar</span>
      </h1>
      <div id="review" class="space-y-2 text-sm"></div>
      <div class="flex justify-end gap-2 mt-4">
        <button id="btnCancelConfirm" class="px-3 py-2.5 rounded-xl border border-gray-300">Volver</button>
        <button id="btnConfirmSave"
          class="px-4 py-2.5 rounded-xl bg-blue-600 text-white font-semibold disabled:opacity-50"
          >Confirmar y guardar</button>
      </div>
    </div>
  </div>

  <!-- libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.full.min.js"></script>

  <script>
 // -------- Mock de inversi√≥n seleccionada --------
const selectedInvestment = {
  id: "INV-6120",
  entidad: "Fondo Consolidado de Reservas Previsionales ‚Äì FCR",
  descripcion: "Inversi√≥n de Prueba"
};

// -------- Mock cuentas bancarias (reemplaza por las reales) --------
const BANCOS = [
  { id: "BCP", text: "Banco de Cr√©dito del Per√∫ (BCP)" },
  { id: "Scotiabank", text: "Scotiabank Per√∫" },
  { id: "BBVA", text: "BBVA Per√∫" },
  { id: "Interbank", text: "Interbank" }
];

const CUENTAS_BANCARIAS = [
  // BCP
  { id: "BCP-PEN-001", banco: "BCP", text: "193-1990153-0-54" },

  // Scotiabank
  { id: "SCOTIA-PEN-002", banco: "Scotiabank", text: "970-0700108" },

  // BBVA
  { id: "BBVA-PEN-003", banco: "BBVA", text: "0011-0661-02-00040907" },

  // Interbank
  { id: "INTERBANK-PEN-004", banco: "Interbank", text: "200-3067561380" }
];

// -------- Helpers visuales / validaci√≥n --------
function markInvalid($el){ $el.addClass("ring-2 ring-red-400 border-red-400"); }
function clearInvalid($el){ $el.removeClass("ring-2 ring-red-400 border-red-400"); }

function validateFile(f){
  if(!f) return { ok:false, msg:"Adjunta el documento de tranferencia (PDF/JPG/PNG)." };
  const okExt = /(\.pdf|\.png|\.jpg|\.jpeg)$/i.test(f.name);
  if(!okExt) return { ok:false, msg:"Formato no permitido. Solo PDF, JPG o PNG." };
  if(f.size > 10*1024*1024) return { ok:false, msg:"Archivo supera 10MB. Adjunta uno m√°s liviano." };
  return { ok:true };
}

// ======= Globals para documentos din√°micos =======
let filesUploaded = {};
let documentCounter = 1;
let documentRequirements = {};
let currentArea = 'general'; // si luego tienes √°reas, c√°mbialo din√°micamente

// Crea el contenedor si no existe para evitar errores
function ensureDocumentFieldsContainer(){
  let cont = document.getElementById('documentFields');
  if (!cont) {
    const host = document.querySelector('.config-section') || document.getElementById('formLlamado') || document.body;
    cont = document.createElement('div');
    cont.id = 'documentFields';
    cont.className = 'mt-4 grid gap-3';
    host.appendChild(cont);
  }
  return cont;
}

// ======= Crear un campo de subida PDF (sin inline onclick) =======
function createDocumentField(docName, fieldId, isCustom = false) {
  const container = ensureDocumentFieldsContainer();

  const fieldGroup = document.createElement('div');
  fieldGroup.className = 'file-upload-group p-3 rounded-xl w-1/3';
  fieldGroup.id = `field_${fieldId}`;

  const labelWrap = document.createElement('div');
  labelWrap.className = 'flex items-center mb-2 text-left gap-3';

  const label = document.createElement('label');
  label.className = 'font-semibold';
  label.textContent = docName;

  if (isCustom) {
    const removeBtn = document.createElement('button');
    removeBtn.type = 'button'; // evita submit
    removeBtn.className = 'remove-btn';
    removeBtn.textContent = '‚úï';
    removeBtn.onclick = () => removeCustomDocument(fieldId);
    labelWrap.appendChild(removeBtn);
  }
  labelWrap.appendChild(label);

  const uploadArea = document.createElement('div');
  uploadArea.className = 'file-upload-area text-center rounded-sm border-2 border-dashed border-gray-300 bg-muted p-4 cursor-pointer hover:border-blue-400 transition-colors';
  uploadArea.innerHTML = `
    <div class="upload-text font-medium">üìÑ Seleccionar archivo</div>
    <div class="upload-text text-gray-500 text-sm mt-1">PDF</div>
  `;

  const fileInput = document.createElement('input');
  fileInput.type = 'file';
  fileInput.id = fieldId;
  fileInput.style.display = 'none';
  fileInput.accept = '.pdf';
  fileInput.addEventListener('change', (e) => handleFileUpload(e.target, docName));

  fieldGroup.appendChild(labelWrap);
  fieldGroup.appendChild(uploadArea);
  fieldGroup.appendChild(fileInput);
  container.appendChild(fieldGroup);

    filesUploaded[fieldId] = false;

}

// ======= Abrir el input file oculto de cada uploader din√°mico (delegado) =======
function bindDynamicUploadClickOnce(){
  if (window.__bindDynamicUploadClickOnce) return;
  window.__bindDynamicUploadClickOnce = true;
  $(document)
    .off('click.openInput', '.file-upload-area')
    .on('click.openInput', '.file-upload-area', function(e){
      // evita que un bot√≥n dentro de la card robe el click
      if (e.target.closest('.remove-btn')) return;
      const input = this.parentElement.querySelector('input[type="file"]');
      if (input) input.click();
    });
}
bindDynamicUploadClickOnce();

// ======= Validar y pintar estado de la subida =======
function handleFileUpload(input, documentType) {
  const fileArea = input.previousElementSibling;

  if (input.files.length > 0) {
    const file = input.files[0];
    const fileName = file.name.toLowerCase();

    if (!fileName.endsWith('.pdf')) {
      fileArea.innerHTML = `
        <div class="upload-text text-red-600">‚å´ Solo se permiten archivos PDF</div>
        <div class="upload-text text-gray-500 text-sm mt-1">PDF</div>
      `;
      input.value = '';
      filesUploaded[input.id] = false;
      $(fileArea).addClass('ring-2 ring-red-400 border-red-400');
    } else if (file.size > 10 * 1024 * 1024) {
      fileArea.innerHTML = `
        <div class="upload-text text-red-600">‚å´ Archivo supera 10MB</div>
        <div class="upload-text text-gray-500 text-sm mt-1">PDF</div>
      `;
      input.value = '';
      filesUploaded[input.id] = false;
      $(fileArea).addClass('ring-2 ring-red-400 border-red-400');
    } else {
      // ok
      fileArea.innerHTML = `
        <div class="file-name">üìé ${file.name}</div>
        <div class="upload-text text-green-600 text-sm">Archivo cargado correctamente</div>
      `;
      filesUploaded[input.id] = true;
      $(fileArea).removeClass('ring-2 ring-red-400 border-red-400');
    }
  } else {
    fileArea.innerHTML = `
      <div class="upload-text font-medium">üìÑ Seleccionar archivo</div>
      <div class="upload-text text-gray-500 text-sm mt-1">PDF</div>
    `;
    filesUploaded[input.id] = false;
    $(fileArea).addClass('ring-2 ring-red-400 border-red-400');
  }

  checkFormCompletion();
}

// ======= Agregar nuevo documento (sin submit) =======
function addCustomDocument(e) {
  if (e && e.preventDefault) e.preventDefault();
  else if (window.event) window.event.preventDefault();

  const input = document.getElementById('newDocumentName');
  const docName = (input?.value || '').trim();

  if (!docName) {
    if (window.toastr) toastr.warning('Por favor ingresa un nombre para el documento.');
    else alert('Por favor ingresa un nombre para el documento.');
    return;
  }

  const fieldId = `custom_${currentArea}_${documentCounter++}`;
  createDocumentField(docName, fieldId, true);

  if (!documentRequirements[currentArea + '_custom']) {
    documentRequirements[currentArea + '_custom'] = [];
  }
  documentRequirements[currentArea + '_custom'].push(docName);

  input.value = '';
}

// ======= Remover documento din√°mico =======
function removeCustomDocument(fieldId) {
  const fieldElement = document.getElementById(`field_${fieldId}`);
  if (fieldElement) {
    fieldElement.remove();
    delete filesUploaded[fieldId];
  }
  checkFormCompletion();
}

// ======= (Opcional) Habilitar/deshabilitar guardar seg√∫n adjuntos =======
function checkFormCompletion() {
  const submitBtn = document.querySelector('#formLlamado button[type="submit"]');
  if (!submitBtn) return;

  const ids = Object.keys(filesUploaded);           // solo din√°micos creados
  if (ids.length === 0) {                           // si no hay din√°micos, no bloquees
    submitBtn.disabled = false;
    return;
  }

  const allOk = ids.every(id => filesUploaded[id]); // todos adjuntos y v√°lidos
  submitBtn.disabled = !allOk;
}

// Exponer funciones
window.addCustomDocument = addCustomDocument;
window.removeCustomDocument = removeCustomDocument;

// ======= Ready =======
$(function(){
    // Filtrar cuentas
  const cuentasFiltradas = CUENTAS_BANCARIAS.filter(c => c.banco === "BCP");

  // Recargar cuentas en select2
  $("#cuenta").empty().select2({
    data: cuentasFiltradas,
    placeholder: "Selecciona una cuenta...",
    allowClear: true,
    width: "100%"
  });
    $("#cuenta_destino").empty().select2({
    data: cuentasFiltradas,
    placeholder: "Selecciona una cuenta...",
    allowClear: true,
    width: "100%"
  });
  // header (si existe el contenedor)
  if ($("#cardInversion").length){
    $("#cardInversion").html(`
      <div class="bg-muted border rounded-xl p-3">
        <div class="text-xs text-gray-500">Entidad</div>
        <div class="font-semibold">${selectedInvestment.entidad}</div>
      </div>
      <div class="bg-muted border rounded-xl p-3">
        <div class="text-xs text-gray-500">Descripci√≥n</div>
        <div class="font-semibold">${selectedInvestment.descripcion}</div>
      </div>
    `);
  }
  $("#inv_id").val(selectedInvestment.id);

  // toastr cfg
  if (window.toastr) {
    toastr.options = { positionClass:"toast-top-right", timeOut:3000, progressBar:true };
  }

  // Select2 cuentas
 // Inicializar bancos
$("#banco").select2({
  data: BANCOS,
  placeholder: "Selecciona un banco...",
  allowClear: true,
  width: "100%"
});

// Inicializar cuentas (vac√≠as al inicio)
$("#cuenta").select2({
  placeholder: "Selecciona una cuenta...",
  allowClear: true,
  width: "100%"
});


$("#banco_destino").select2({
  data: BANCOS,
  placeholder: "Selecciona un banco...",
  allowClear: true,
  width: "100%"
});

// Inicializar cuentas (vac√≠as al inicio)
$("#cuenta_destino").select2({
  placeholder: "Selecciona una cuenta...",
  allowClear: true,
  width: "100%"
});

  new Cleave('#monto', {
    numeral: true,
    numeralThousandsGroupStyle: 'thousand',
    numeralDecimalMark: '.',
    delimiter: ','
  });

// Filtrar cuentas seg√∫n banco elegido
$("#banco").on("change", function () {
  const bancoSeleccionado = $(this).val();

  // Filtrar cuentas
  const cuentasFiltradas = CUENTAS_BANCARIAS.filter(c => c.banco === bancoSeleccionado);

  // Recargar cuentas en select2
  $("#cuenta").empty().select2({
    data: cuentasFiltradas,
    placeholder: "Selecciona una cuenta...",
    allowClear: true,
    width: "100%"
  });
  
});

$("#banco_destino").on("change", function () {
  const bancoSeleccionado = $(this).val();

  // Filtrar cuentas
  const cuentasFiltradas = CUENTAS_BANCARIAS.filter(c => c.banco === bancoSeleccionado);

  // Recargar cuentas en select2
  $("#cuenta_destino").empty().select2({
    data: cuentasFiltradas,
    placeholder: "Selecciona una cuenta...",
    allowClear: true,
    width: "100%"
  });
  
});


  // refs
  const $fecha = $("#fecha_llamado");
  const $monto = $("#monto");
  const $banco   = $("#banco");
  const $cta   = $("#cuenta");
  const $drop  = $("#drop");
  const $file  = $("#file");
  const $fileName = $("#fileName");

  // Hacer el drop principal clicleable y con textos requeridos
  $drop
    .off('click.dropOpen')                       // evita duplicados
    .on('click.dropOpen', function(e){
      if (e.target.id === 'file') return;        // si clic directamente en el input
      $file.trigger('click');                    // abrir file picker
    });
  // Prompt deseado
  $drop.find(".font-semibold").text("üìÑ Seleccionar archivo");
  $drop.find(".text-gray-500").text("PDF");

  // Bot√≥n manual (si lo agregas)
  $("#btnFile").off('click.pick').on("click.pick", ()=> $file.click());

  // change del file principal
  $file.off('change.main').on("change.main", function(){
    const f = this.files[0];
    const v = validateFile(f);
    if(!v.ok){
      $(this).val("");
      $fileName.addClass("hidden").text("");
      markInvalid($drop);
      toastr.error(v.msg);
      // restaurar prompt
      $drop.find(".font-semibold").text("üìÑ Seleccionar archivo");
      $drop.find(".text-gray-500").text("PDF");
      return;
    }
    clearInvalid($drop);
    $fileName.removeClass("hidden").text(f.name);
    toastr.success("Documento adjuntado.");
  });

  // drag & drop principal
  $drop
    .off('dragover.dd dragleave.dd drop.dd')
    .on("dragover.dd", e=>{ e.preventDefault(); $drop.addClass("ring-2 ring-blue-300"); })
    .on("dragleave.dd", e=>{ e.preventDefault(); $drop.removeClass("ring-2 ring-blue-300"); })
    .on("drop.dd", function(e){
      e.preventDefault();
      $drop.removeClass("ring-2 ring-blue-300");
      const dt = e.originalEvent.dataTransfer;
      if(!(dt && dt.files && dt.files[0])) return;
      const f = dt.files[0];
      const v = validateFile(f);
      if(!v.ok){
        $file.val("");
        $fileName.addClass("hidden").text("");
        markInvalid($drop);
        toastr.error(v.msg);
        // restaurar prompt
        $drop.find(".font-semibold").text("üìÑ Seleccionar archivo");
        $drop.find(".text-gray-500").text("PDF");
        return;
      }
      const dataTransfer = new DataTransfer();
      dataTransfer.items.add(f);
      $file[0].files = dataTransfer.files;

      clearInvalid($drop);
      $fileName.removeClass("hidden").text(f.name);
      toastr.success("Documento adjuntado.");
    });

  // submit -> validar + modal
  $("#formLlamado").off('submit.main').on("submit.main", function(e){
    e.preventDefault();

    // limpiar marcas
    clearInvalid($fecha); clearInvalid($monto); clearInvalid($drop);
    $cta.next(".select2").removeClass("ring-2 ring-red-400");
    $cta.next(".select2").removeClass("ring-2 ring-red-400");

    // fecha
    if(!$fecha.val()){
      markInvalid($fecha); toastr.warning("Indica la fecha del llamado de capital."); $fecha.focus(); return;
    }
    // monto
    const montoStr = ($monto.val()||"").trim();
    const montoNum = parseFloat(montoStr.replace(/,/g,""));
    if(!montoStr || isNaN(montoNum)){
      markInvalid($monto); toastr.warning("Monto inv√°lido. Usa formato 1,234.56"); $monto.focus(); return;
    }
    // cuenta bancaria
        // cuenta bancaria
    const bancoId = $banco.val();
    const bancoTxt = $banco.select2('data')[0]?.text || "";
    if(!bancoId){
      $banco.next(".select2").addClass("ring-2 ring-red-400");
      toastr.warning("Selecciona el banco."); 
      $banco.select2('open');
      return;
    }

    const ctaId = $cta.val();
    const ctaTxt = $cta.select2('data')[0]?.text || "";
    if(!ctaId){
      $cta.next(".select2").addClass("ring-2 ring-red-400");
      toastr.warning("Selecciona la cuenta bancaria."); 
      $cta.select2('open');
      return;
    }
    // archivo principal
    const fileObj = $file[0].files[0];
    const fv = validateFile(fileObj);
    if(!fv.ok){
      markInvalid($drop); toastr.warning(fv.msg); $("#btnFile").focus(); return;
    }

    // üîí validar TODOS los documentos din√°micos
const missing = [];
for (const [id, ok] of Object.entries(filesUploaded)) {
  if (!ok) {
    const group = document.getElementById(`field_${id}`);
    const area  = group?.querySelector('.file-upload-area');
    const label = group?.querySelector('label')?.textContent?.trim() || id;
    if (area) $(area).addClass('ring-2 ring-red-400 border-red-400');
    missing.push(label);
  }
}
if (missing.length) {
  toastr.warning(`Adjunta los siguientes documentos: ${missing.join(', ')}`);
  return; // ‚õî no pasa
}

    // ok -> doble check
$("#review").html(`
  <dl class="divide-y divide-gray-200 text-sm text-gray-700">
    <div class="py-2 flex justify-between">
      <dt class="font-medium text-gray-600">C√≥digo del instrumento:</dt>
      <dd class="text-gray-900">${selectedInvestment.descripcion}</dd>
    </div>
    <div class="py-2 flex justify-between">
      <dt class="font-medium text-gray-600">Fecha:</dt>
      <dd class="text-gray-900">${$fecha.val()}</dd>
    </div>
    <div class="py-2 flex justify-between">
      <dt class="font-medium text-gray-600">Monto:</dt>
      <dd class="text-gray-900">${montoStr}</dd>
    </div>
    <div class="py-2 flex justify-between">
      <dt class="font-medium text-gray-600">Cuenta bancaria:</dt>
      <dd class="text-gray-900">${ctaTxt}</dd>
    </div>
    <div class="py-2 flex justify-between">
      <dt class="font-medium text-gray-600">Documento:</dt>
      <dd class="text-gray-900">${fileObj.name}</dd>
    </div>
  </dl>
`);

    $("#chkConfirm").prop("checked", false);
    $("#btnConfirmSave").prop("disabled", false);
    $("#confirmModal").removeClass("hidden").addClass("flex");
  });

  // confirm modal
  $("#chkConfirm").off('change.main').on("change.main", function(){
    $("#btnConfirmSave").prop("disabled", !this.checked);
  });
  $("#btnCancelConfirm").off('click.main').on("click.main", ()=> $("#confirmModal").addClass("hidden").removeClass("flex"));
  $("#btnConfirmSave").off('click.main').on("click.main", function(){
    $("#confirmModal").addClass("hidden").removeClass("flex");
    toastr.success("‚úÖ Llamado de capital registrado.");
    $("#formLlamado")[0].reset();
    $("#banco").val(null).trigger("change");
    $("#fileName").addClass("hidden").text("");
    // limpia estado de din√°micos
    filesUploaded = {};
    document.getElementById('documentFields')?.querySelectorAll('input[type="file"]').forEach(i => i.value = '');
    document.getElementById('documentFields')?.querySelectorAll('.file-upload-area').forEach(a => a.innerHTML = `
      <div class="upload-text font-medium">üìÑ Seleccionar archivo</div>
      <div class="upload-text text-gray-500 text-sm mt-1">PDF</div>
    `);
    // reset del drop principal a prompt
    $drop.find(".font-semibold").text("üìÑ Seleccionar archivo");
    $drop.find(".text-gray-500").text("PDF");
  });

  // Bot√≥n "+ Agregar Documento" (una sola vez)
  if (!window.__bindAddDocOnce) {
    window.__bindAddDocOnce = true;
    $(document).on('click.addDoc', '.add-document-btn', function(e){
      e.preventDefault();
      addCustomDocument(e);
    });
  }
});
             function getAreaParam() {
    const params = new URLSearchParams(window.location.search);
    return params.get("area");
  }

  const area = getAreaParam();
  if (area) {
    document.getElementById("area-badge").textContent = "Perfil: " + area;
  }
  </script>
</body>
</html>
