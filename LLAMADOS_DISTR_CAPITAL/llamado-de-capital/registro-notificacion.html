<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Notificación de Llamado de Capital</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-tailwind@5/tailwind.min.css" rel="stylesheet"/>
  <!-- Select2 -->
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.full.min.js"></script>
  <style>
    /* Select2 alineado a Tailwind con padding 2.5 (~10px) y borde gris */
    .select2-container--default .select2-selection--single{
      height: 44px; border:1px solid rgb(203 213 225); border-radius: .75rem;
    }
    .select2-container--default .select2-selection--single .select2-selection__rendered{
      line-height: 44px; padding-left: .75rem;
    }
    .select2-container--default .select2-selection--single .select2-selection__arrow{
      height: 44px; right: .5rem;
    }
    /* Mejoras visuales en foco */
    .select2-container--default.select2-container--focus .select2-selection--single{
      border-color: rgb(99 102 241) !important; /* indigo-500 */
      box-shadow: 0 0 0 1px rgb(99 102 241 / .2);
    }
  </style>
</head>
<body class="bg-gray-50 text-slate-800">
  <div class="max-w-screen-2xl mx-auto p-6">
    <!-- Volver atrás -->
    <a href="../" 
   class="mb-4 inline-flex items-center gap-2 text-sm text-slate-600 hover:text-slate-800">
  <span class="text-xl">←</span> Volver atrás
</a>


    <!-- Header -->
    <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between mb-6">
      <div>
        <h1 class="text-2xl font-semibold">Notificación de Llamado de Capital</h1>
        <p class="text-slate-500 text-sm">Registra documento de la notificación, monto, fecha, banco y gestor.</p>
      </div>
      <button id="btnNew" class="rounded-xl bg-indigo-600 text-white px-4 py-2 hover:bg-indigo-700">
        Nuevo llamado a capital
      </button>
    </div>

    <!-- Lista -->
    <div class="bg-white border border-slate-200 rounded-2xl shadow-sm">
      <div class="px-4 py-3 border-b border-slate-200 flex items-center justify-between">
        <span class="font-medium">Registros</span>
        <input id="search" type="text" placeholder="Buscar…" class="rounded-lg border border-slate-300 text-sm px-3 py-1.5"/>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead class="bg-slate-50">
            <tr class="text-left">
              <th class="py-3 px-4">ID</th>
              <th class="py-3 px-4">Documento</th>
              <th class="py-3 px-4">Monto</th>
              <th class="py-3 px-4">Fecha</th>
              <th class="py-3 px-4">Banco</th>
              <th class="py-3 px-4">Acciones</th>
            </tr>
          </thead>
          <tbody id="rows" class="divide-y divide-slate-100"></tbody>
        </table>
      </div>
      <div id="empty" class="p-6 text-center text-slate-500 text-sm hidden">Aún no hay registros.</div>
    </div>
  </div>

  <!-- Backdrop -->
  <div id="backdrop" class="fixed inset-0 bg-black/40 z-40 hidden"></div>

  <!-- Modal -->
  <div id="modal" class="fixed inset-0 z-50 hidden overflow-y-auto">
    <div class="min-h-full flex items-center justify-center p-4">
      <div class="w-full max-w-xl bg-white rounded-2xl shadow-xl border border-slate-200">
        <div class="flex items-center justify-between px-6 py-4 border-b border-slate-200">
          <h2 id="modalTitle" class="text-lg font-semibold">Nuevo registro</h2>
          <button id="btnClose" class="p-2 rounded-lg hover:bg-slate-100" aria-label="Cerrar">✕</button>
        </div>

        <form id="form" class="px-6 py-5 space-y-5">
          <!-- Documento (mejorado) -->
          <div>
            <label class="block text-sm font-medium mb-1">Documento de la notificación <span class="text-rose-600">*</span></label>
            <div class="rounded-xl border-2 border-dashed border-slate-300 p-4 flex items-center gap-3 bg-slate-50">
              <input id="file" type="file" class="hidden" accept=".pdf,.jpg,.jpeg,.png">
              <button type="button" id="btnChooseFile" class="rounded-lg border border-slate-300 px-3 py-2.5 hover:bg-white">
                Seleccionar archivo
              </button>
              <span id="fileName" class="text-sm text-slate-500 truncate">Ningún archivo seleccionado</span>
            </div>
            <p class="text-xs text-slate-500 mt-1">PDF/JPG/PNG. Máx 5MB.</p>
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-1">Monto <span class="text-rose-600">*</span></label>
              <input id="monto" type="number" step="0.01" min="0"
                     class="w-full rounded-xl border border-slate-300 px-3 p-2.5"
                     placeholder="0.00" required>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Fecha de operación <span class="text-rose-600">*</span></label>
              <input id="fecha" type="date"
                     class="w-full rounded-xl border border-slate-300 px-3 p-2.5"
                     required>
            </div>
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-1">Banco (origen del pago) <span class="text-rose-600">*</span></label>
              <select id="banco" class="w-full"></select>
            </div>
           <!-- <div>
              <label class="block text-sm font-medium mb-1">Gestor de inversión <span class="text-rose-600">*</span></label>
              <select id="gestor" class="w-full"></select>
            </div>-->
          </div>

          <input type="hidden" id="recordId">

          <div class="flex items-center justify-between pt-4 border-t border-slate-200">
            <button id="btnDelete" type="button" class="hidden rounded-xl bg-rose-600 text-white px-3 py-2 hover:bg-rose-700">
              Eliminar
            </button>
            <div class="ml-auto flex items-center gap-3">
              <button id="btnCancel" type="button" class="rounded-xl px-3 py-2 border border-slate-300 hover:bg-slate-50">Cancelar</button>
              <button id="btnSave" type="submit" class="rounded-xl bg-indigo-600 text-white px-4 py-2 hover:bg-indigo-700">Guardar</button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>

<script>
/* =========================
   PROTOTIPO SIMPLE (sin persistencia)
   Dependencias: Tailwind, jQuery, SweetAlert2, Select2
   ========================= */

// Listas iniciales (puedes editar libremente; también se pueden escribir nuevos valores)
const BANKS  = ['BCP','BBVA','Scotiabank','Interbank','Banco de la Nación','BanBif','GNB','Citibank','HSBC'];
const GESTORES = ['ABC Asset Management','XYZ Investments','Gestor 123','Andes Capital'];

let DATA = [];          // en memoria
let editingIndex = -1;  // índice en edición

const money = n => (Number(n||0)).toLocaleString('es-PE', {style:'currency', currency:'PEN'});

const openModal = (isEdit=false, rec=null) => {
  $('#modalTitle').text(isEdit ? `Editar registro #${rec.id}` : 'Nuevo registro');
  $('#btnDelete').toggle(isEdit);
  $('#recordId').val(isEdit ? rec.id : '');
  $('#monto').val(isEdit ? rec.monto : '');
  $('#fecha').val(isEdit ? rec.fecha : '');

  // Banco
  if (isEdit && rec?.banco) ensureOption('#banco', rec.banco);
  $('#banco').val(isEdit ? rec.banco : null).trigger('change');

  // Gestor
  if (isEdit && rec?.gestor) ensureOption('#gestor', rec.gestor);
  $('#gestor').val(isEdit ? rec.gestor : null).trigger('change');

  // seguridad: no precargar archivo
  $('#file').val('');
  $('#fileName').text('Ningún archivo seleccionado');

  $('#backdrop, #modal').removeClass('hidden');
};
const closeModal = () => { $('#backdrop, #modal').addClass('hidden'); };

function ensureOption(selectId, value){
  const $sel = $(selectId);
  if (!$sel.find(`option[value="${value}"]`).length) {
    const opt = new Option(value, value, true, true);
    $sel.append(opt);
  }
}

function render(filter='') {
  const $rows = $('#rows').empty();
  const filtered = DATA.filter(r => {
    if (!filter) return true;
    const t = (r.id + ' ' + (r.fileName||'') + ' ' + r.monto + ' ' + r.fecha + ' ' + r.banco + ' ' + r.gestor).toLowerCase();
    return t.includes(filter.toLowerCase());
  });

  if (filtered.length === 0) $('#empty').removeClass('hidden'); else $('#empty').addClass('hidden');

  filtered.forEach((r, idx) => {
    const $tr = $(`
      <tr class="hover:bg-slate-50">
        <td class="py-3 px-4">${r.id}</td>
        <td class="py-3 px-4">
          ${r.fileName ? `<button class="text-indigo-600 hover:underline btn-view" data-i="${idx}">${r.fileName}</button>` : '<span class="text-slate-400">(sin archivo)</span>'}
        </td>
        <td class="py-3 px-4 text-right">${money(r.monto)}</td>
        <td class="py-3 px-4">${r.fecha || ''}</td>
        <td class="py-3 px-4">${r.banco || ''}</td>
        <td class="py-3 px-4">${r.gestor || ''}</td>
        <td class="py-3 px-4">
          <div class="flex gap-2">
            <button class="px-2 py-1 rounded-lg border border-slate-300 text-slate-700 hover:bg-slate-50 btn-edit" data-i="${idx}">Editar</button>
          </div>
        </td>
      </tr>
    `);
    $rows.append($tr);
  });
}

function nextId() {
  return (DATA.length ? Math.max(...DATA.map(r=>r.id)) : 0) + 1;
}

$(function () {
  // Select2 para Banco y Gestor (tags=true para permitir valores nuevos)
  $('#banco').select2({
    placeholder: 'Selecciona o escribe un banco',
    tags: true,
    width: '100%',
    data: BANKS.map(x => ({id:x, text:x})),
    dropdownParent: $('#modal')
  });
  $('#gestor').select2({
    placeholder: 'Selecciona o escribe un gestor',
    tags: true,
    width: '100%',
    data: GESTORES.map(x => ({id:x, text:x})),
    dropdownParent: $('#modal')
  });

  // File input bonito
  $('#btnChooseFile').on('click', () => $('#file').click());
  $('#file').on('change', function(){
    const f = this.files[0];
    $('#fileName').text(f ? f.name : 'Ningún archivo seleccionado');
  });

  // Nuevo
  $('#btnNew').on('click', () => { editingIndex = -1; openModal(false, null); });

  // Cerrar / cancelar
  $('#btnClose, #btnCancel').on('click', closeModal);

  // Buscar
  $('#search').on('input', function(){ render(this.value); });

  // Ver documento
  $('#rows').on('click', '.btn-view', function(){
    const i = Number($(this).data('i'));
    const r = DATA[i];
    if (!r?.file) return;
    const url = URL.createObjectURL(r.file);
    window.open(url, '_blank');
    setTimeout(()=>URL.revokeObjectURL(url), 10000);
  });

  // Editar
  $('#rows').on('click', '.btn-edit', function(){
    editingIndex = Number($(this).data('i'));
    const rec = DATA[editingIndex];
    openModal(true, rec);
  });

  // Eliminar con doble confirmación
  $('#btnDelete').on('click', async function(){
    if (editingIndex < 0) return;
    const rec = DATA[editingIndex];

    const a = await Swal.fire({
      title: '¿Eliminar registro?',
      text: `Eliminarás el registro #${rec.id}.`,
      icon: 'warning', showCancelButton: true,
      confirmButtonText: 'Sí, continuar', cancelButtonText: 'Cancelar'
    });
    if (!a.isConfirmed) return;

    const b = await Swal.fire({
      title: 'Confirmación final',
      text: 'Esta acción es irreversible.',
      icon: 'warning', showCancelButton: true,
      confirmButtonText: 'Eliminar', confirmButtonColor: '#dc2626',
      cancelButtonText: 'Cancelar'
    });
    if (!b.isConfirmed) return;

    DATA.splice(editingIndex, 1);
    editingIndex = -1;
    render($('#search').val()||'');
    closeModal();
    Swal.fire('Eliminado', 'Se eliminó correctamente.', 'success');
  });

  // Guardar (crear/editar) con doble confirmación + validaciones
  $('#form').on('submit', async function(e){
    e.preventDefault();

    const monto  = $('#monto').val();
    const fecha  = $('#fecha').val();
    const banco  = $('#banco').val();
    const gestor = $('#gestor').val();
    const file   = document.getElementById('file').files[0];

    // Validaciones obligatorias
    if (editingIndex < 0 && !file) return Swal.fire('Documento requerido', 'Adjunta el documento de la notificación.', 'error');
    if (file && file.size > 5 * 1024 * 1024) return Swal.fire('Archivo muy grande', 'Máximo 5MB.', 'error');
    if (!monto || Number(monto) <= 0) return Swal.fire('Monto inválido', 'Ingresa un monto mayor a 0.', 'error');
    if (!fecha) return Swal.fire('Fecha requerida', 'Selecciona la fecha de operación.', 'error');
    if (!banco) return Swal.fire('Banco requerido', 'Selecciona o escribe el banco.', 'error');
    //if (!gestor) return Swal.fire('Gestor requerido', 'Selecciona o escribe el gestor.', 'error');

    const first = await Swal.fire({
      title: editingIndex < 0 ? '¿Crear registro?' : '¿Guardar cambios?',
      icon: 'question', showCancelButton: true,
      confirmButtonText: 'Sí, continuar', cancelButtonText: 'Cancelar'
    });
    if (!first.isConfirmed) return;

    const second = await Swal.fire({
      title: 'Confirmación final',
      text: 'Confirma que la información es correcta.',
      icon: 'info', showCancelButton: true,
      confirmButtonText: editingIndex < 0 ? 'Crear' : 'Guardar',
      cancelButtonText: 'Volver'
    });
    if (!second.isConfirmed) return;

    if (editingIndex < 0) {
      DATA.unshift({
        id: (DATA.length ? Math.max(...DATA.map(r=>r.id)) : 0) + 1,
        monto: Number(monto),
        fecha,
        banco,
        gestor,
        file: file || null,
        fileName: file ? file.name : null
      });
    } else {
      const r = DATA[editingIndex];
      r.monto = Number(monto);
      r.fecha = fecha;
      r.banco = banco;
      r.gestor = gestor;
      if (file) { r.file = file; r.fileName = file.name; }
    }

    render($('#search').val()||'');
    closeModal();
    Swal.fire('Listo', editingIndex < 0 ? 'Registro creado.' : 'Cambios guardados.', 'success');
    editingIndex = -1;
  });

  // Primera render
  render();
});
</script>
</body>
</html>
